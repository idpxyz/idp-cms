# 频道权限管理使用指南

## 📋 功能说明

新增的**频道权限管理系统**允许您为不同的用户组设置细粒度的频道访问权限，实现：

- ✅ 限制用户组只能查看指定的频道
- ✅ 控制用户组是否可以编辑频道设置
- ✅ 控制用户组是否可以在特定频道下发布文章
- ✅ 超级管理员始终拥有所有权限

---

## 🚀 快速开始

### 1. 应用数据库迁移

首先需要创建并应用数据库迁移：

```bash
# 在本地环境
cd /opt/idp-cms
source .venv/bin/activate
python manage.py makemigrations core
python manage.py migrate

# 在远程服务器（Docker 环境）
ssh root@8.133.22.7 "cd /opt/idp-cms && docker exec ha-authoring python manage.py makemigrations core"
ssh root@8.133.22.7 "cd /opt/idp-cms && docker exec ha-authoring python manage.py migrate"
```

### 2. 重启后端服务

```bash
# 远程服务器重启
./deploy-node1-remote.sh --restart
```

---

## 📖 使用方法

### 步骤 1：创建用户组

1. 登录 Wagtail 后台：`http://8.133.22.7:8000/admin/`
2. 进入 **设置** → **用户组**
3. 点击 **添加用户组**，创建一个新的用户组（例如：`新闻编辑`）

### 步骤 2：配置频道权限

1. 在后台左侧菜单找到 **🔐 频道权限管理**（仅超级管理员可见）
2. 点击 **添加频道权限**
3. 配置权限：
   - **用户组**：选择要授予权限的用户组（如 `新闻编辑`）
   - **可访问的频道**：勾选该用户组可以访问的频道
     - 如果不勾选任何频道 = 可以访问**所有频道**
     - 勾选特定频道 = 只能访问这些频道
   - **权限类型**：
     - ✅ **可查看**：可以在后台看到这些频道
     - ✅ **可编辑**：可以修改频道的设置
     - ✅ **可发布文章**：可以在该频道下发布文章
4. 点击 **保存**

### 步骤 3：将用户添加到用户组

1. 进入 **设置** → **用户**
2. 编辑用户，在 **角色** 或 **用户组** 部分勾选对应的用户组
3. 保存

---

## 💡 示例场景

### 场景 1：限制实习编辑只能访问"娱乐"和"体育"频道

1. 创建用户组：`实习编辑`
2. 创建频道权限：
   - 用户组：`实习编辑`
   - 可访问的频道：勾选 `娱乐`、`体育`
   - ✅ 可查看
   - ✅ 可发布文章
   - ❌ 可编辑（不勾选，不允许修改频道设置）

结果：该用户组的用户登录后台后，只能看到"娱乐"和"体育"频道，并且可以发布文章，但不能修改频道设置。

### 场景 2：频道管理员可以访问所有频道并编辑

1. 创建用户组：`频道管理员`
2. 创建频道权限：
   - 用户组：`频道管理员`
   - 可访问的频道：**不勾选任何频道**（表示所有频道）
   - ✅ 可查看
   - ✅ 可编辑
   - ✅ 可发布文章

结果：该用户组的用户可以访问所有频道，并拥有完整的编辑和发布权限。

### 场景 3：审核员只能查看，不能编辑或发布

1. 创建用户组：`内容审核员`
2. 创建频道权限：
   - 用户组：`内容审核员`
   - 可访问的频道：**不勾选任何频道**（所有频道）
   - ✅ 可查看
   - ❌ 可编辑
   - ❌ 可发布文章

结果：该用户组的用户可以查看所有频道的内容，但不能修改或发布。

---

## 🔍 权限逻辑说明

### 默认行为

- **超级管理员**：始终拥有所有权限，不受频道权限限制
- **未配置权限的用户组**：默认可以访问所有频道（保持向后兼容）
- **配置了权限的用户组**：严格按照配置的权限执行

### 多用户组权限叠加

如果一个用户属于多个用户组：
- 权限会**叠加**（取并集）
- 例如：用户同时属于 `新闻编辑`（可访问"新闻"）和 `体育编辑`（可访问"体育"），则该用户可以访问**两个频道**

### 频道列表过滤

在后台的频道管理界面，用户只能看到自己有权限访问的频道：
- 超级管理员：看到所有频道
- 有权限的用户：只看到授权的频道
- 无权限的用户：看不到任何频道（如果配置了限制）

---

## 🛠️ 高级用法

### 在代码中检查权限

如果需要在自定义视图或 API 中检查频道权限：

```python
from apps.core.models import ChannelGroupPermission

# 获取用户可访问的频道
accessible_channels = ChannelGroupPermission.get_accessible_channels(request.user)
if accessible_channels is None:
    # 用户可以访问所有频道
    channels = Channel.objects.all()
else:
    # 用户只能访问特定频道
    channels = accessible_channels

# 检查用户是否可以编辑特定频道
can_edit = ChannelGroupPermission.user_can_edit_channel(request.user, channel)

# 检查用户是否可以在特定频道发布文章
can_publish = ChannelGroupPermission.user_can_publish_to_channel(request.user, channel)
```

### 扩展权限到文章发布

如果需要在文章发布时检查频道权限，可以在 `apps/news/models/article.py` 中添加：

```python
from apps.core.models import ChannelGroupPermission

class Article(Page):
    # ... 现有代码 ...
    
    def user_can_publish(self, user):
        """检查用户是否可以发布该文章"""
        if user.is_superuser:
            return True
        
        # 检查文章所属的频道权限
        if hasattr(self, 'channel') and self.channel:
            return ChannelGroupPermission.user_can_publish_to_channel(user, self.channel)
        
        return super().user_can_publish(user)
```

---

## 🔐 安全建议

1. **最小权限原则**：只授予用户组完成工作所需的最小权限
2. **定期审查**：定期检查用户组和权限配置，移除不再需要的权限
3. **敏感频道**：对于敏感频道（如"独家新闻"、"内部通告"），务必设置严格的权限控制
4. **超级管理员**：谨慎授予超级管理员权限，超级管理员不受频道权限限制

---

## 📝 数据库表结构

新增的权限表：`core_channel_group_permission`

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | AutoField | 主键 |
| `group_id` | ForeignKey | 用户组 |
| `channels` | ManyToMany | 可访问的频道列表 |
| `can_view` | Boolean | 是否可查看 |
| `can_edit` | Boolean | 是否可编辑 |
| `can_publish` | Boolean | 是否可发布文章 |
| `created_at` | DateTime | 创建时间 |
| `updated_at` | DateTime | 更新时间 |

---

## ❓ 常见问题

### Q1: 用户看不到任何频道怎么办？

**A:** 检查以下几点：
1. 确认用户是否属于某个用户组
2. 确认该用户组是否配置了频道权限
3. 如果配置了权限但没有勾选任何频道，可能导致无法访问任何频道
4. 临时解决：将用户设为超级管理员，或删除该用户组的频道权限配置

### Q2: 超级管理员看不到频道权限管理菜单？

**A:** 
- 确保已经应用了数据库迁移
- 确保已经重启了后端服务
- 清除浏览器缓存后重新登录

### Q3: 配置权限后没有生效？

**A:**
- 确认用户确实属于该用户组
- 用户需要**重新登录**后权限才会生效
- 检查是否有其他用户组的权限覆盖了当前配置

### Q4: 如何完全关闭频道权限系统？

**A:** 
如果暂时不需要使用频道权限系统，删除所有的频道权限配置即可：
1. 进入后台 **🔐 频道权限管理**
2. 删除所有权限配置
3. 系统会恢复到默认行为（所有用户可访问所有频道）

---

## 🎯 总结

频道权限管理系统提供了灵活的权限控制：

- ✅ **简单易用**：通过后台图形界面配置，无需修改代码
- ✅ **细粒度控制**：可以精确控制查看、编辑、发布三种权限
- ✅ **向后兼容**：未配置权限时保持原有行为
- ✅ **安全可靠**：超级管理员始终拥有完整权限

如有任何问题，请参考本文档或联系系统管理员。

