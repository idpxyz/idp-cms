# ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å°±ç»ªæŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-16  
**çŠ¶æ€**: âœ… å·²å®Œæˆæ‰€æœ‰é…ç½®ç»Ÿä¸€ï¼Œå¯ä»¥éƒ¨ç½²

---

## âœ… ç‰ˆæœ¬ä¸€è‡´æ€§æ£€æŸ¥

| æœåŠ¡ | ç‰ˆæœ¬ | å¼€å‘/ç”Ÿäº§ |
|------|------|-----------|
| PostgreSQL | `17.6` | âœ… å®Œå…¨ä¸€è‡´ |
| Redis | `7.4.5` | âœ… å®Œå…¨ä¸€è‡´ |
| ClickHouse | `24.3.18` | âœ… å®Œå…¨ä¸€è‡´ |
| OpenSearch | `3.2.0` | âœ… å®Œå…¨ä¸€è‡´ |
| MinIO | `2025-07-23` | âœ… å®Œå…¨ä¸€è‡´ |

---

## ğŸ”’ å¯†ç é…ç½® (.env.node1)

```bash
# PostgreSQL
POSTGRES_PASSWORD=news

# Redis  
REDIS_PASSWORD=devredis123
REDIS_URL=redis://:devredis123@172.28.0.20:6379/0

# ClickHouse
CLICKHOUSE_PASSWORD=thends

# OpenSearch (å®‰å…¨æ’ä»¶ç¦ç”¨ï¼Œæ— éœ€å¯†ç )
OPENSEARCH_URL=http://172.28.0.40:9200

# MinIO
MINIO_SECRET_KEY=minioadmin
```

---

## ğŸ›¡ï¸ å®‰å…¨é…ç½®

### OpenSearch
- **å®‰å…¨æ’ä»¶**: âœ… å·²ç¦ç”¨ (`plugins.security.disabled=true`)
- **åè®®**: HTTP (æ— éœ€ HTTPS)
- **è®¤è¯**: æ— éœ€å¯†ç 
- **è®¿é—®**: ä»…å†…ç½‘ `172.28.0.40`

### Redis
- **å¯†ç ä¿æŠ¤**: âœ… `devredis123`
- **è®¿é—®**: ä»…å†…ç½‘ `172.28.0.20`

### æ‰€æœ‰æœåŠ¡
- **ç½‘ç»œéš”ç¦»**: Docker å†…ç½‘ `172.28.0.0/16`
- **ä¸æš´éœ²å…¬ç½‘**: ä»…é€šè¿‡ Nginx åå‘ä»£ç†
- **é˜²ç«å¢™**: æœåŠ¡å™¨é˜²ç«å¢™ä¿æŠ¤

---

## ğŸ“¦ è‡ªåŠ¨åŒ–é…ç½®

### MinIO è‡ªåŠ¨åˆå§‹åŒ–
âœ… å·²æ·»åŠ  `minio-setup` æœåŠ¡ï¼Œè‡ªåŠ¨åˆ›å»ºæ¡¶ï¼š
- `idp-media-prod-public` (public)
- `idp-media-prod-private` (private)

---

## ğŸ”§ å…³é”®é…ç½®æ–‡ä»¶

1. **åŸºç¡€è®¾æ–½**: `/opt/idp-cms/infra/production/docker-compose-ha-infra.yml`
   - PostgreSQL, Redis, ClickHouse, OpenSearch, MinIO
   
2. **åº”ç”¨æœåŠ¡**: `/opt/idp-cms/infra/production/docker-compose-ha-node1.yml`
   - Django, Next.js, Celery

3. **ç¯å¢ƒå˜é‡**: `/opt/idp-cms/.env.node1`
   - æ‰€æœ‰å¯†ç å’Œé…ç½®

4. **éƒ¨ç½²è„šæœ¬**: `/opt/idp-cms/deploy-node1-remote.sh`
   - è‡ªåŠ¨åŒæ­¥ä»£ç  + è¿œç¨‹éƒ¨ç½²

---

## âœ… é…ç½®æ£€æŸ¥æ¸…å•

- [x] æ‰€æœ‰æœåŠ¡ç‰ˆæœ¬å·²é”å®š
- [x] å¼€å‘å’Œç”Ÿäº§ç‰ˆæœ¬å®Œå…¨ä¸€è‡´
- [x] å¯†ç é…ç½®å·²ç»Ÿä¸€
- [x] OpenSearch å®‰å…¨æ’ä»¶å·²ç¦ç”¨
- [x] Redis å¯†ç å·²é…ç½®
- [x] MinIO è‡ªåŠ¨é…ç½®å·²æ·»åŠ 
- [x] ç¯å¢ƒå˜é‡æ–‡ä»¶å·²æ›´æ–°
- [x] ç½‘ç»œé…ç½®æ­£ç¡® (172.28.0.0/16)
- [x] å¥åº·æ£€æŸ¥é…ç½®æ­£ç¡®
- [x] æ•°æ®å·é…ç½®å®Œæ•´

---

## ğŸš€ éƒ¨ç½²å‘½ä»¤

### å®Œæ•´éƒ¨ç½²ï¼ˆæ¨èï¼‰
```bash
./deploy-node1-remote.sh --rebuild-backend
```

### å¿«é€Ÿéƒ¨ç½²ï¼ˆä¸é‡å»ºé•œåƒï¼‰
```bash
./deploy-node1-remote.sh
```

### å®Œå…¨é‡å»ºï¼ˆæ— ç¼“å­˜ï¼‰
```bash
./deploy-node1-remote.sh --no-cache
```

---

## ğŸ“Š é¢„æœŸç»“æœ

éƒ¨ç½²æˆåŠŸåï¼Œä»¥ä¸‹æœåŠ¡å°†åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œï¼š

| æœåŠ¡ | åœ°å€ | çŠ¶æ€æ£€æŸ¥ |
|------|------|---------|
| Frontend | http://121.40.167.71:3000 | è®¿é—®é¦–é¡µ |
| Backend | http://121.40.167.71:8000 | curl http://121.40.167.71:8000/health/ |
| Admin | http://121.40.167.71:8000/admin/ | ç™»å½•ç®¡ç†åå° |
| PostgreSQL | 172.28.0.10:5432 | Docker å†…éƒ¨ |
| Redis | 172.28.0.20:6379 | Docker å†…éƒ¨ |
| ClickHouse | 172.28.0.30:9000 | Docker å†…éƒ¨ |
| OpenSearch | 172.28.0.40:9200 | Docker å†…éƒ¨ |
| MinIO | 172.28.0.50:9000 | Docker å†…éƒ¨ |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡éƒ¨ç½²æ—¶é—´**: é¢„è®¡ 10-15 åˆ†é’Ÿï¼ˆä¸‹è½½é•œåƒ + æ„å»ºï¼‰
2. **æ•°æ®åº“åˆå§‹åŒ–**: é¦–æ¬¡å¯åŠ¨ä¼šè‡ªåŠ¨è¿è¡Œ migrate
3. **MinIO æ¡¶åˆ›å»º**: minio-setup ä¼šè‡ªåŠ¨åˆ›å»ºæ‰€éœ€æ¡¶
4. **Redis è¿æ¥**: ç¡®ä¿ REDIS_URL åŒ…å«å¯†ç 
5. **OpenSearch**: ä½¿ç”¨ HTTPï¼Œæ— éœ€é…ç½®è®¤è¯

---

## ğŸ¯ ä¸‹ä¸€æ­¥æ“ä½œ

1. **è¿è¡Œéƒ¨ç½²è„šæœ¬**:
   ```bash
   ./deploy-node1-remote.sh --rebuild-backend
   ```

2. **ç›‘æ§éƒ¨ç½²æ—¥å¿—**:
   ```bash
   # åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Š
   docker-compose -f infra/production/docker-compose-ha-infra.yml logs -f
   docker-compose -f infra/production/docker-compose-ha-node1.yml logs -f
   ```

3. **éªŒè¯æœåŠ¡çŠ¶æ€**:
   ```bash
   # æ£€æŸ¥æ‰€æœ‰å®¹å™¨
   docker ps
   
   # æ£€æŸ¥å¥åº·çŠ¶æ€
   docker ps --filter "health=healthy"
   ```

4. **æµ‹è¯•åŠŸèƒ½**:
   - è®¿é—®å‰ç«¯: http://121.40.167.71:3000
   - è®¿é—®åç«¯: http://121.40.167.71:8000
   - æµ‹è¯•æœç´¢åŠŸèƒ½
   - æµ‹è¯•æ–‡ä»¶ä¸Šä¼  (MinIO)
   - æŸ¥çœ‹åˆ†ææ•°æ® (ClickHouse)

---

**å‡†å¤‡å°±ç»ªï¼å¯ä»¥å¼€å§‹éƒ¨ç½²äº†ï¼ğŸ‰**
