# 文章封面图片处理方案

## 问题背景

在新闻网站中，文章封面图片的处理一直是一个挑战：
1. 有的文章有封面图片，有的没有
2. 有的文章正文中有图片，有的没有
3. 有的文章既没有封面也没有正文图片

这会导致首页和列表页显示不一致，影响用户体验。

## 解决方案

我们实施了一个**三级回退机制**来确保所有文章都能优雅地显示：

### 1. 优先级顺序

```
第一优先级：手动设置的封面图片
    ↓ (如果没有)
第二优先级：自动从正文提取第一张图片
    ↓ (如果没有)
第三优先级：基于文章分类的本地默认封面图片
```

### 2. 实现细节

#### 后端改进

**自动提取正文图片（`apps/news/models/article.py`）**

添加了两个新方法：

```python
def extract_first_image_from_body(self):
    """从文章正文中提取第一张图片作为封面"""
    # 支持 Wagtail 富文本编辑器的 embed 标签
    # 支持普通的 img 标签
    
def auto_set_cover_from_body(self):
    """如果文章没有封面图片，自动从正文中提取第一张图片设置为封面"""
    if not self.cover and self.body:
        first_image = self.extract_first_image_from_body()
        if first_image:
            self.cover = first_image
```

在 `save()` 方法中自动调用，无需手动操作。

**编辑器提示**

在 Wagtail 管理界面的封面图片字段上方添加了醒目的提示框：

```
💡 封面图片提示
• 建议为文章上传封面图片，提升首页展示效果
• 如果不上传封面，系统会自动尝试从正文中提取第一张图片
• 如果正文也没有图片，系统会根据文章分类显示默认封面图片
• 推荐尺寸：1200x675 (16:9) 或 800x450
```

#### 前端改进

**本地默认封面图片系统（`sites/lib/utils/placeholderImages.ts`）**

替代了之前依赖外部 `picsum.photos` 服务的方案，改为使用本地 SVG 图片：

- 根据文章的频道、标签、标题智能匹配合适的默认封面
- 13 个分类的默认封面：
  - 政治（🏛️）
  - 经济（💼）
  - 科技（💻）
  - 文化（🎨）
  - 体育（⚽）
  - 健康（🏥）
  - 教育（📚）
  - 环境（🌱）
  - 国际（🌍）
  - 社会（👥）
  - 军事（🛡️）
  - 旅游（✈️）
  - 默认（📰）

**SVG 图片优势**：
- 无需网络请求，加载速度快
- 矢量图形，任意缩放不失真
- 文件体积小
- 风格统一，视觉一致性强

#### 默认封面图片生成

运行以下脚本可重新生成默认封面图片：

```bash
cd /opt/idp-cms
python3 scripts/generate_default_covers.py
```

生成的图片位于：`sites/public/images/default-covers/`

### 3. 使用方式

#### 编辑文章时

1. **推荐做法**：为每篇文章上传专用封面图片
   - 在 Wagtail 管理界面的"封面图片"字段上传
   - 推荐尺寸：1200x675 (16:9)

2. **次优做法**：在正文中插入图片
   - 系统会自动提取第一张图片作为封面
   - 适合转载文章或快速发布

3. **默认方案**：什么都不做
   - 系统会根据文章的频道/标签显示对应的默认封面
   - 确保首页不会出现空白或错位

#### 前端显示逻辑

所有文章卡片组件会按以下顺序查找图片：

```typescript
image_url（文章封面） 
  || placeholderImage（根据分类生成的本地默认封面）
```

### 4. 配置选项

如果需要修改默认封面的样式，可以编辑：

**Python 脚本**：`scripts/generate_default_covers.py`
- 修改颜色、图标、文字
- 重新运行脚本生成新的 SVG

**TypeScript 配置**：`sites/lib/utils/placeholderImages.ts`
- 修改分类匹配规则
- 调整智能识别逻辑

### 5. 视觉效果

**有封面的文章**：
- 显示真实封面图片
- 鼠标悬停时图片会轻微放大

**没有封面的文章**：
- 显示对应分类的默认封面（彩色渐变 + 图标 + 分类名称）
- 开发环境会在右上角显示"默认"标识
- 用户体验无差异

**首页整体效果**：
- 视觉统一，无空白或混乱
- 即使文章没有图片，也能呈现专业的新闻网站效果
- 用户可以通过封面颜色快速识别新闻分类

### 6. 性能优化

- ✅ 本地 SVG 图片，无外部依赖
- ✅ 图片错误时自动回退，不会显示损坏图标
- ✅ 懒加载非关键图片
- ✅ Next.js Image 组件自动优化

## 迁移建议

### 立即生效

所有改进都是向后兼容的：
- 现有文章不受影响
- 新文章自动享受新功能
- 无需数据迁移

### 可选操作

如果想为现有文章补充封面图片，可以运行以下管理命令：

```python
# 为所有没有封面的文章从正文提取第一张图片
from apps.news.models import ArticlePage

for article in ArticlePage.objects.filter(cover__isnull=True):
    if article.auto_set_cover_from_body():
        article.save(auto_cover_from_body=False)  # 避免重复提取
        print(f"✓ 已为文章 {article.title} 设置封面")
```

## 常见问题

**Q: 默认封面能自定义吗？**  
A: 可以。修改 `scripts/generate_default_covers.py` 后重新运行脚本即可。

**Q: 能禁用自动提取正文图片吗？**  
A: 可以。在保存文章时传入 `auto_cover_from_body=False` 参数。

**Q: 为什么不继续使用 Picsum？**  
A: 本地 SVG 方案更可靠、更快速、更可控，且无需依赖外部服务。

**Q: 默认封面会影响 SEO 吗？**  
A: 不会。社交分享和 SEO 优先使用真实封面。如果没有，会使用默认封面。

## 总结

通过这套方案，无论文章是否有封面图片，都能确保：
- ✅ 首页展示美观统一
- ✅ 用户体验流畅
- ✅ 编辑工作更灵活
- ✅ 系统更加健壮可靠


