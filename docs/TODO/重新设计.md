# 最终设计文档（Wagtail 7.1 + Next.js + REST）

## 0. 目标与范围

* 以 **REST API** 为出数层，支撑门户与 50 站的内容分发、聚合与 SEO 友好发布。
* 保留约束：多 Site 起步、Webhook→**精准 Tag 失效**、门户聚合**只摘要 + canonical 指向来源**。 &#x20;

## 1. 域名与多站点规划

* 门户：`aivoya.com`；地方站：`{region}.aivoya.com`；通配证书 `*.aivoya.com`；DNS/CDN 建议 Cloudflare（支持边缘缓存与自定义 Cache-Tag）。

## 2. 数据模型（Wagtail 7.1）

* **Article**：`title, slug, excerpt, cover(Image), body(StreamField/RichText), publish_at, updated_at, channel(FK), region(FK), source_site(Site FK), allow_aggregate(bool), canonical_url(URL), is_featured(bool), weight(int)`；**必须**建立 `(site_id, publish_at, channel_id, region_id)` 联合索引；如有置顶/权重再加 `(site_id, is_featured, weight, publish_at)`。
* **Channel/Region**：`Channel(slug,name)`；`Region(slug,name,order)`；可配标签。
* **SiteSettings（每 Site）**：品牌/SEO 默认/统计/页脚链接等。

> 门户自产文章与聚合文章并存策略：门户 Site 下的文章在门户全文展示且 canonical 指向门户；聚合文章在门户只展示摘要并 canonical 指向来源站（延续原策略）。

## 3. REST API 规范（公共只读）

**总则**：所有读取接口**必须**带 `site` 参数（主机名或 site\_id），服务端基于该站点根页面限定查询范围；支持：

* `fields=title,slug,excerpt,cover.url,channel.slug,region.slug`（字段白名单选择）
* `include=channel,region,cover`（关联展开）
* 过滤：`channel,region,q,is_featured,since`；排序：`order=-publish_at,weight`

**资源与路径**

* `GET /api/articles`（列表）
* `GET /api/articles/{slug}`（详情）
* `GET /api/channels`、`GET /api/regions`
* `GET /api/portal/articles?allow_aggregate=true`（门户聚合摘要流，不返回正文）
* `GET /api/site-settings`（站点配置）

**响应头（缓存）**

* `Cache-Control: public, s-maxage=120, stale-while-revalidate=60`（与前端 ISR 对齐）
* `ETag: <hash>`（基于 `updated_at`）
* `Surrogate-Key: site:{host} page:{id} channel:{slug} region:{slug}`（边缘按 Tag 精确清理；命名与前端一致）。

## 4. 前端（Next.js 14+）

* 站点分流：按 Host 进入 `(portal)` 或 `(localsite)`；静态与 API 路由放行（沿用既有中间件结构）。
* 页面缓存：详情/频道页 `revalidate = 120s`；在服务端渲染时打 **Tag**：`site:* / page:* / channel:* / region:*`。
* 门户聚合页只渲染摘要，并输出 `<link rel="canonical" href="{来源站原文URL}">`；门户自产文章 canonical 指向门户自身。

## 5. Webhook 与精准失效

* **Wagtail → 前端**：发布/更新/撤稿/置顶 → `POST /api/revalidate`；载荷包含 `event, site, entity, pageId, slug, channel, region, at, signature`（HMAC-SHA256）。
* **接收端处理**：校验签名后执行：

  * `revalidateTag('site:'+site)`、可选 `revalidateTag('page:'+id)`/`'channel:'+slug`/`'region:'+slug`
  * 若带 `slug`，则 `revalidatePath('/news/'+slug)`（覆盖具体详情页）。

## 6. SEO / Sitemap / Feed

* 各站独立：`/sitemap.xml`、`/robots.txt`、`/feed.xml`；门户聚合只摘要 + canonical 指向来源站；结构化数据采用 `NewsArticle`（含 `datePublished`, `articleSection`, `contentLocation`）。

## 7. 媒体与权限

* 媒体：对象存储（S3/OSS）+ CDN 加速；图片域名建议独立。
* Collections：按站点分区；如需跨站复用，提供“公共集合（Shared）”受控写入或只读。

## 8. 运维与上线（MVP）

* DNS/证书：根域 + 通配证书；
* 监控：前端访问日志、API 错误率、Webhook 重试队列；
* 性能目标：列表 P95 < 150ms（命中缓存）；详情 P95 < 250ms（命中缓存/ISR）。

## 9. 测试清单（关键场景）

* 站点作用域：跨站访问被拒（403）；
* 门户聚合：摘要与 canonical 正确指向来源；
* Webhook：发布/更新/撤稿触发正确的 Tag 与 Path 失效；
* 缓存：`ETag` 命中、`s-maxage`/ISR 生效；
* 图片：多规格与 `srcset` 命中 CDN；
* SEO：各站 `sitemap/robots/feed` 输出与索引测试通过。

---

