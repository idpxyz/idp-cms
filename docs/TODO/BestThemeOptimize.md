你的风险清单总体判断是**准确的**（排序也基本合理）。下面我逐条给出「为什么」「做到什么程度算控住」「怎么做（可直接执行的措施）」——尽量量化到指标、负责人和落地步骤，确保这些风险不会在落地期爆雷。

---

# 高风险

## 1) 动态导入性能影响（主题懒加载 → 首屏变慢）

**评估**：成立，但可通过“尽量 Server 端化 + 预热/预取 + 缓存”把风险降到低。

**控制目标**

- 主题相关 JS 对**客户端额外增量 ≤ 30KB gzip**（大多主题布局做成 **Server Components**，不落到客户端）。
- LCP（首屏最大内容绘制）命中缓存 **< 1.5s**（移动 4G，p75）。

**措施（按优先级）**

1. **主题尽量用 Server Components**：布局、模块容器默认是 RSC；只有交互小部件才 `use client`。这样“动态导入主题”不会膨胀客户端 bundle。
2. **边缘与应用层预热**

   - 上线时对**所有激活站点**跑一遍 sitemap 预拉（预渲染 + CDN 命中）。
   - 在中间件里识别 Host，**优先请求站点设置**（短 TTL）触发主题加载的服务器缓存。

3. **Page-level 预取**

   - 在门户/列表页将下一个目标详情页的**主题布局**以 `<link rel="preload">` 或 `prefetch()` 提前拉取（仅热点路径）。

4. **监控与报警**

   - RUM 上报 `theme_load_duration`；若 p75 > 100ms（服务端）或新主题增量 JS >30KB，CI 阻断发布。

5. **兜底**

   - 加强“回退布局”（如 `localsite-default`），主题加载异常直接回退，避免白屏。

> 经验值：只要把主题做成 RSC，动态导入的开销主要在**服务器端模块解析**和**少量样式**，对首屏影响可控。

---

## 2) 缓存失效复杂（多层标签）

**评估**：成立，但核心在于**标签治理**。关键是**标签有限**、**映射单源**、**自动化校验**。

**控制目标**

- 标签种类 ≤ 5（`site:* / page:* / channel:* / region:* / theme:*`）。
- Webhook 到首屏更新 **p95 < 10s**；无“误伤全站”的大失效。

**措施**

1. **单一入口**：前端仅暴露 `/api/revalidate` 一个入口；**任何**失效都走它。
2. **固定枚举**：标签只允许上述 5 类，前端/后端共用同一常量文件（测试中校验）。
3. **映射表**：在 `/api/revalidate` 把事件 → 标签 的映射集中管理（可观测、可回放）。
4. **幂等与节流**：HMAC + 时间窗 ±5min + `nonce` 去重；对同一标签的批量事件做 1–2s 合并。
5. **演练**：提供**离线回放脚本**，定期在预发回放一天的 webhook 流，验证不会引发“全站大刷新”。

---

## 3) 主题间兼容性（升级向后兼容）

**评估**：成立。主题变化可能打破布局/模块接口。

**控制目标**

- **主题语义化版本**（semver）：**小版本兼容、次版本可自动迁移、主版本需显式切换**。
- 回退**不需回滚代码**：仅修改 `theme_version`/channel 即可。

**措施**

1. **主题契约（Contract）**：为主题/布局/模块定义 TypeScript 接口（props 形状、必填/可选）。
2. **契约测试**：在 CI 中跑“主题契约单测”与**可视化回归**（Storybook + 截图对比/Playwright）。
3. **版本目录**：大改动放 `themes/<key>/v2/` 新目录；旧目录继续保留。
4. **迁移脚本**：配合 Wagtail `SiteSettings` 的变更提供一次性“字段迁移器”（如 `layout_key` 重命名映射）。
5. **灰度与回退**：`theme_channel=beta/stable` 或 `theme_version` 精确到站点级；任意时刻可以切回旧版本。

---

# 中风险

## 4) JSON 字段类型安全（`brand_tokens` / `modules`）

**评估**：成立。自由 JSON 缺乏验证容易出脏数据。

**控制目标**

- 写入前**强校验**；前端拿到的数据**结构稳定**。
- 异常配置不会导致渲染报错（回退到默认）。

**措施**

1. **后端校验**：DRF Serializer + JSON Schema 校验（或 Pydantic-like 校验器）；校验失败即 400。
2. **前端校验**：`zod` 定义 schema，解析失败回退默认 tokens/modules，并上报 Sentry。
3. **默认值与白名单**：`brand_tokens` 仅允许定义的覆盖键；`modules` 仅允许已注册模块名。
4. **后台编辑面板**：用枚举/选择器（避免自由文本），并提供**预览**。

## 5) 数据库迁移复杂度

**评估**：中等。尤其从“无主题字段”到“有主题字段”。

**控制目标**

- 迁移**零停机**；**回滚简单**（仅回退读新表字段）。

**措施**

1. **双写/影子列**：先加新列（可空），后端发布后**双写**旧逻辑与新列。
2. **后填充**：管理命令批量 backfill（分页 1k/批），带进度与断点续跑。
3. **读切换**：确认 backfill 完成后，将读路径切到新列（开特性开关）。
4. **回滚**：读路径仍保留旧列若干版本；出问题即刻回切。
5. **数据校验**：迁移后跑审计 SQL/脚本对比行数/聚合指标。

## 6) overrides 维护成本（站点级覆盖）

**评估**：中等。防止“越改越散”。

**控制目标**

- 覆盖站点 ≤ 20%（有 SLA 门槛）。
- 覆写**仅限布局/样式层**；逻辑尽量复用主题/基础组件。

**措施**

1. **目录白名单**：仅允许在 `overrides/<host>/layouts|components` 下创建文件（lint 规则限制 import 路径）。
2. **“差异审计”**：CI 比对 overrides 与主题默认文件，产出差异报告；大版本升级时自动提示需同步的断点。
3. **SLA 与流程**：新建 overrides 需评审；定期（季度）复盘删减不必要覆写。
4. **文档与模板**：提供覆写模板与最佳实践（只改样式/骨架，不 fork 数据层）。

---

# 低风险

## 7) 开发工具链配置（TS Types、构建）

**评估**：低。主要是把主题注册表与路径别名、Server/Client 边界配置好。

**措施**

- `paths`/`alias` 固定：`@/themes/*`, `@/overrides/*`, `@/base/*`。
- **注册表编译检查**：未在 registry 声明的主题不参与打包；CI 检查 bundle 体积阈值。
- **RSC 边界**：默认 RSC，`use client` 仅在交互组件；eslint 规则限制误用。

## 8) 测试覆盖率

**评估**：低，但必须补足“契约 + 端到端 + 性能”。

**措施**

- **契约测试**：对每个主题布局跑 props 形状/必填项单测。
- **可视化回归**：Storybook + Chromatic（或 Playwright 截图）对关键模块拍照对比。
- **E2E**：站点首屏、频道页、详情页 3 条黄金路径。
- **性能基线**：CI 跑 Lighthouse，阻断 LCP > 2.5s（移动）/JS 体积超阈。

---

## 风险-对策一览表（可贴进项目 Wiki）

| 风险           | 严重度 | 控制目标                       | 负责人 | 关键措施                             | 度量/验收         |
| -------------- | ------ | ------------------------------ | ------ | ------------------------------------ | ----------------- |
| 动态导入性能   | 高     | 主题增量 JS≤30KB；LCP p75<1.5s | FE     | RSC 优先、预热/预取、回退布局        | RUM + CI 体积阈值 |
| 缓存失效复杂   | 高     | 标签 ≤5；p95<10s               | FE/BE  | 单入口、固定枚举、幂等节流、回放演练 | 失效延迟看板      |
| 主题兼容性     | 高     | semver；随时回退               | FE     | 契约接口、可视化回归、版本目录       | 回退演练通过      |
| JSON 类型安全  | 中     | 强校验+默认回退                | BE/FE  | DRF schema + zod 校验                | 错误率<0.1%       |
| DB 迁移        | 中     | 零停机、可回滚                 | BE     | 双写/后填充/读切换                   | 审计对账通过      |
| overrides 成本 | 中     | ≤20%，只改壳                   | FE     | 白名单、差异审计、SLA                | 季度清理报告      |
| 工具链         | 低     | 构建稳定                       | FE     | paths/registry/ESLint                | CI 绿色           |
| 测试覆盖       | 低     | 覆盖契约/E2E                   | QA     | Contract+VRT+E2E                     | 阻断门槛生效      |

---

# 最终落地套餐（你现在就能用）

1. **把主题做成 RSC**：布局与大模块默认无 `use client`。
2. **主题注册表 + 版本目录**：仅允许声明过的主题被打包；新增主题一律走 `themes/<key>/<vN>/`。
3. **缓存治理**：固化 5 类标签；统一 `/api/revalidate`，幂等+节流；提供 webhook 回放脚本。
4. **JSON 校验**：后端 DRF + JSON Schema；前端 `zod`；失败回退默认配置并上报。
5. **迁移方案**：双写 → 后填充 → 读切换 → 回收；留好回滚开关。
6. **overrides 守门**：数量控制、lint 限制、差异审计、季度清理。
7. **性能与测试**：CI 体积阈值、Lighthouse、RUM 指标；Storybook/Playwright 做契约+可视化回归。

---


