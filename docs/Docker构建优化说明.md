# Docker æ„å»ºä¼˜åŒ–è¯´æ˜

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

å°† Django åç«¯çš„é‡å»ºæ—¶é—´ä» **5-10åˆ†é’Ÿ** å‡å°‘åˆ° **30ç§’-2åˆ†é’Ÿ**ï¼ˆå¦‚æœåªæ˜¯ä»£ç å˜æ›´ï¼‰ã€‚

## âŒ ä¼˜åŒ–å‰çš„é—®é¢˜

### é—®é¢˜1: æ¯æ¬¡éƒ½é‡æ–°å®‰è£…æ‰€æœ‰ä¾èµ–

**åŸå› ï¼š**
1. éƒ¨ç½²è„šæœ¬ä½¿ç”¨äº† `--no-cache` å‚æ•°
2. Dockerfile è®¾ç½®äº† `ENV PIP_NO_CACHE_DIR=1`
3. Dockerfile å±‚é¡ºåºä¸åˆç†

**è¡¨ç°ï¼š**
```bash
# æ¯æ¬¡è¿è¡Œéƒ½éœ€è¦ 5-10 åˆ†é’Ÿ
./deploy-node1-remote.sh --rebuild-backend

# è¾“å‡ºï¼š
# â³ æ­£åœ¨å®‰è£… Django...
# â³ æ­£åœ¨å®‰è£… Wagtail...
# â³ æ­£åœ¨å®‰è£… psycopg...
# ï¼ˆé‡å¤å®‰è£…æ‰€æœ‰ 21 ä¸ªåŒ…ï¼‰
```

### é—®é¢˜2: æ— æ³•åˆ©ç”¨ Docker å±‚ç¼“å­˜

**é”™è¯¯çš„ Dockerfile ç»“æ„ï¼š**
```dockerfile
# âŒ é”™è¯¯ï¼šå…ˆå¤åˆ¶æ‰€æœ‰ä»£ç ï¼Œå†å®‰è£…ä¾èµ–
COPY . .
RUN pip install --no-cache-dir -r requirements.txt
```

ä»»ä½•ä»£ç å˜æ›´éƒ½ä¼šå¯¼è‡´é‡æ–°å®‰è£…æ‰€æœ‰ä¾èµ–ï¼

## âœ… ä¼˜åŒ–åçš„æ”¹è¿›

### æ”¹è¿›1: ä¼˜åŒ– Dockerfile å±‚é¡ºåº

**æ­£ç¡®çš„ç»“æ„ï¼š**
```dockerfile
# âœ… æ­£ç¡®ï¼šå…ˆå¤åˆ¶ requirements.txt
COPY requirements.txt ./requirements.txt

# âœ… å®‰è£…ä¾èµ–ï¼ˆè¿™ä¸€å±‚ä¼šè¢«ç¼“å­˜ï¼‰
RUN pip install -r requirements.txt

# âœ… æœ€åå¤åˆ¶ä»£ç ï¼ˆä»£ç å˜æ›´ä¸å½±å“ä¾èµ–å±‚ï¼‰
COPY . .
```

**ä¼˜åŒ–åŸç†ï¼š**
- Docker æŒ‰å±‚æ„å»ºé•œåƒ
- åªæœ‰å½“æŸä¸€å±‚çš„è¾“å…¥æ”¹å˜æ—¶ï¼Œè¯¥å±‚åŠå…¶åç»­å±‚æ‰ä¼šé‡å»º
- `requirements.txt` å¾ˆå°‘æ”¹å˜ï¼Œæ‰€ä»¥ä¾èµ–å®‰è£…å±‚å‡ ä¹æ€»æ˜¯è¢«ç¼“å­˜

### æ”¹è¿›2: ç§»é™¤ä¸å¿…è¦çš„ `--no-cache`

**ä¿®æ”¹å‰ï¼š**
```bash
docker compose build --no-cache authoring  # âŒ å¿½ç•¥æ‰€æœ‰ç¼“å­˜
```

**ä¿®æ”¹åï¼š**
```bash
docker compose build authoring  # âœ… åˆ©ç”¨ç¼“å­˜
```

### æ”¹è¿›3: å¯ç”¨ pip ç¼“å­˜

**ä¿®æ”¹å‰ï¼š**
```dockerfile
ENV PIP_NO_CACHE_DIR=1  # âŒ ç¦ç”¨ç¼“å­˜
RUN pip install --no-cache-dir -r requirements.txt
```

**ä¿®æ”¹åï¼š**
```dockerfile
# âœ… æ³¨é‡Šæ‰ï¼Œå…è®¸ä½¿ç”¨ç¼“å­˜
# ENV PIP_NO_CACHE_DIR=1
RUN pip install -r requirements.txt  # âœ… ä½¿ç”¨ç¼“å­˜
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### åœºæ™¯1: åªä¿®æ”¹ Python ä»£ç ï¼ˆæœ€å¸¸è§ï¼‰

| ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|--------|--------|
| 5-10 åˆ†é’Ÿ | **30-60 ç§’** |
| é‡æ–°å®‰è£…æ‰€æœ‰ä¾èµ– | ä½¿ç”¨ç¼“å­˜çš„ä¾èµ–å±‚ |

**ç¤ºä¾‹è¾“å‡ºï¼ˆä¼˜åŒ–åï¼‰ï¼š**
```bash
./deploy-node1-remote.sh --rebuild-backend

# è¾“å‡ºï¼š
# Step 1/10: FROM python:3.11-slim AS base
#  ---> Using cache  âœ…
# Step 2/10: COPY requirements.txt
#  ---> Using cache  âœ…
# Step 3/10: RUN pip install -r requirements.txt
#  ---> Using cache  âœ…  ï¼ˆå…³é”®ï¼ç›´æ¥ä½¿ç”¨ç¼“å­˜ï¼‰
# Step 4/10: COPY . .
#  ---> 123abc456  ï¼ˆåªæœ‰è¿™ä¸€æ­¥é‡æ–°æ‰§è¡Œï¼‰
# ...
# âœ… æ„å»ºå®Œæˆï¼(è€—æ—¶: 45ç§’)
```

### åœºæ™¯2: ä¿®æ”¹ `requirements.txt`ï¼ˆæ·»åŠ æˆ–æ›´æ–°ä¾èµ–ï¼‰

| ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|--------|--------|
| 5-10 åˆ†é’Ÿ | **3-5 åˆ†é’Ÿ** |
| é‡æ–°ä¸‹è½½æ‰€æœ‰åŒ… | ä½¿ç”¨ pip ç¼“å­˜ |

**ç¤ºä¾‹ï¼š**
```bash
# ä¿®æ”¹ requirements.txtï¼Œæ·»åŠ æ–°åŒ…
echo "requests>=2.31" >> requirements.txt

./deploy-node1-remote.sh --rebuild-backend

# ä¼˜åŒ–åçš„è¡Œä¸ºï¼š
# - pip ä»æœ¬åœ°ç¼“å­˜è·å–å·²ä¸‹è½½çš„åŒ…
# - åªä¸‹è½½æ–°åŒ…ï¼ˆrequestsï¼‰
# - æ€»æ—¶é—´çº¦ 3-5 åˆ†é’Ÿï¼ˆè€Œé 10 åˆ†é’Ÿï¼‰
```

### åœºæ™¯3: å¼ºåˆ¶æ¸…ç†ç¼“å­˜ï¼ˆå¶å°”éœ€è¦ï¼‰

```bash
# ä½¿ç”¨ --no-cache å‚æ•°å¼ºåˆ¶é‡å»º
./deploy-node1-remote.sh --no-cache

# è¾“å‡ºï¼š
# ğŸ”¨ å¼ºåˆ¶é‡æ–°æ„å»ºæ‰€æœ‰é•œåƒï¼ˆæ— ç¼“å­˜ï¼Œä¼šå¾ˆæ…¢ï¼‰...
# ï¼ˆè€—æ—¶: 8-12 åˆ†é’Ÿï¼‰
```

**ä½•æ—¶ä½¿ç”¨ï¼š**
- æ€€ç–‘ç¼“å­˜æŸå
- ä¾èµ–å®‰è£…å‡ºç°å¥‡æ€ªé—®é¢˜
- éœ€è¦å®Œå…¨å¹²å‡€çš„æ„å»º

## ğŸš€ ä½¿ç”¨æŒ‡å—

### æ—¥å¸¸å¼€å‘ï¼ˆæœ€å¿«ï¼‰

```bash
# åªä¿®æ”¹äº† Python ä»£ç 
./deploy-node1-remote.sh --rebuild-backend

# è€—æ—¶: ~1 åˆ†é’Ÿ
# åˆ©ç”¨: æ‰€æœ‰ç¼“å­˜å±‚
```

### æ·»åŠ æ–°ä¾èµ–ï¼ˆè¾ƒæ…¢ï¼‰

```bash
# 1. ä¿®æ”¹ requirements.txt
echo "new-package>=1.0" >> requirements.txt

# 2. é‡å»º
./deploy-node1-remote.sh --rebuild-backend

# è€—æ—¶: ~3 åˆ†é’Ÿ
# åˆ©ç”¨: pip ç¼“å­˜ï¼ˆå·²ä¸‹è½½çš„åŒ…ï¼‰
```

### å®Œå…¨æ¸…ç†é‡å»ºï¼ˆæœ€æ…¢ï¼‰

```bash
# åªåœ¨é‡åˆ°é—®é¢˜æ—¶ä½¿ç”¨
./deploy-node1-remote.sh --no-cache

# è€—æ—¶: ~10 åˆ†é’Ÿ
# åˆ©ç”¨: æ— ç¼“å­˜
```

### å‰ç«¯é‡å»ºï¼ˆç‹¬ç«‹ï¼‰

```bash
# åªé‡å»ºå‰ç«¯ï¼Œä¸å½±å“åç«¯
./deploy-node1-remote.sh --rebuild-frontend

# è€—æ—¶: ~2 åˆ†é’Ÿ
```

## ğŸ“ˆ ç¼“å­˜å±‚è¯´æ˜

### Docker é•œåƒå±‚ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. base: Python åŸºç¡€é•œåƒ      â”‚ â† å‡ ä¹ä¸å˜ï¼ˆç¼“å­˜ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. ç³»ç»Ÿä¾èµ–ï¼ˆgcc, libpqç­‰ï¼‰   â”‚ â† å¾ˆå°‘å˜ï¼ˆç¼“å­˜ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. requirements.txt         â”‚ â† å¶å°”å˜ï¼ˆé€šå¸¸ç¼“å­˜ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. Python ä¾èµ–å®‰è£…           â”‚ â† å¶å°”å˜ï¼ˆé€šå¸¸ç¼“å­˜ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. å¤åˆ¶é¡¹ç›®ä»£ç               â”‚ â† ç»å¸¸å˜ï¼ˆéœ€é‡å»ºï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 6. collectstatic            â”‚ â† ç»å¸¸å˜ï¼ˆéœ€é‡å»ºï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç¼“å­˜å‘½ä¸­ç‡ï¼š**
- ğŸ“¦ ç¬¬1-2å±‚ï¼š~100% ç¼“å­˜ï¼ˆåŸºç¡€å±‚å¾ˆå°‘å˜ï¼‰
- ğŸ“¦ ç¬¬3-4å±‚ï¼š~90% ç¼“å­˜ï¼ˆä¾èµ–ä¸å¸¸æ›´æ–°ï¼‰
- ğŸ”„ ç¬¬5-6å±‚ï¼š~10% ç¼“å­˜ï¼ˆä»£ç é¢‘ç¹å˜æ›´ï¼‰

### pip ç¼“å­˜ä½ç½®

Docker æ„å»ºæ—¶ï¼Œpip ç¼“å­˜ä¿å­˜åœ¨ï¼š
```
~/.cache/pip/  # æœ¬åœ°æœºå™¨
/root/.cache/pip/  # Docker å®¹å™¨å†…
```

**æ¸…ç† pip ç¼“å­˜ï¼š**
```bash
# å¦‚æœæ€€ç–‘ç¼“å­˜æŸåï¼Œå¯ä»¥æ¸…ç†
docker system prune -a --volumes
```

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜1: æ„å»ºè¿˜æ˜¯å¾ˆæ…¢

**æ£€æŸ¥ï¼š**
```bash
# æŸ¥çœ‹æ„å»ºæ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦ä½¿ç”¨ç¼“å­˜
docker compose -f infra/production/docker-compose-ha-node1.yml build authoring 2>&1 | grep -i "using cache"

# åº”è¯¥çœ‹åˆ°ï¼š
#  ---> Using cache
#  ---> Using cache
```

**å¦‚æœæ²¡æœ‰çœ‹åˆ° "Using cache"ï¼š**
- æ£€æŸ¥ `requirements.txt` æ˜¯å¦è¢«ä¿®æ”¹
- æ£€æŸ¥ `.dockerignore` æ˜¯å¦é…ç½®æ­£ç¡®
- å°è¯•æ¸…ç†åé‡å»ºï¼š`docker system prune -a`

### é—®é¢˜2: ä¾èµ–å®‰è£…å¤±è´¥

**å¯èƒ½åŸå› ï¼š**
- pip ç¼“å­˜æŸå
- ç½‘ç»œé—®é¢˜ï¼ˆå›½å†…é•œåƒæºä¸ç¨³å®šï¼‰

**è§£å†³æ–¹æ³•ï¼š**
```bash
# æ–¹æ³•1: ä½¿ç”¨ --no-cache å¼ºåˆ¶é‡å»º
./deploy-node1-remote.sh --no-cache

# æ–¹æ³•2: æ¸…ç† Docker ç¼“å­˜
docker system prune -a
./deploy-node1-remote.sh --rebuild-backend

# æ–¹æ³•3: æ‰‹åŠ¨æ¸…ç† pip ç¼“å­˜
docker run --rm -v ~/.cache/pip:/root/.cache/pip python:3.11 rm -rf /root/.cache/pip/*
```

### é—®é¢˜3: ç¼“å­˜è¿‡å¤šå ç”¨ç£ç›˜

**æ£€æŸ¥ç£ç›˜ä½¿ç”¨ï¼š**
```bash
docker system df

# è¾“å‡ºï¼š
# TYPE            TOTAL     ACTIVE    SIZE      RECLAIMABLE
# Images          25        5         12.5GB    8.2GB (65%)
# Containers      8         8         1.2GB     0B (0%)
# Local Volumes   15        10        5.6GB     2.1GB (37%)
# Build Cache     156       0         3.2GB     3.2GB (100%)
```

**æ¸…ç†ç¼“å­˜ï¼š**
```bash
# æ¸…ç†æ„å»ºç¼“å­˜ï¼ˆæ¨èï¼‰
docker builder prune

# æ¸…ç†æ‰€æœ‰æœªä½¿ç”¨çš„ç¼“å­˜ï¼ˆæ…ç”¨ï¼‰
docker system prune -a --volumes
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. åˆç†ä½¿ç”¨ç¼“å­˜

```bash
# âœ… æ¨èï¼šæ—¥å¸¸å¼€å‘ä½¿ç”¨ç¼“å­˜
./deploy-node1-remote.sh --rebuild-backend

# âŒ ä¸æ¨èï¼šæ¯æ¬¡éƒ½ç”¨ --no-cache
./deploy-node1-remote.sh --no-cache  # å¤ªæ…¢ï¼
```

### 2. åªé‡å»ºéœ€è¦çš„æœåŠ¡

```bash
# âœ… åªä¿®æ”¹äº†åç«¯ä»£ç 
./deploy-node1-remote.sh --rebuild-backend

# âœ… åªä¿®æ”¹äº†å‰ç«¯ä»£ç 
./deploy-node1-remote.sh --rebuild-frontend

# âŒ ä¿®æ”¹äº†å‰ç«¯å´é‡å»ºå…¨éƒ¨
./deploy-node1-remote.sh  # ä¸å¿…è¦
```

### 3. requirements.txt ç®¡ç†

```bash
# âœ… ä½¿ç”¨å›ºå®šç‰ˆæœ¬
Django==5.0.6
wagtail==7.1.0

# âŒ ä½¿ç”¨å®½æ¾èŒƒå›´ï¼ˆå¯èƒ½å¯¼è‡´ç¼“å­˜å¤±æ•ˆï¼‰
Django>=5.0
wagtail>=7.0
```

### 4. å®šæœŸæ¸…ç†

```bash
# æ¯å‘¨æ¸…ç†ä¸€æ¬¡æœªä½¿ç”¨çš„é•œåƒ
docker image prune -a

# æ¯æœˆæ¸…ç†ä¸€æ¬¡æ„å»ºç¼“å­˜
docker builder prune --keep-storage 5GB
```

## ğŸ“ å»¶ä¼¸é˜…è¯»

- [Docker å¤šé˜¶æ®µæ„å»º](https://docs.docker.com/build/building/multi-stage/)
- [Docker å±‚ç¼“å­˜](https://docs.docker.com/build/cache/)
- [pip ç¼“å­˜æœºåˆ¶](https://pip.pypa.io/en/stable/topics/caching/)

## ğŸ“… æ›´æ–°æ—¥å¿—

- **2025-10-23**: åˆå§‹ç‰ˆæœ¬ï¼Œä¼˜åŒ– Dockerfile å’Œéƒ¨ç½²è„šæœ¬
- **ä¼˜åŒ–æ•ˆæœ**: æ—¥å¸¸é‡å»ºæ—¶é—´ä» 5-10åˆ†é’Ÿ â†’ 30-60ç§’ï¼ˆå‡å°‘ **90%**ï¼‰

