很好的四种布局策略。给你一份“怎么选 + 怎么落地”的结论版评估，最后附上可直接照抄的实现方案（Wagtail 7.1 + Next.js 14 + REST）。

# 先给结论

- **推荐默认：方案 ④（混合）**
  Portal 统一一套品牌布局；子站点中**大多数**复用一套“通用地方站主题”，**少数**高优先级站点做独立定制。

  - 原因：同时兼顾品牌一致性、开发与运维成本、以及关键城市/频道的差异化诉求。
  - 运维可控：通用主题 80% 覆盖，定制主题可控在 20% 以内。

# 快速对比（如何取舍）

| 方案                                            | 适用场景                       | 成本 | 统一性 | 差异化 | 迭代/上线风险      |
| ----------------------------------------------- | ------------------------------ | ---- | ------ | ------ | ------------------ |
| ① 每站不同布局                                  | 强品牌独立、商业合作多样       | 最高 | 最差   | 最强   | 高（多仓离散变更） |
| ② Portal 一套，子站共用一套                     | 需要强品牌统一、快速铺设 50 站 | 低   | 强     | 弱     | 低                 |
| ③ 全部用 Portal 布局                            | SaaS 极致统一、内容同质化      | 最低 | 最强   | 最弱   | 最低               |
| ④ Portal 一套；子站大部分共用，一小部分独立定制 | 既要统一又要关键站“出花活”     | 中   | 中-强  | 中-强  | 中                 |

> 若你追求“快上量、可运营、能灵活”，④ 最均衡。

---

# 技术落地（无论选哪种，都按这套来）

## 1) 主题与布局的“分层”思路

- **Design Token 层（站点主题变量）**：颜色、字号、间距、圆角、阴影等（Wagtail `SiteSettings` 下发；前端注入 CSS 变量）。
- **Layout 模板层**：头部/导航/栏目布局/文章页骨架。
- **模块组件层**：卡片、列表、Banner、侧栏等可复用组件。
- **站点配置层**：哪些模块出现、排序、栏目别名、广告/脚本/GTM 等。

> 这样做的好处：80% 的差异只需要改 token + 配置，不需要 fork 布局代码。

## 2) Wagtail 7.1（后端）怎么给前端“主题 + 布局提示”

- 在 `SiteSettings` 添加：

  - `theme_key: str`（如 `portal`, `localsite-default`, `localsite-shanghai`…）
  - `brand_tokens: JSON`（主色、辅助色、字体、圆角、卡片风格…）
  - `layout_key: str`（如 `layout-portal-classic`, `layout-localsite-grid`）
  - `modules: JSON`（首页模块编排、频道模块开关/顺序）

- **REST**：`GET /api/v1/site-settings?site=...` 返回这些配置。
- **文章/频道接口**：保持不变，仅影响渲染层。

## 3) Next.js（前端）如何“切布局”

目录建议（支持 ②/③/④ 任意组合）：

```
app/
  (portal)/
    layout.tsx            # Portal 布局
    page.tsx
    news/[slug]/page.tsx
  (localsite)/
    layout.tsx            # 通用地方站布局（默认）
    page.tsx
    news/[slug]/page.tsx
  themes/
    tokens/portal.ts      # Portal token
    tokens/localsite-default.ts
    tokens/shanghai.ts    # 某些站点的定制 token
  layouts/
    layout-portal-classic.tsx
    layout-localsite-grid.tsx
    layout-localsite-magazine.tsx  # 可选：少数站点独立
  components/
    cards/...
    lists/...
```

- **中间件**按 Host 将请求分流到 `(portal)` 与 `(localsite)`（已在你的整体方案中）。
- 在根布局 `layout.tsx` 中：

  1. 先 `fetch /api/v1/site-settings?site=host`
  2. 将 `brand_tokens` 注入 `<style>:root{--brand-primary: ...}</style>`
  3. 根据 `layout_key/theme_key` 动态选择 `layouts/*` + `themes/tokens/*`

- 缓存：`revalidate=120` + `tags: [site:HOST]`；失效沿用 Webhook Tag。

## 4) 缓存策略要点

- **页面**：打 `site:HOST` + 关键 `page:`/`channel:`/`region:`；
- **CSS Token**：随 `site-settings` 走 `site:HOST` 标签；
- **“同代码，多主题”** 不会破坏缓存命中，只要按 Host 打标签即可。

## 5) 组件复用与“可差异化”

- 样式层尽量以 **CSS 变量 + Tailwind** 实现（避免多套样式文件）。
- 结构差异（如 Portal 有 MegaMenu、地方站无）通过 `layout_key` 与 `modules` 开关。
- 少数站点需要“完全不一样”的首页：为该站点单独提供 `layout-*.tsx` 并在 `SiteSettings.layout_key` 指向它（④ 的“独立定制”路径）。

---

# 四种方案的具体实现建议

## ① “每站独立布局”

- `layouts/` 下每站一个布局文件；`SiteSettings.layout_key` 映射到各自布局。
- 风险：代码分叉多、回归成本高。只在“媒体集团 + 强本地品牌诉求 + 长期独立运营团队”的情况下采用。

## ② “Portal 一套 + 子站共用一套”

- `(portal)` 与 `(localsite)` 各保留一个布局；
- 子站差异主要靠 `brand_tokens` 与 `modules` 调；
- 适合快速铺设、集中运营；后续可以平滑升级到 ④（给少数站点增配独立布局）。

## ③ “所有站都用 Portal 布局”

- 只保留 `(portal)`；子站也路由进 `(portal)`；
- 通过 `brand_tokens` 做色彩/Logo 区分。
- 适合最小化成本的 SaaS，但内容气质趋同，地方站特色不足。

## ④ “混合：Portal 一套；子站大部分共用，一小部分独立定制” ✅ 推荐

- 默认走 ②；为重点站点新增 `layout-localsite-<city>.tsx`；
- 统一的 `components/` 与 `tokens/`，尽量把差异限制在布局骨架与模块编排；
- 运维层面：**站点 → 主题/布局 → 模块编排** 三段式配置，不动数据模型。

---

# 关键实现细节（可直接用）

### SiteSettings（Wagtail 7.1）

```python
class SiteSettings(models.Model):
    site = models.OneToOneField(Site, on_delete=models.CASCADE, related_name="settings")
    theme_key = models.CharField(max_length=64, default="localsite-default")
    layout_key = models.CharField(max_length=64, default="layout-localsite-grid")
    brand_tokens = models.JSONField(default=dict)  # {primary: "#4F46E5", radius: "1rem", ...}
    modules = models.JSONField(default=dict)       # {home: ["hero","top-news","channels"], sidebar:["rank","ad"]}
```

### REST：站点设置

```ts
// 前端获取
const settings = await fetchJSON("/api/v1/site-settings", {
  site: host,
  tags: [`site:${host}`],
});
applyTokens(settings.brand_tokens); // 注入 CSS 变量
const Layout = await pickLayout(settings.layout_key); // 动态 import 对应布局
```

### 注入 CSS 变量（Next.js 根布局）

```tsx
function TokenStyle({ tokens }: { tokens: Record<string, string> }) {
  const css = Object.entries(tokens)
    .map(([k, v]) => `--${k}:${v};`)
    .join("");
  return <style dangerouslySetInnerHTML={{ __html: `:root{${css}}` }} />;
}
```

### 布局选择器（示意）

```ts
export async function pickLayout(key: string) {
  switch (key) {
    case "layout-portal-classic":
      return (await import("@/layouts/layout-portal-classic")).default;
    case "layout-localsite-magazine":
      return (await import("@/layouts/layout-localsite-magazine")).default;
    default:
      return (await import("@/layouts/layout-localsite-grid")).default;
  }
}
```

---

# 运营与治理建议

- **主题变更流程**：先改 `SiteSettings` 草稿 → 预览 → 审核 → 发布；触发 Webhook 精准失效（`site:HOST`）。
- **定制申请门槛**：建立“独立布局申请表”与 SLA（如月活/营收/活动节点）；避免无序定制。
- **资产与可观察性**：统一埋点（GTM from `SiteSettings`），看各站 PV/CTR 与布局 A/B 的差异。
- **设计治理**：建立“设计规范 + 组件库 Storybook”，定制站点只能扩展，不能私改核心组件。

---

## 最后一句

- 你现在的 portal + 子站模式，**用 ④ 作为默认长期策略**最稳：

  1. 快速复制（共用地方站主题）；
  2. 保持品牌统一（Portal 独立且强）；
  3. 给关键站点留足差异化空间（独立布局受控启用）。

- 上面给的“SiteSettings + token + layout_key + modules”就是这四种方案的统一支撑底座。你随时可以从 ② 或 ③ 平滑演进到 ④，无需重构。
