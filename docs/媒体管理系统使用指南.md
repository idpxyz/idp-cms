# 多站点媒体管理系统使用指南

## 📖 概述

本指南介绍如何使用已实施的多站点媒体管理系统，包括管理员配置、编辑使用和 API 调用等各个方面。

## 🚀 快速开始

### 1. 系统初始化

启动所有服务：

```bash
# 启动 Docker 环境
docker compose -f infra/local/docker-compose.yaml up -d

# 等待服务启动完成，然后初始化媒体系统
docker compose -f infra/local/docker-compose.yaml exec authoring python manage.py setup_media_collections
```

### 2. 验证安装

检查系统状态：

```bash
# 检查 MinIO 桶
docker compose -f infra/local/docker-compose.yaml exec minio mc ls local/

# 检查 Wagtail 集合
docker compose -f infra/local/docker-compose.yaml exec authoring python manage.py shell -c "
from wagtail.models import Collection;
[print(f'- {c.name}') for c in Collection.objects.filter(depth=2)]
"
```

## 🏢 管理员配置

### 为用户分配权限

1. **登录 Wagtail 管理后台**

   - 访问：`http://localhost:8000/admin/`
   - 使用超级用户账号登录

2. **创建站点编辑组**

   ```bash
   # 系统已自动创建以下用户组：
   # - Portal Editors (门户编辑)
   # - Beijing Editors (北京编辑)
   # - Shanghai Editors (上海编辑)
   # - Hangzhou Editors (杭州编辑)
   # - Shenzhen Editors (深圳编辑)
   ```

3. **分配用户到对应组**
   - 进入 `设置` → `用户`
   - 编辑用户，在 `组` 字段中选择对应的编辑组
   - 保存用户

## 👥 编辑使用

### 上传图片/文档

1. **在 Wagtail 后台上传**

   - 进入 `图像` 或 `文档` 管理
   - 点击 `添加图像/文档`
   - 选择文件上传
   - 系统会自动：
     - 分配到对应站点的集合
     - 使用标准化的存储路径：`aivoya/{site}/{collection}/{year}/{month}/originals/{hash}.ext`

2. **文件存储位置**

   ```
   公共文件: idp-media-prod-public 桶
   私有文件: idp-media-prod-private 桶

   路径格式: aivoya/beijing/beijing-media/2025/01/originals/abc123.jpg
   ```

### 访问权限

- **编辑只能看到和使用自己站点的媒体文件**
- **不同站点的文件完全隔离**
- **支持按集合进一步细分权限**

## 🔗 API 使用

### 1. 私有文件下载

获取私有文件的预签名下载链接：

```bash
# 获取文件下载链接
curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:8000/api/media/presign-download/aivoya/beijing/docs/2025/01/originals/document.pdf/

# 响应示例
{
  "url": "http://localhost:9002/idp-media-prod-private/aivoya/beijing/docs/2025/01/originals/document.pdf?X-Amz-Algorithm=...",
  "expires_in": 600,
  "key": "aivoya/beijing/docs/2025/01/originals/document.pdf"
}
```

### 2. 私有文件上传

获取私有文件的预签名上传链接：

```bash
# 请求上传链接
curl -X POST \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -d '{
       "filename": "confidential.pdf",
       "content_type": "application/pdf",
       "site": "beijing"
     }' \
     http://localhost:8000/api/media/presign-upload/

# 响应示例
{
  "upload_url": "http://localhost:9002/idp-media-prod-private",
  "fields": {
    "key": "aivoya/beijing/default/2025/01/originals/abc123.pdf",
    "Content-Type": "application/pdf"
  },
  "key": "aivoya/beijing/default/2025/01/originals/abc123.pdf",
  "expires_in": 3600
}
```

### 3. 文件信息查询

```bash
# 获取文件元数据
curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:8000/api/media/file-info/aivoya/beijing/docs/2025/01/originals/document.pdf/

# 响应示例
{
  "key": "aivoya/beijing/docs/2025/01/originals/document.pdf",
  "size": 1048576,
  "content_type": "application/pdf",
  "last_modified": "2025-01-15T10:30:00Z",
  "etag": "abc123def456"
}
```

## 🛠️ 管理命令

### 媒体集合管理

```bash
# 创建所有站点的集合和权限
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py setup_media_collections

# 只为特定站点创建
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py setup_media_collections --site beijing

# 预览操作（不实际执行）
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py setup_media_collections --dry-run
```

### MinIO 生命周期配置

```bash
# 配置所有桶的生命周期规则
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py setup_minio_lifecycle

# 只配置公共桶
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py setup_minio_lifecycle --bucket public

# 预览配置
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py setup_minio_lifecycle --dry-run
```

## 📊 监控和维护

### 查看存储统计

```bash
# 生成存储统计报告
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py shell -c "
from apps.media.tasks import generate_storage_stats
import json
result = generate_storage_stats()
print(json.dumps(result['stats'], indent=2))
"
```

### 手动清理任务

```bash
# 清理孤儿文件
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py shell -c "
from apps.media.tasks import cleanup_orphan_files
result = cleanup_orphan_files()
print(f'清理完成: {result}')
"

# 清理临时文件
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py shell -c "
from apps.media.tasks import cleanup_temp_files
result = cleanup_temp_files()
print(f'清理完成: {result}')
"
```

### Celery 任务监控

```bash
# 查看 Celery 任务状态
docker compose -f infra/local/docker-compose.yaml exec authoring \
  celery -A config inspect active

# 查看定时任务
docker compose -f infra/local/docker-compose.yaml exec authoring \
  celery -A config inspect scheduled
```

## 🗂️ 文件组织结构

### 存储桶结构

```
idp-media-prod-public/          # 公共文件桶
├── aivoya/
│   ├── portal/
│   │   ├── portal-media/
│   │   │   ├── 2025/01/originals/
│   │   │   ├── 2025/01/renditions/
│   │   │   └── 2025/01/tmp/
│   ├── beijing/
│   │   ├── beijing-media/
│   │   │   ├── 2025/01/originals/
│   │   │   └── 2025/01/renditions/
│   └── shanghai/...

idp-media-prod-private/         # 私有文件桶
├── aivoya/
│   ├── portal/...
│   ├── beijing/...
│   └── shanghai/...
```

### 集合权限映射

| 站点     | 集合名称       | 用户组           | 权限范围          |
| -------- | -------------- | ---------------- | ----------------- |
| Portal   | Portal Media   | Portal Editors   | 增删改查图片/文档 |
| Beijing  | Beijing Media  | Beijing Editors  | 增删改查图片/文档 |
| Shanghai | Shanghai Media | Shanghai Editors | 增删改查图片/文档 |
| Hangzhou | Hangzhou Media | Hangzhou Editors | 增删改查图片/文档 |
| Shenzhen | Shenzhen Media | Shenzhen Editors | 增删改查图片/文档 |

## 🚨 故障排除

### 常见问题

1. **上传失败**

   ```bash
   # 检查 MinIO 连接
   docker compose -f infra/local/docker-compose.yaml exec authoring \
     python manage.py shell -c "
   from apps.core.storages import PublicMediaStorage
   storage = PublicMediaStorage()
   print('Storage connection OK')
   "
   ```

2. **权限问题**

   ```bash
   # 重新设置权限
   docker compose -f infra/local/docker-compose.yaml exec authoring \
     python manage.py setup_media_collections
   ```

3. **Celery 任务不执行**
   ```bash
   # 重启 Celery 服务
   docker compose -f infra/local/docker-compose.yaml restart celery celery-beat
   ```

### 日志查看

```bash
# 查看应用日志
docker compose -f infra/local/docker-compose.yaml logs -f authoring

# 查看 Celery 日志
docker compose -f infra/local/docker-compose.yaml logs -f celery

# 查看 MinIO 日志
docker compose -f infra/local/docker-compose.yaml logs -f minio
```

## 📚 更多资源

- **技术文档**: `docs/TODO/Media Solution.md`
- **架构设计**: `docs/TODO/Media.md`
- **API 文档**: `http://localhost:8000/api/media/` (开发中)
- **管理后台**: `http://localhost:8000/admin/`
- **MinIO 控制台**: `http://localhost:9001/`

---

## 🎯 最佳实践

1. **定期备份重要文件**
2. **监控存储使用量**
3. **定期清理临时文件**
4. **为不同类型文件使用合适的集合**
5. **遵循命名规范**
6. **及时更新权限配置**

该媒体管理系统现已完全就绪，可支持生产环境使用！🚀
