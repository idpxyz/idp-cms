# å¤šç«™ç‚¹åª’ä½“ç®¡ç†ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“– æ¦‚è¿°

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•ä½¿ç”¨å·²å®æ–½çš„å¤šç«™ç‚¹åª’ä½“ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…æ‹¬ç®¡ç†å‘˜é…ç½®ã€ç¼–è¾‘ä½¿ç”¨å’Œ API è°ƒç”¨ç­‰å„ä¸ªæ–¹é¢ã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç³»ç»Ÿåˆå§‹åŒ–

å¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼š

```bash
# å¯åŠ¨ Docker ç¯å¢ƒ
docker compose -f infra/local/docker-compose.yaml up -d

# ç­‰å¾…æœåŠ¡å¯åŠ¨å®Œæˆï¼Œç„¶ååˆå§‹åŒ–åª’ä½“ç³»ç»Ÿ
docker compose -f infra/local/docker-compose.yaml exec authoring python manage.py setup_media_collections
```

### 2. éªŒè¯å®‰è£…

æ£€æŸ¥ç³»ç»ŸçŠ¶æ€ï¼š

```bash
# æ£€æŸ¥ MinIO æ¡¶
docker compose -f infra/local/docker-compose.yaml exec minio mc ls local/

# æ£€æŸ¥ Wagtail é›†åˆ
docker compose -f infra/local/docker-compose.yaml exec authoring python manage.py shell -c "
from wagtail.models import Collection;
[print(f'- {c.name}') for c in Collection.objects.filter(depth=2)]
"
```

## ğŸ¢ ç®¡ç†å‘˜é…ç½®

### ä¸ºç”¨æˆ·åˆ†é…æƒé™

1. **ç™»å½• Wagtail ç®¡ç†åå°**

   - è®¿é—®ï¼š`http://localhost:8000/admin/`
   - ä½¿ç”¨è¶…çº§ç”¨æˆ·è´¦å·ç™»å½•

2. **åˆ›å»ºç«™ç‚¹ç¼–è¾‘ç»„**

   ```bash
   # ç³»ç»Ÿå·²è‡ªåŠ¨åˆ›å»ºä»¥ä¸‹ç”¨æˆ·ç»„ï¼š
   # - Portal Editors (é—¨æˆ·ç¼–è¾‘)
   # - Beijing Editors (åŒ—äº¬ç¼–è¾‘)
   # - Shanghai Editors (ä¸Šæµ·ç¼–è¾‘)
   # - Hangzhou Editors (æ­å·ç¼–è¾‘)
   # - Shenzhen Editors (æ·±åœ³ç¼–è¾‘)
   ```

3. **åˆ†é…ç”¨æˆ·åˆ°å¯¹åº”ç»„**
   - è¿›å…¥ `è®¾ç½®` â†’ `ç”¨æˆ·`
   - ç¼–è¾‘ç”¨æˆ·ï¼Œåœ¨ `ç»„` å­—æ®µä¸­é€‰æ‹©å¯¹åº”çš„ç¼–è¾‘ç»„
   - ä¿å­˜ç”¨æˆ·

## ğŸ‘¥ ç¼–è¾‘ä½¿ç”¨

### ä¸Šä¼ å›¾ç‰‡/æ–‡æ¡£

1. **åœ¨ Wagtail åå°ä¸Šä¼ **

   - è¿›å…¥ `å›¾åƒ` æˆ– `æ–‡æ¡£` ç®¡ç†
   - ç‚¹å‡» `æ·»åŠ å›¾åƒ/æ–‡æ¡£`
   - é€‰æ‹©æ–‡ä»¶ä¸Šä¼ 
   - ç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
     - åˆ†é…åˆ°å¯¹åº”ç«™ç‚¹çš„é›†åˆ
     - ä½¿ç”¨æ ‡å‡†åŒ–çš„å­˜å‚¨è·¯å¾„ï¼š`aivoya/{site}/{collection}/{year}/{month}/originals/{hash}.ext`

2. **æ–‡ä»¶å­˜å‚¨ä½ç½®**

   ```
   å…¬å…±æ–‡ä»¶: idp-media-prod-public æ¡¶
   ç§æœ‰æ–‡ä»¶: idp-media-prod-private æ¡¶

   è·¯å¾„æ ¼å¼: aivoya/beijing/beijing-media/2025/01/originals/abc123.jpg
   ```

### è®¿é—®æƒé™

- **ç¼–è¾‘åªèƒ½çœ‹åˆ°å’Œä½¿ç”¨è‡ªå·±ç«™ç‚¹çš„åª’ä½“æ–‡ä»¶**
- **ä¸åŒç«™ç‚¹çš„æ–‡ä»¶å®Œå…¨éš”ç¦»**
- **æ”¯æŒæŒ‰é›†åˆè¿›ä¸€æ­¥ç»†åˆ†æƒé™**

## ğŸ”— API ä½¿ç”¨

### 1. ç§æœ‰æ–‡ä»¶ä¸‹è½½

è·å–ç§æœ‰æ–‡ä»¶çš„é¢„ç­¾åä¸‹è½½é“¾æ¥ï¼š

```bash
# è·å–æ–‡ä»¶ä¸‹è½½é“¾æ¥
curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:8000/api/media/presign-download/aivoya/beijing/docs/2025/01/originals/document.pdf/

# å“åº”ç¤ºä¾‹
{
  "url": "http://localhost:9002/idp-media-prod-private/aivoya/beijing/docs/2025/01/originals/document.pdf?X-Amz-Algorithm=...",
  "expires_in": 600,
  "key": "aivoya/beijing/docs/2025/01/originals/document.pdf"
}
```

### 2. ç§æœ‰æ–‡ä»¶ä¸Šä¼ 

è·å–ç§æœ‰æ–‡ä»¶çš„é¢„ç­¾åä¸Šä¼ é“¾æ¥ï¼š

```bash
# è¯·æ±‚ä¸Šä¼ é“¾æ¥
curl -X POST \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -d '{
       "filename": "confidential.pdf",
       "content_type": "application/pdf",
       "site": "beijing"
     }' \
     http://localhost:8000/api/media/presign-upload/

# å“åº”ç¤ºä¾‹
{
  "upload_url": "http://localhost:9002/idp-media-prod-private",
  "fields": {
    "key": "aivoya/beijing/default/2025/01/originals/abc123.pdf",
    "Content-Type": "application/pdf"
  },
  "key": "aivoya/beijing/default/2025/01/originals/abc123.pdf",
  "expires_in": 3600
}
```

### 3. æ–‡ä»¶ä¿¡æ¯æŸ¥è¯¢

```bash
# è·å–æ–‡ä»¶å…ƒæ•°æ®
curl -H "Authorization: Bearer YOUR_TOKEN" \
     http://localhost:8000/api/media/file-info/aivoya/beijing/docs/2025/01/originals/document.pdf/

# å“åº”ç¤ºä¾‹
{
  "key": "aivoya/beijing/docs/2025/01/originals/document.pdf",
  "size": 1048576,
  "content_type": "application/pdf",
  "last_modified": "2025-01-15T10:30:00Z",
  "etag": "abc123def456"
}
```

## ğŸ› ï¸ ç®¡ç†å‘½ä»¤

### åª’ä½“é›†åˆç®¡ç†

```bash
# åˆ›å»ºæ‰€æœ‰ç«™ç‚¹çš„é›†åˆå’Œæƒé™
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py setup_media_collections

# åªä¸ºç‰¹å®šç«™ç‚¹åˆ›å»º
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py setup_media_collections --site beijing

# é¢„è§ˆæ“ä½œï¼ˆä¸å®é™…æ‰§è¡Œï¼‰
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py setup_media_collections --dry-run
```

### MinIO ç”Ÿå‘½å‘¨æœŸé…ç½®

```bash
# é…ç½®æ‰€æœ‰æ¡¶çš„ç”Ÿå‘½å‘¨æœŸè§„åˆ™
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py setup_minio_lifecycle

# åªé…ç½®å…¬å…±æ¡¶
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py setup_minio_lifecycle --bucket public

# é¢„è§ˆé…ç½®
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py setup_minio_lifecycle --dry-run
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### æŸ¥çœ‹å­˜å‚¨ç»Ÿè®¡

```bash
# ç”Ÿæˆå­˜å‚¨ç»Ÿè®¡æŠ¥å‘Š
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py shell -c "
from apps.media.tasks import generate_storage_stats
import json
result = generate_storage_stats()
print(json.dumps(result['stats'], indent=2))
"
```

### æ‰‹åŠ¨æ¸…ç†ä»»åŠ¡

```bash
# æ¸…ç†å­¤å„¿æ–‡ä»¶
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py shell -c "
from apps.media.tasks import cleanup_orphan_files
result = cleanup_orphan_files()
print(f'æ¸…ç†å®Œæˆ: {result}')
"

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
docker compose -f infra/local/docker-compose.yaml exec authoring \
  python manage.py shell -c "
from apps.media.tasks import cleanup_temp_files
result = cleanup_temp_files()
print(f'æ¸…ç†å®Œæˆ: {result}')
"
```

### Celery ä»»åŠ¡ç›‘æ§

```bash
# æŸ¥çœ‹ Celery ä»»åŠ¡çŠ¶æ€
docker compose -f infra/local/docker-compose.yaml exec authoring \
  celery -A config inspect active

# æŸ¥çœ‹å®šæ—¶ä»»åŠ¡
docker compose -f infra/local/docker-compose.yaml exec authoring \
  celery -A config inspect scheduled
```

## ğŸ—‚ï¸ æ–‡ä»¶ç»„ç»‡ç»“æ„

### å­˜å‚¨æ¡¶ç»“æ„

```
idp-media-prod-public/          # å…¬å…±æ–‡ä»¶æ¡¶
â”œâ”€â”€ aivoya/
â”‚   â”œâ”€â”€ portal/
â”‚   â”‚   â”œâ”€â”€ portal-media/
â”‚   â”‚   â”‚   â”œâ”€â”€ 2025/01/originals/
â”‚   â”‚   â”‚   â”œâ”€â”€ 2025/01/renditions/
â”‚   â”‚   â”‚   â””â”€â”€ 2025/01/tmp/
â”‚   â”œâ”€â”€ beijing/
â”‚   â”‚   â”œâ”€â”€ beijing-media/
â”‚   â”‚   â”‚   â”œâ”€â”€ 2025/01/originals/
â”‚   â”‚   â”‚   â””â”€â”€ 2025/01/renditions/
â”‚   â””â”€â”€ shanghai/...

idp-media-prod-private/         # ç§æœ‰æ–‡ä»¶æ¡¶
â”œâ”€â”€ aivoya/
â”‚   â”œâ”€â”€ portal/...
â”‚   â”œâ”€â”€ beijing/...
â”‚   â””â”€â”€ shanghai/...
```

### é›†åˆæƒé™æ˜ å°„

| ç«™ç‚¹     | é›†åˆåç§°       | ç”¨æˆ·ç»„           | æƒé™èŒƒå›´          |
| -------- | -------------- | ---------------- | ----------------- |
| Portal   | Portal Media   | Portal Editors   | å¢åˆ æ”¹æŸ¥å›¾ç‰‡/æ–‡æ¡£ |
| Beijing  | Beijing Media  | Beijing Editors  | å¢åˆ æ”¹æŸ¥å›¾ç‰‡/æ–‡æ¡£ |
| Shanghai | Shanghai Media | Shanghai Editors | å¢åˆ æ”¹æŸ¥å›¾ç‰‡/æ–‡æ¡£ |
| Hangzhou | Hangzhou Media | Hangzhou Editors | å¢åˆ æ”¹æŸ¥å›¾ç‰‡/æ–‡æ¡£ |
| Shenzhen | Shenzhen Media | Shenzhen Editors | å¢åˆ æ”¹æŸ¥å›¾ç‰‡/æ–‡æ¡£ |

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ä¸Šä¼ å¤±è´¥**

   ```bash
   # æ£€æŸ¥ MinIO è¿æ¥
   docker compose -f infra/local/docker-compose.yaml exec authoring \
     python manage.py shell -c "
   from apps.core.storages import PublicMediaStorage
   storage = PublicMediaStorage()
   print('Storage connection OK')
   "
   ```

2. **æƒé™é—®é¢˜**

   ```bash
   # é‡æ–°è®¾ç½®æƒé™
   docker compose -f infra/local/docker-compose.yaml exec authoring \
     python manage.py setup_media_collections
   ```

3. **Celery ä»»åŠ¡ä¸æ‰§è¡Œ**
   ```bash
   # é‡å¯ Celery æœåŠ¡
   docker compose -f infra/local/docker-compose.yaml restart celery celery-beat
   ```

### æ—¥å¿—æŸ¥çœ‹

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
docker compose -f infra/local/docker-compose.yaml logs -f authoring

# æŸ¥çœ‹ Celery æ—¥å¿—
docker compose -f infra/local/docker-compose.yaml logs -f celery

# æŸ¥çœ‹ MinIO æ—¥å¿—
docker compose -f infra/local/docker-compose.yaml logs -f minio
```

## ğŸ“š æ›´å¤šèµ„æº

- **æŠ€æœ¯æ–‡æ¡£**: `docs/TODO/Media Solution.md`
- **æ¶æ„è®¾è®¡**: `docs/TODO/Media.md`
- **API æ–‡æ¡£**: `http://localhost:8000/api/media/` (å¼€å‘ä¸­)
- **ç®¡ç†åå°**: `http://localhost:8000/admin/`
- **MinIO æ§åˆ¶å°**: `http://localhost:9001/`

---

## ğŸ¯ æœ€ä½³å®è·µ

1. **å®šæœŸå¤‡ä»½é‡è¦æ–‡ä»¶**
2. **ç›‘æ§å­˜å‚¨ä½¿ç”¨é‡**
3. **å®šæœŸæ¸…ç†ä¸´æ—¶æ–‡ä»¶**
4. **ä¸ºä¸åŒç±»å‹æ–‡ä»¶ä½¿ç”¨åˆé€‚çš„é›†åˆ**
5. **éµå¾ªå‘½åè§„èŒƒ**
6. **åŠæ—¶æ›´æ–°æƒé™é…ç½®**

è¯¥åª’ä½“ç®¡ç†ç³»ç»Ÿç°å·²å®Œå…¨å°±ç»ªï¼Œå¯æ”¯æŒç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼ğŸš€
