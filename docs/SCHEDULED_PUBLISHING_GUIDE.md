# ⏰ 定时发布功能使用指南

## 📋 功能概述

定时发布功能允许编辑提前准备文章内容，设置在指定时间自动发布。这对于：
- 📅 **定时新闻发布** - 提前准备重要新闻，在指定时间发布
- 🌙 **非工作时间发布** - 晚上或周末自动发布内容
- 📊 **内容规划** - 提前安排一周的发布计划
- 🎯 **营销活动** - 配合营销活动时间点发布

---

## 🎯 使用方法

### 1️⃣ 创建定时发布文章

#### **步骤1：创建或编辑文章**
1. 登录Wagtail后台：`http://8.133.22.7:8000/admin/`
2. 点击左侧菜单 **"页面"** → 选择 **"News Articles"**
3. 点击 **"添加子页面"** → 选择 **"Article Page"**

#### **步骤2：填写文章内容**
- 标题、摘要、封面、正文等基本信息
- 选择频道、分类、标签等

#### **步骤3：设置定时发布时间**
1. 展开 **"📢 发布设置"** 面板
2. 在 **"发布时间"** 字段中选择未来的时间
   - 点击时钟图标打开日期时间选择器
   - 选择年、月、日、时、分
   - 确保选择的是**未来的时间**

#### **步骤4：保存为草稿**
1. 点击页面底部的 **"保存草稿"** 按钮（不要点击"发布"）
2. 文章将保存为草稿状态，等待定时发布

---

### 2️⃣ 查看定时发布文章

#### **在"我的文章"页面查看**
1. 点击左侧菜单 **"我的文章"**
2. 定时发布的文章会显示：
   - 🟦 **蓝色徽章**：⏰ 定时发布: mm-dd HH:MM
   - 状态：草稿（未发布）

#### **在"文章管理"页面查看**
1. 点击左侧菜单 **"文章管理"**
2. 点击 **"草稿"** 标签
3. 定时发布的文章会显示发布时间

---

### 3️⃣ 修改定时发布时间

1. 进入文章编辑页面
2. 展开 **"📢 发布设置"** 面板
3. 修改 **"发布时间"** 字段
4. 点击 **"保存草稿"**

💡 **提示**：
- 如果改为**过去的时间**或**留空**，文章将不再定时发布
- 需要手动点击"发布"按钮才能发布

---

### 4️⃣ 取消定时发布

#### **方法1：清空发布时间**
1. 进入文章编辑页面
2. 展开 **"📢 发布设置"** 面板
3. **清空** "发布时间" 字段
4. 点击 **"保存草稿"**

#### **方法2：手动发布**
1. 进入文章编辑页面
2. 直接点击 **"发布"** 按钮
3. 文章立即发布，不再等待定时发布

---

## 🤖 自动发布机制

### 工作原理
- ⏱️ **Celery Beat** 定时任务每**1分钟**检查一次
- 🔍 查找所有满足条件的文章：
  - ❌ 未发布（草稿状态）
  - ⏰ 设置了发布时间
  - ✅ 发布时间已到或已过
- 🚀 自动发布这些文章

### 发布精度
- **检查频率**：每1分钟
- **时间精度**：±1分钟内
- **示例**：设置 10:30 发布，实际发布时间在 10:30-10:31 之间

### 日志记录
所有自动发布操作都会记录日志：
```bash
# 查看Celery日志
ssh root@8.133.22.7
cd /opt/idp-cms
docker compose -f infra/production/docker-compose-ha-node1.yml logs -f celery-beat
```

---

## 📊 监控与管理

### 查看定时任务状态
```bash
# 登录服务器
ssh root@8.133.22.7

# 查看Celery Beat日志
docker compose -f infra/production/docker-compose-ha-node1.yml logs celery-beat --tail=50

# 查看Celery Worker日志
docker compose -f infra/production/docker-compose-ha-node1.yml logs celery --tail=50
```

### 手动触发定时发布任务
```bash
# 进入authoring容器
docker exec -it node1-authoring bash

# 手动执行定时发布任务
python manage.py shell
>>> from apps.news.tasks import publish_scheduled_articles
>>> result = publish_scheduled_articles()
>>> print(result)
>>> exit()
```

---

## ⚠️ 注意事项

### ❗ 重要提醒

1. **必须保存为草稿**
   - 设置定时发布后，必须点击 **"保存草稿"**，不要点击"发布"
   - 如果点击"发布"，文章会立即发布，不会等待定时发布

2. **时间必须是未来时间**
   - 发布时间必须大于当前时间
   - 如果设置为过去时间，文章将在下次检查时立即发布

3. **Celery服务必须运行**
   - 确保 `celery-beat` 和 `celery` 容器正常运行
   - 如果服务停止，定时发布将不会执行

4. **时区注意**
   - 系统使用服务器时区（通常是 UTC+8）
   - 确认设置的时间是正确的时区

### 🐛 常见问题

#### **Q1: 文章没有在设置的时间发布**
**解决方法**：
1. 检查 Celery Beat 是否运行：
   ```bash
   docker compose -f infra/production/docker-compose-ha-node1.yml ps celery-beat
   ```
2. 查看日志是否有错误：
   ```bash
   docker compose -f infra/production/docker-compose-ha-node1.yml logs celery-beat --tail=100
   ```
3. 检查文章是否仍是草稿状态

#### **Q2: 如何知道文章是否会定时发布**
**查看方法**：
- 在"我的文章"页面，定时发布的文章会显示蓝色的 **⏰ 定时发布: xx-xx XX:XX** 徽章
- 如果只显示 **"草稿"**，说明没有设置定时发布或时间已过

#### **Q3: 可以设置定时取消发布吗**
**回答**：
- 当前版本不支持定时取消发布
- 只支持定时发布草稿文章
- 如需取消发布，需要手动操作

---

## 🔧 技术细节

### 数据库字段
- `publish_at`: DateTimeField - 发布时间
- `live`: Boolean - 是否已发布
- `first_published_at`: DateTimeField - 首次发布时间（自动）

### Celery任务
- **任务名称**: `news.publish_scheduled_articles`
- **执行频率**: 每60秒
- **任务文件**: `/opt/idp-cms/apps/news/tasks.py`

### 配置文件
- **Celery配置**: `/opt/idp-cms/config/celery.py`
- **定时任务配置**: `app.conf.beat_schedule`

---

## 📈 最佳实践

### 1. **提前准备内容**
- 在发布前几小时或几天准备好文章
- 给自己留出检查和修改的时间

### 2. **批量设置定时发布**
- 一次性准备多篇文章
- 设置不同的发布时间，形成发布节奏

### 3. **定期检查**
- 每天检查"我的文章"页面
- 确认定时发布的文章状态

### 4. **测试流程**
- 首次使用时，先测试一个短时间的定时发布（如5分钟后）
- 确认功能正常后再用于正式内容

---

## 📞 技术支持

如果遇到问题，请：
1. 查看本文档的"常见问题"部分
2. 检查Celery日志
3. 联系系统管理员

---

**更新时间**: 2024-11-07  
**版本**: 1.0

