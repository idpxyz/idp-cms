# IDP-CMS 技术架构详细说明

## 🏗️ 系统架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端层                                  │
├─────────────────────────────────────────────────────────────────┤
│  Web浏览器  │  移动应用  │  第三方系统  │  API客户端            │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       负载均衡层                                │
├─────────────────────────────────────────────────────────────────┤
│  Nginx/HAProxy  │  Cloudflare CDN  │  健康检查               │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Web应用层                                 │
├─────────────────────────────────────────────────────────────────┤
│  Django + Wagtail  │  Gunicorn  │  ASGI/WSGI               │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        API网关层                                │
├─────────────────────────────────────────────────────────────────┤
│  限流控制  │  认证授权  │  请求路由  │  响应缓存              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       业务逻辑层                                │
├─────────────────────────────────────────────────────────────────┤
│  核心模块  │  新闻模块  │  搜索模块  │  API模块               │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       数据访问层                                │
├─────────────────────────────────────────────────────────────────┤
│  ORM  │  查询优化  │  连接池  │  事务管理                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       数据存储层                                │
├─────────────────────────────────────────────────────────────────┤
│  PostgreSQL  │  Redis  │  MinIO  │  OpenSearch              │
└─────────────────────────────────────────────────────────────────┘
```

## 🔧 核心技术组件详解

### 1. Web 应用层 (Django + Wagtail)

#### Django 5.2 特性

- **异步支持**: 完整的 ASGI 支持，异步视图和中间件
- **性能优化**: 查询优化器、连接池管理
- **安全特性**: CSRF、XSS、SQL 注入防护
- **国际化**: 多语言支持和本地化

#### Wagtail 7.1 特性

- **内容管理**: 强大的页面和片段管理
- **媒体管理**: 图片、文档、视频管理
- **工作流**: 内容审核和发布流程
- **搜索**: 内置全文搜索功能

### 2. API 网关层

#### 限流控制

```python
# 基于Redis的滑动窗口限流
@endpoint_rate_limit("articles", limit=1000, window=3600)
def articles_list(request):
    # 实现逻辑
    pass
```

#### 认证授权

- **JWT Token**: 无状态认证
- **OAuth2**: 第三方应用授权
- **RBAC**: 基于角色的权限控制

#### 请求路由

- **智能路由**: 基于域名和路径的路由
- **负载均衡**: 请求分发和负载均衡
- **健康检查**: 服务健康状态监控

### 3. 业务逻辑层

#### 核心模块 (apps.core)

```python
# 站点配置管理
class SiteSettings(models.Model):
    site = models.OneToOneField('wagtailcore.Site', on_delete=models.CASCADE)
    brand_name = models.CharField(max_length=100)
    theme = models.CharField(max_length=50)
    custom_config = models.JSONField(default=dict)

    # 动态配置支持
    def get_for_site(site):
        # 智能配置获取逻辑
        pass
```

#### 新闻模块 (apps.news)

```python
# 文章模型
class ArticlePage(Page):
    channel = models.ForeignKey('core.Channel', on_delete=models.SET_NULL)
    region = models.ForeignKey('core.Region', on_delete=models.SET_NULL)

    # 性能优化
    class Meta:
        indexes = [
            models.Index(fields=['channel', 'region']),
            models.Index(fields=['publish_at']),
        ]
```

#### 搜索模块 (apps.searchapp)

- **OpenSearch 集成**: 高性能全文搜索
- **智能推荐**: 基于用户行为的推荐算法
- **搜索优化**: 搜索结果排序和过滤

### 4. 数据访问层

#### ORM 优化

```python
# 避免N+1查询
queryset = ArticlePage.objects.live().filter(
    sites_rooted_here=site
).select_related(
    'channel', 'region'
).prefetch_related(
    'tags'
)

# 分页优化
total_count = queryset.count()  # 只计算一次
articles = queryset[start:end]
```

#### 连接池管理

```python
# 数据库连接池配置
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'CONN_MAX_AGE': 600,  # 连接复用
        'OPTIONS': {
            'MAX_CONNS': 20,   # 最大连接数
        }
    }
}
```

### 5. 数据存储层

#### PostgreSQL 15

- **JSON 字段支持**: 灵活的配置存储
- **全文搜索**: 内置全文搜索功能
- **分区表**: 大表分区优化
- **并行查询**: 多核查询优化

#### Redis 缓存

```python
# 缓存策略
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.redis.RedisCache',
        'LOCATION': 'redis://redis:6379/1',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}
```

## 🚀 性能优化策略

### 1. 数据库查询优化

#### 索引策略

```sql
-- 复合索引
CREATE INDEX idx_article_channel_region ON news_articlepage(channel_id, region_id);

-- 部分索引
CREATE INDEX idx_article_published ON news_articlepage(publish_at)
WHERE live = true;

-- 函数索引
CREATE INDEX idx_article_title_lower ON news_articlepage(LOWER(title));
```

#### 查询优化

```python
# 批量查询优化
def get_articles_with_relations(article_ids):
    articles = ArticlePage.objects.filter(id__in=article_ids)
    channels = Channel.objects.filter(
        id__in=articles.values_list('channel_id', flat=True)
    )
    regions = Region.objects.filter(
        id__in=articles.values_list('region_id', flat=True)
    )

    # 构建查找字典
    channel_dict = {c.id: c for c in channels}
    region_dict = {r.id: r for r in regions}

    return articles, channel_dict, region_dict
```

### 2. 缓存优化策略

#### 多层缓存架构

```
客户端缓存 (浏览器) → CDN缓存 → 应用缓存 → 数据库缓存
```

#### 智能缓存失效

```python
def generate_surrogate_keys(site, articles):
    """生成智能缓存标签"""
    keys = [f"site:{site.hostname}"]

    for article in articles:
        keys.extend([
            f"page:{article.id}",
            f"channel:{article.channel.slug}",
            f"region:{article.region.slug}",
            f"time:{article.publish_at.date()}"
        ])

    return keys
```

### 3. API 响应优化

#### 响应压缩

```python
# Gzip压缩中间件
MIDDLEWARE = [
    'django.middleware.gzip.GZipMiddleware',
    # ... 其他中间件
]
```

#### 字段过滤

```python
def apply_field_filtering(data, fields):
    """应用字段过滤"""
    if not fields:
        return data

    filtered_data = {}
    for field in fields:
        if field in data:
            filtered_data[field] = data[field]

    return filtered_data
```

## 🔒 安全防护体系

### 1. API 安全

#### 限流算法

```python
def rate_limit(limit=100, window=3600):
    """滑动窗口限流"""
    def decorator(view_func):
        def wrapped_view(request, *args, **kwargs):
            # 生成限流键
            rate_key = f"rate_limit:{get_user_identifier(request)}"

            # 获取当前计数
            current_count = cache.get(rate_key, 0)

            if current_count >= limit:
                return Response(
                    {"error": "Rate limit exceeded"},
                    status=status.HTTP_429_TOO_MANY_REQUESTS
                )

            # 增加计数
            cache.set(rate_key, current_count + 1, window)
            return view_func(request, *args, **kwargs)

        return wrapped_view
    return decorator
```

#### 安全响应头

```python
# 安全中间件
class SecurityHeadersMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        response = self.get_response(request)

        # 安全头设置
        response['X-Content-Type-Options'] = 'nosniff'
        response['X-Frame-Options'] = 'DENY'
        response['X-XSS-Protection'] = '1; mode=block'
        response['Referrer-Policy'] = 'same-origin'

        return response
```

### 2. 数据安全

#### SQL 注入防护

```python
# 使用参数化查询
def get_articles_by_channel(channel_slug):
    return ArticlePage.objects.filter(
        channel__slug=channel_slug,  # 自动转义
        live=True
    )

# 避免原始SQL
# 错误示例: ArticlePage.objects.raw(f"SELECT * FROM news_articlepage WHERE channel_slug = '{channel_slug}'")
```

#### XSS 防护

```python
# 内容安全策略
CSP_DEFAULT_SRC = ("'self'",)
CSP_STYLE_SRC = ("'self'", "'unsafe-inline'")
CSP_SCRIPT_SRC = ("'self'",)
CSP_IMG_SRC = ("'self'", "data:", "https:")

# 自动转义
from django.utils.html import escape
content = escape(user_input)
```

## 🌐 多站点架构实现

### 1. 站点隔离

#### 数据隔离

```python
class SiteSpecificManager(models.Manager):
    """站点特定管理器"""
    def get_queryset(self):
        return super().get_queryset().filter(
            sites_rooted_here=get_current_site()
        )

class ArticlePage(Page):
    objects = SiteSpecificManager()

    class Meta:
        # 每个站点独立的内容
        unique_together = [('slug', 'sites_rooted_here')]
```

#### 配置隔离

```python
def get_site_config(site):
    """获取站点特定配置"""
    try:
        return SiteSettings.objects.get(site=site)
    except SiteSettings.DoesNotExist:
        # 返回默认配置
        return SiteSettings(
            site=site,
            theme="default",
            brand_name=site.site_name
        )
```

### 2. 内容分发

#### 智能路由

```python
class SiteMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # 基于域名识别站点
        hostname = request.get_host().split(':')[0]
        try:
            site = Site.objects.get(hostname=hostname)
            request.site = site
        except Site.DoesNotExist:
            request.site = Site.objects.get(is_default_site=True)

        return self.get_response(request)
```

#### 缓存标签

```python
def get_cache_tags_for_site(site):
    """获取站点缓存标签"""
    return [
        f"site:{site.hostname}",
        f"config:{site.id}",
        f"theme:{site.theme}",
        f"brand:{site.brand_name}"
    ]
```

## 📊 监控和运维

### 1. 性能监控

#### 缓存性能监控

```python
class CachePerformanceMonitor:
    def __init__(self):
        self.stats = {
            'total_requests': 0,
            'cache_hits': 0,
            'cache_misses': 0,
            'response_times': [],
            'endpoints': defaultdict(dict)
        }

    def record_request(self, endpoint, response_time, cache_hit=True):
        """记录请求统计"""
        self.stats['total_requests'] += 1
        if cache_hit:
            self.stats['cache_hits'] += 1
        else:
            self.stats['cache_misses'] += 1

        self.stats['response_times'].append(response_time)
```

#### 数据库性能监控

```python
# Django Debug Toolbar
INSTALLED_APPS = [
    'debug_toolbar',
]

MIDDLEWARE = [
    'debug_toolbar.middleware.DebugToolbarMiddleware',
]

# 查询日志
LOGGING = {
    'loggers': {
        'django.db.backends': {
            'level': 'DEBUG',
            'handlers': ['console'],
        },
    },
}
```

### 2. 健康检查

#### 系统健康检查

```python
@api_view(["GET"])
def health_check(request):
    """系统健康检查"""
    checks = {
        'database': check_database_connection(),
        'cache': check_cache_connection(),
        'storage': check_storage_connection(),
        'search': check_search_connection(),
    }

    overall_status = 'healthy' if all(checks.values()) else 'unhealthy'

    return Response({
        'status': overall_status,
        'checks': checks,
        'timestamp': timezone.now().isoformat()
    })
```

## 🔮 扩展性和未来规划

### 1. 微服务架构

#### 服务拆分策略

```
当前架构 → 微服务架构
├── 用户服务 (认证、权限)
├── 内容服务 (文章、媒体)
├── 搜索服务 (全文搜索、推荐)
├── 配置服务 (站点配置、主题)
└── 通知服务 (消息推送、邮件)
```

#### 服务通信

```python
# 异步消息队列
from celery import Celery

app = Celery('idp_cms')

@app.task
def process_article_update(article_id):
    """异步处理文章更新"""
    # 更新搜索索引
    update_search_index(article_id)
    # 清除相关缓存
    clear_related_cache(article_id)
    # 发送通知
    send_update_notification(article_id)
```

### 2. 云原生支持

#### Kubernetes 部署

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: idp-cms-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: idp-cms-api
  template:
    metadata:
      labels:
        app: idp-cms-api
    spec:
      containers:
        - name: api
          image: idp-cms:latest
          ports:
            - containerPort: 8000
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: db-secret
                  key: url
```

#### 自动扩缩容

```yaml
# hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: idp-cms-api-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: idp-cms-api
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
```

---

_本文档详细展示了 IDP-CMS 项目的技术架构设计、实现细节和优化策略，体现了我们在系统设计、性能优化、安全防护、可扩展性等各个方面的深度考虑和专业能力。_
