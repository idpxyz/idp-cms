# IDP-CMS æŠ€æœ¯æ¶æ„è¯¦ç»†è¯´æ˜

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å®¢æˆ·ç«¯å±‚                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Webæµè§ˆå™¨  â”‚  ç§»åŠ¨åº”ç”¨  â”‚  ç¬¬ä¸‰æ–¹ç³»ç»Ÿ  â”‚  APIå®¢æˆ·ç«¯            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       è´Ÿè½½å‡è¡¡å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Nginx/HAProxy  â”‚  Cloudflare CDN  â”‚  å¥åº·æ£€æŸ¥               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Webåº”ç”¨å±‚                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Django + Wagtail  â”‚  Gunicorn  â”‚  ASGI/WSGI               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        APIç½‘å…³å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é™æµæ§åˆ¶  â”‚  è®¤è¯æˆæƒ  â”‚  è¯·æ±‚è·¯ç”±  â”‚  å“åº”ç¼“å­˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ä¸šåŠ¡é€»è¾‘å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ ¸å¿ƒæ¨¡å—  â”‚  æ–°é—»æ¨¡å—  â”‚  æœç´¢æ¨¡å—  â”‚  APIæ¨¡å—               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®è®¿é—®å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ORM  â”‚  æŸ¥è¯¢ä¼˜åŒ–  â”‚  è¿æ¥æ±   â”‚  äº‹åŠ¡ç®¡ç†                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®å­˜å‚¨å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PostgreSQL  â”‚  Redis  â”‚  MinIO  â”‚  OpenSearch              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯ç»„ä»¶è¯¦è§£

### 1. Web åº”ç”¨å±‚ (Django + Wagtail)

#### Django 5.2 ç‰¹æ€§

- **å¼‚æ­¥æ”¯æŒ**: å®Œæ•´çš„ ASGI æ”¯æŒï¼Œå¼‚æ­¥è§†å›¾å’Œä¸­é—´ä»¶
- **æ€§èƒ½ä¼˜åŒ–**: æŸ¥è¯¢ä¼˜åŒ–å™¨ã€è¿æ¥æ± ç®¡ç†
- **å®‰å…¨ç‰¹æ€§**: CSRFã€XSSã€SQL æ³¨å…¥é˜²æŠ¤
- **å›½é™…åŒ–**: å¤šè¯­è¨€æ”¯æŒå’Œæœ¬åœ°åŒ–

#### Wagtail 7.1 ç‰¹æ€§

- **å†…å®¹ç®¡ç†**: å¼ºå¤§çš„é¡µé¢å’Œç‰‡æ®µç®¡ç†
- **åª’ä½“ç®¡ç†**: å›¾ç‰‡ã€æ–‡æ¡£ã€è§†é¢‘ç®¡ç†
- **å·¥ä½œæµ**: å†…å®¹å®¡æ ¸å’Œå‘å¸ƒæµç¨‹
- **æœç´¢**: å†…ç½®å…¨æ–‡æœç´¢åŠŸèƒ½

### 2. API ç½‘å…³å±‚

#### é™æµæ§åˆ¶

```python
# åŸºäºRedisçš„æ»‘åŠ¨çª—å£é™æµ
@endpoint_rate_limit("articles", limit=1000, window=3600)
def articles_list(request):
    # å®ç°é€»è¾‘
    pass
```

#### è®¤è¯æˆæƒ

- **JWT Token**: æ— çŠ¶æ€è®¤è¯
- **OAuth2**: ç¬¬ä¸‰æ–¹åº”ç”¨æˆæƒ
- **RBAC**: åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶

#### è¯·æ±‚è·¯ç”±

- **æ™ºèƒ½è·¯ç”±**: åŸºäºåŸŸåå’Œè·¯å¾„çš„è·¯ç”±
- **è´Ÿè½½å‡è¡¡**: è¯·æ±‚åˆ†å‘å’Œè´Ÿè½½å‡è¡¡
- **å¥åº·æ£€æŸ¥**: æœåŠ¡å¥åº·çŠ¶æ€ç›‘æ§

### 3. ä¸šåŠ¡é€»è¾‘å±‚

#### æ ¸å¿ƒæ¨¡å— (apps.core)

```python
# ç«™ç‚¹é…ç½®ç®¡ç†
class SiteSettings(models.Model):
    site = models.OneToOneField('wagtailcore.Site', on_delete=models.CASCADE)
    brand_name = models.CharField(max_length=100)
    theme = models.CharField(max_length=50)
    custom_config = models.JSONField(default=dict)

    # åŠ¨æ€é…ç½®æ”¯æŒ
    def get_for_site(site):
        # æ™ºèƒ½é…ç½®è·å–é€»è¾‘
        pass
```

#### æ–°é—»æ¨¡å— (apps.news)

```python
# æ–‡ç« æ¨¡å‹
class ArticlePage(Page):
    channel = models.ForeignKey('core.Channel', on_delete=models.SET_NULL)
    region = models.ForeignKey('core.Region', on_delete=models.SET_NULL)

    # æ€§èƒ½ä¼˜åŒ–
    class Meta:
        indexes = [
            models.Index(fields=['channel', 'region']),
            models.Index(fields=['publish_at']),
        ]
```

#### æœç´¢æ¨¡å— (apps.searchapp)

- **OpenSearch é›†æˆ**: é«˜æ€§èƒ½å…¨æ–‡æœç´¢
- **æ™ºèƒ½æ¨è**: åŸºäºç”¨æˆ·è¡Œä¸ºçš„æ¨èç®—æ³•
- **æœç´¢ä¼˜åŒ–**: æœç´¢ç»“æœæ’åºå’Œè¿‡æ»¤

### 4. æ•°æ®è®¿é—®å±‚

#### ORM ä¼˜åŒ–

```python
# é¿å…N+1æŸ¥è¯¢
queryset = ArticlePage.objects.live().filter(
    sites_rooted_here=site
).select_related(
    'channel', 'region'
).prefetch_related(
    'tags'
)

# åˆ†é¡µä¼˜åŒ–
total_count = queryset.count()  # åªè®¡ç®—ä¸€æ¬¡
articles = queryset[start:end]
```

#### è¿æ¥æ± ç®¡ç†

```python
# æ•°æ®åº“è¿æ¥æ± é…ç½®
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'CONN_MAX_AGE': 600,  # è¿æ¥å¤ç”¨
        'OPTIONS': {
            'MAX_CONNS': 20,   # æœ€å¤§è¿æ¥æ•°
        }
    }
}
```

### 5. æ•°æ®å­˜å‚¨å±‚

#### PostgreSQL 15

- **JSON å­—æ®µæ”¯æŒ**: çµæ´»çš„é…ç½®å­˜å‚¨
- **å…¨æ–‡æœç´¢**: å†…ç½®å…¨æ–‡æœç´¢åŠŸèƒ½
- **åˆ†åŒºè¡¨**: å¤§è¡¨åˆ†åŒºä¼˜åŒ–
- **å¹¶è¡ŒæŸ¥è¯¢**: å¤šæ ¸æŸ¥è¯¢ä¼˜åŒ–

#### Redis ç¼“å­˜

```python
# ç¼“å­˜ç­–ç•¥
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.redis.RedisCache',
        'LOCATION': 'redis://redis:6379/1',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

#### ç´¢å¼•ç­–ç•¥

```sql
-- å¤åˆç´¢å¼•
CREATE INDEX idx_article_channel_region ON news_articlepage(channel_id, region_id);

-- éƒ¨åˆ†ç´¢å¼•
CREATE INDEX idx_article_published ON news_articlepage(publish_at)
WHERE live = true;

-- å‡½æ•°ç´¢å¼•
CREATE INDEX idx_article_title_lower ON news_articlepage(LOWER(title));
```

#### æŸ¥è¯¢ä¼˜åŒ–

```python
# æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
def get_articles_with_relations(article_ids):
    articles = ArticlePage.objects.filter(id__in=article_ids)
    channels = Channel.objects.filter(
        id__in=articles.values_list('channel_id', flat=True)
    )
    regions = Region.objects.filter(
        id__in=articles.values_list('region_id', flat=True)
    )

    # æ„å»ºæŸ¥æ‰¾å­—å…¸
    channel_dict = {c.id: c for c in channels}
    region_dict = {r.id: r for r in regions}

    return articles, channel_dict, region_dict
```

### 2. ç¼“å­˜ä¼˜åŒ–ç­–ç•¥

#### å¤šå±‚ç¼“å­˜æ¶æ„

```
å®¢æˆ·ç«¯ç¼“å­˜ (æµè§ˆå™¨) â†’ CDNç¼“å­˜ â†’ åº”ç”¨ç¼“å­˜ â†’ æ•°æ®åº“ç¼“å­˜
```

#### æ™ºèƒ½ç¼“å­˜å¤±æ•ˆ

```python
def generate_surrogate_keys(site, articles):
    """ç”Ÿæˆæ™ºèƒ½ç¼“å­˜æ ‡ç­¾"""
    keys = [f"site:{site.hostname}"]

    for article in articles:
        keys.extend([
            f"page:{article.id}",
            f"channel:{article.channel.slug}",
            f"region:{article.region.slug}",
            f"time:{article.publish_at.date()}"
        ])

    return keys
```

### 3. API å“åº”ä¼˜åŒ–

#### å“åº”å‹ç¼©

```python
# Gzipå‹ç¼©ä¸­é—´ä»¶
MIDDLEWARE = [
    'django.middleware.gzip.GZipMiddleware',
    # ... å…¶ä»–ä¸­é—´ä»¶
]
```

#### å­—æ®µè¿‡æ»¤

```python
def apply_field_filtering(data, fields):
    """åº”ç”¨å­—æ®µè¿‡æ»¤"""
    if not fields:
        return data

    filtered_data = {}
    for field in fields:
        if field in data:
            filtered_data[field] = data[field]

    return filtered_data
```

## ğŸ”’ å®‰å…¨é˜²æŠ¤ä½“ç³»

### 1. API å®‰å…¨

#### é™æµç®—æ³•

```python
def rate_limit(limit=100, window=3600):
    """æ»‘åŠ¨çª—å£é™æµ"""
    def decorator(view_func):
        def wrapped_view(request, *args, **kwargs):
            # ç”Ÿæˆé™æµé”®
            rate_key = f"rate_limit:{get_user_identifier(request)}"

            # è·å–å½“å‰è®¡æ•°
            current_count = cache.get(rate_key, 0)

            if current_count >= limit:
                return Response(
                    {"error": "Rate limit exceeded"},
                    status=status.HTTP_429_TOO_MANY_REQUESTS
                )

            # å¢åŠ è®¡æ•°
            cache.set(rate_key, current_count + 1, window)
            return view_func(request, *args, **kwargs)

        return wrapped_view
    return decorator
```

#### å®‰å…¨å“åº”å¤´

```python
# å®‰å…¨ä¸­é—´ä»¶
class SecurityHeadersMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        response = self.get_response(request)

        # å®‰å…¨å¤´è®¾ç½®
        response['X-Content-Type-Options'] = 'nosniff'
        response['X-Frame-Options'] = 'DENY'
        response['X-XSS-Protection'] = '1; mode=block'
        response['Referrer-Policy'] = 'same-origin'

        return response
```

### 2. æ•°æ®å®‰å…¨

#### SQL æ³¨å…¥é˜²æŠ¤

```python
# ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
def get_articles_by_channel(channel_slug):
    return ArticlePage.objects.filter(
        channel__slug=channel_slug,  # è‡ªåŠ¨è½¬ä¹‰
        live=True
    )

# é¿å…åŸå§‹SQL
# é”™è¯¯ç¤ºä¾‹: ArticlePage.objects.raw(f"SELECT * FROM news_articlepage WHERE channel_slug = '{channel_slug}'")
```

#### XSS é˜²æŠ¤

```python
# å†…å®¹å®‰å…¨ç­–ç•¥
CSP_DEFAULT_SRC = ("'self'",)
CSP_STYLE_SRC = ("'self'", "'unsafe-inline'")
CSP_SCRIPT_SRC = ("'self'",)
CSP_IMG_SRC = ("'self'", "data:", "https:")

# è‡ªåŠ¨è½¬ä¹‰
from django.utils.html import escape
content = escape(user_input)
```

## ğŸŒ å¤šç«™ç‚¹æ¶æ„å®ç°

### 1. ç«™ç‚¹éš”ç¦»

#### æ•°æ®éš”ç¦»

```python
class SiteSpecificManager(models.Manager):
    """ç«™ç‚¹ç‰¹å®šç®¡ç†å™¨"""
    def get_queryset(self):
        return super().get_queryset().filter(
            sites_rooted_here=get_current_site()
        )

class ArticlePage(Page):
    objects = SiteSpecificManager()

    class Meta:
        # æ¯ä¸ªç«™ç‚¹ç‹¬ç«‹çš„å†…å®¹
        unique_together = [('slug', 'sites_rooted_here')]
```

#### é…ç½®éš”ç¦»

```python
def get_site_config(site):
    """è·å–ç«™ç‚¹ç‰¹å®šé…ç½®"""
    try:
        return SiteSettings.objects.get(site=site)
    except SiteSettings.DoesNotExist:
        # è¿”å›é»˜è®¤é…ç½®
        return SiteSettings(
            site=site,
            theme="default",
            brand_name=site.site_name
        )
```

### 2. å†…å®¹åˆ†å‘

#### æ™ºèƒ½è·¯ç”±

```python
class SiteMiddleware:
    def __init__(self, get_response):
        self.get_response = get_response

    def __call__(self, request):
        # åŸºäºåŸŸåè¯†åˆ«ç«™ç‚¹
        hostname = request.get_host().split(':')[0]
        try:
            site = Site.objects.get(hostname=hostname)
            request.site = site
        except Site.DoesNotExist:
            request.site = Site.objects.get(is_default_site=True)

        return self.get_response(request)
```

#### ç¼“å­˜æ ‡ç­¾

```python
def get_cache_tags_for_site(site):
    """è·å–ç«™ç‚¹ç¼“å­˜æ ‡ç­¾"""
    return [
        f"site:{site.hostname}",
        f"config:{site.id}",
        f"theme:{site.theme}",
        f"brand:{site.brand_name}"
    ]
```

## ğŸ“Š ç›‘æ§å’Œè¿ç»´

### 1. æ€§èƒ½ç›‘æ§

#### ç¼“å­˜æ€§èƒ½ç›‘æ§

```python
class CachePerformanceMonitor:
    def __init__(self):
        self.stats = {
            'total_requests': 0,
            'cache_hits': 0,
            'cache_misses': 0,
            'response_times': [],
            'endpoints': defaultdict(dict)
        }

    def record_request(self, endpoint, response_time, cache_hit=True):
        """è®°å½•è¯·æ±‚ç»Ÿè®¡"""
        self.stats['total_requests'] += 1
        if cache_hit:
            self.stats['cache_hits'] += 1
        else:
            self.stats['cache_misses'] += 1

        self.stats['response_times'].append(response_time)
```

#### æ•°æ®åº“æ€§èƒ½ç›‘æ§

```python
# Django Debug Toolbar
INSTALLED_APPS = [
    'debug_toolbar',
]

MIDDLEWARE = [
    'debug_toolbar.middleware.DebugToolbarMiddleware',
]

# æŸ¥è¯¢æ—¥å¿—
LOGGING = {
    'loggers': {
        'django.db.backends': {
            'level': 'DEBUG',
            'handlers': ['console'],
        },
    },
}
```

### 2. å¥åº·æ£€æŸ¥

#### ç³»ç»Ÿå¥åº·æ£€æŸ¥

```python
@api_view(["GET"])
def health_check(request):
    """ç³»ç»Ÿå¥åº·æ£€æŸ¥"""
    checks = {
        'database': check_database_connection(),
        'cache': check_cache_connection(),
        'storage': check_storage_connection(),
        'search': check_search_connection(),
    }

    overall_status = 'healthy' if all(checks.values()) else 'unhealthy'

    return Response({
        'status': overall_status,
        'checks': checks,
        'timestamp': timezone.now().isoformat()
    })
```

## ğŸ”® æ‰©å±•æ€§å’Œæœªæ¥è§„åˆ’

### 1. å¾®æœåŠ¡æ¶æ„

#### æœåŠ¡æ‹†åˆ†ç­–ç•¥

```
å½“å‰æ¶æ„ â†’ å¾®æœåŠ¡æ¶æ„
â”œâ”€â”€ ç”¨æˆ·æœåŠ¡ (è®¤è¯ã€æƒé™)
â”œâ”€â”€ å†…å®¹æœåŠ¡ (æ–‡ç« ã€åª’ä½“)
â”œâ”€â”€ æœç´¢æœåŠ¡ (å…¨æ–‡æœç´¢ã€æ¨è)
â”œâ”€â”€ é…ç½®æœåŠ¡ (ç«™ç‚¹é…ç½®ã€ä¸»é¢˜)
â””â”€â”€ é€šçŸ¥æœåŠ¡ (æ¶ˆæ¯æ¨é€ã€é‚®ä»¶)
```

#### æœåŠ¡é€šä¿¡

```python
# å¼‚æ­¥æ¶ˆæ¯é˜Ÿåˆ—
from celery import Celery

app = Celery('idp_cms')

@app.task
def process_article_update(article_id):
    """å¼‚æ­¥å¤„ç†æ–‡ç« æ›´æ–°"""
    # æ›´æ–°æœç´¢ç´¢å¼•
    update_search_index(article_id)
    # æ¸…é™¤ç›¸å…³ç¼“å­˜
    clear_related_cache(article_id)
    # å‘é€é€šçŸ¥
    send_update_notification(article_id)
```

### 2. äº‘åŸç”Ÿæ”¯æŒ

#### Kubernetes éƒ¨ç½²

```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: idp-cms-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: idp-cms-api
  template:
    metadata:
      labels:
        app: idp-cms-api
    spec:
      containers:
        - name: api
          image: idp-cms:latest
          ports:
            - containerPort: 8000
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: db-secret
                  key: url
```

#### è‡ªåŠ¨æ‰©ç¼©å®¹

```yaml
# hpa.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: idp-cms-api-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: idp-cms-api
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
```

---

_æœ¬æ–‡æ¡£è¯¦ç»†å±•ç¤ºäº† IDP-CMS é¡¹ç›®çš„æŠ€æœ¯æ¶æ„è®¾è®¡ã€å®ç°ç»†èŠ‚å’Œä¼˜åŒ–ç­–ç•¥ï¼Œä½“ç°äº†æˆ‘ä»¬åœ¨ç³»ç»Ÿè®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–ã€å®‰å…¨é˜²æŠ¤ã€å¯æ‰©å±•æ€§ç­‰å„ä¸ªæ–¹é¢çš„æ·±åº¦è€ƒè™‘å’Œä¸“ä¸šèƒ½åŠ›ã€‚_
