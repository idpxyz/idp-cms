# 🔐 定时发布功能 - 权限处理说明

**最后更新**: 2024-11-07  
**重要程度**: ⭐⭐⭐⭐⭐

---

## 🎯 核心逻辑

定时发布功能会根据**用户的发布权限**自动采取不同的处理方式：

| 用户权限 | 定时发布行为 | 结果 |
|---------|-------------|------|
| ✅ 有发布权限 | 自动发布文章 | 文章直接上线 |
| 🔐 无发布权限（有工作流） | 自动提交到工作流 | 等待审批 |
| ❌ 无发布权限（无工作流） | 跳过，清除定时发布时间 | 保持草稿状态 |

---

## 📋 权限检查规则

### ✅ 有发布权限的条件

满足以下**任一条件**即有发布权限：

1. **超级管理员** (`user.is_superuser = True`)
2. **有页面发布权限**:
   - 用户有 `wagtailadmin.access_admin` 权限
   - 且对该文章有 `publish` 权限

### 🔐 权限检查代码

```python
has_publish_permission = (
    user.is_superuser or
    user.has_perm('wagtailadmin.access_admin') and
    user.page_permissions.filter(
        page=article,
        permission_type='publish'
    ).exists()
)
```

---

## 🎭 不同用户角色的行为

### 角色1：超级管理员 (victory)
- ✅ **有发布权限**
- **行为**: 定时发布 → 自动发布
- **结果**: 文章直接上线

### 角色2：全频审发 (chensiyan, leo5122)
- ✅ **有发布权限**（Moderators组）
- **行为**: 定时发布 → 自动发布
- **结果**: 文章直接上线

### 角色3：频道编辑 (houad)
- 🔐 **无发布权限**（需要审批）
- **行为**: 定时发布 → 自动提交工作流
- **结果**: 进入审批流程，等待chensiyan或leo5122审批

---

## 📝 具体场景示例

### 场景1：houad 设置定时发布

#### 操作步骤
1. `houad` 创建文章
2. 设置发布时间：2024-11-08 10:00
3. 保存为草稿

#### 系统处理（到达10:00时）
```
1. 检查权限：houad 无发布权限
2. 查找工作流：存在"文章审批工作流"
3. 自动提交：提交到工作流
4. 清除定时发布时间
5. 记录日志：
   ⏳ 文章提交到工作流: ID=131004
   标题=《测试文章》
   作者=houad (无发布权限)
```

#### 最终结果
- 文章进入"审核中"状态
- chensiyan 或 leo5122 收到审批通知
- 审批通过后文章才会发布

---

### 场景2：chensiyan 设置定时发布

#### 操作步骤
1. `chensiyan` 创建文章
2. 设置发布时间：2024-11-08 10:00
3. 保存为草稿

#### 系统处理（到达10:00时）
```
1. 检查权限：chensiyan 有发布权限 (Moderators组)
2. 直接发布：调用 revision.publish()
3. 记录日志：
   ✅ 自动发布文章成功: ID=131005
   标题=《测试文章》
   作者=chensiyan
```

#### 最终结果
- 文章直接发布上线
- 无需审批流程

---

## 🔍 日志说明

### 成功发布（有权限）
```
✅ 自动发布文章成功: ID=131003
   标题=《测试文章》
   计划发布时间=2025-11-07 07:21:00+00:00
   作者=admin
```

### 提交工作流（无权限）
```
⏳ 文章提交到工作流: ID=131004
   标题=《测试文章》
   作者=houad (无发布权限)
```

### 跳过处理（无权限且无工作流）
```
⚠️ 跳过文章（用户无发布权限且无工作流）:
   ID=131005
   标题=《测试文章》
   作者=test_user
```

---

## 💡 用户提示

### 在编辑页面的提示文本

```
⏰ 定时发布功能
• 设置发布时间为未来时间后，保存为草稿
• 到达指定时间后，系统将根据您的权限自动处理：
  - 📝 有发布权限：自动发布文章
  - 🔐 无发布权限：自动提交到工作流审批
• 留空或设置为当前/过去时间，则可立即手动发布
💡 提示：适合提前准备内容，定时发布新闻
```

---

## 🎯 设计理念

### 1. 安全优先
- **不绕过权限检查**
- 严格遵守Wagtail的权限系统
- 无权限用户不能直接发布

### 2. 智能处理
- 有工作流：自动提交审批
- 无工作流：跳过处理，保持草稿

### 3. 透明可追溯
- 完整的日志记录
- 清晰的状态标识
- 方便问题排查

---

## 🧪 测试建议

### 测试用例1：有权限用户
```
用户：admin / chensiyan / leo5122
预期：文章自动发布
验证：文章状态变为"已发布"
```

### 测试用例2：无权限用户（有工作流）
```
用户：houad
预期：文章提交到工作流
验证：文章状态变为"审核中"
```

### 测试用例3：无权限用户（无工作流）
```
用户：test_user（假设）
预期：跳过处理，保持草稿
验证：定时发布时间被清除
```

---

## ⚠️ 注意事项

### 1. 工作流配置
- 确保需要审批的用户组已配置工作流
- 工作流任务指向正确的审批组

### 2. 权限配置
- 定期检查用户组权限
- 确保权限分配合理

### 3. 用户培训
- 告知用户不同权限的行为差异
- 提供清晰的使用指南

---

## 📊 权限配置参考

### 当前系统权限配置

| 用户组 | 用户 | 发布权限 | 定时发布行为 |
|-------|------|---------|------------|
| Administrators | victory | ✅ 是 | 自动发布 |
| Moderators | chensiyan, leo5122 | ✅ 是 | 自动发布 |
| Editors | houad | ❌ 否 | 提交工作流 |

---

## 🔮 未来改进

### 优先级：高
1. **权限预检**
   - 保存文章时提示用户是否有发布权限
   - 对无权限用户显示警告

2. **邮件通知**
   - 文章提交工作流时通知审批人
   - 审批通过后通知作者

### 优先级：中
3. **权限管理界面**
   - 可视化权限配置
   - 快速查看用户权限

4. **审批历史**
   - 记录所有审批操作
   - 支持权限审计

---

## 📞 技术支持

遇到权限问题时，请提供：
1. 用户名称和所属组
2. 文章ID
3. 设置的发布时间
4. 预期行为 vs 实际行为
5. 相关日志截图

---

**维护人员**: 系统管理员  
**审核状态**: ✅ 已实现并测试

