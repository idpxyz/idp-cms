# å¤šä¸»é¢˜æ¶æ„å®æ–½è®¡åˆ’

åŸºäº `docs/TODO/themes.md` çš„è®¾è®¡æ–¹æ¡ˆï¼Œæœ¬æ–‡æ¡£è¯¦ç»†è§„åˆ’å¤šä¸»é¢˜æ¶æ„çš„å®æ–½æ­¥éª¤ã€‚

## ğŸ¯ ç›®æ ‡æ¦‚è¿°

å®ç°ä¸€ä¸ªä¼ä¸šçº§çš„å¤šä¸»é¢˜ç³»ç»Ÿï¼Œæ”¯æŒï¼š

- ä¸»é¢˜åŠ¨æ€åˆ‡æ¢å’Œç‰ˆæœ¬ç®¡ç†
- ç«™ç‚¹çº§åˆ«çš„ä¸»é¢˜è‡ªå®šä¹‰
- æ¸è¿›å¼ä¸»é¢˜è¿ç§»
- ç°åº¦å‘å¸ƒå’Œå›æ»šæœºåˆ¶

## ğŸ“‚ ç›®æ ‡æ¶æ„

```
sites/
â”œâ”€â”€ themes/                    # ä¸»é¢˜åº“
â”‚   â”œâ”€â”€ portal/
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ index.ts       # ä¸»é¢˜å…¥å£
â”‚   â”‚       â”œâ”€â”€ tokens.ts      # è®¾è®¡ä»¤ç‰Œ
â”‚   â”‚       â””â”€â”€ layouts/       # å¸ƒå±€ç»„ä»¶
â”‚   â”œâ”€â”€ localsite-default/
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ index.ts
â”‚   â”‚       â”œâ”€â”€ tokens.ts
â”‚   â”‚       â””â”€â”€ layouts/
â”‚   â””â”€â”€ magazine/              # æœªæ¥æ‰©å±•ä¸»é¢˜
â”‚       â””â”€â”€ v2/
â”œâ”€â”€ base/                      # åŸºç¡€ç»„ä»¶åº“
â”‚   â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ layouts/
â”‚   â””â”€â”€ tokens/
â”œâ”€â”€ overrides/                 # ç«™ç‚¹ç‰¹å®šè¦†ç›–
â”‚   â”œâ”€â”€ shanghai.aivoya.com/
â”‚   â””â”€â”€ beijing.aivoya.com/
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ theme-registry.ts      # ä¸»é¢˜æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ theme-loader.ts        # ä¸»é¢˜åŠ è½½å™¨
â”‚   â””â”€â”€ tokens.ts             # ä»¤ç‰Œå·¥å…·
â””â”€â”€ app/
    â”œâ”€â”€ (portal)/             # é—¨æˆ·è·¯ç”±ç»„
    â”œâ”€â”€ (localsite)/          # åœ°æ–¹ç«™è·¯ç”±ç»„
    â””â”€â”€ layout.tsx            # æ ¹å¸ƒå±€
```

## ğŸ—“ï¸ å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ¶æ„ (3-4 å¤©)

#### 1.1 æ‰©å±• Wagtail SiteSettings æ¨¡å‹

**ç›®æ ‡**: æ·»åŠ ä¸»é¢˜ç›¸å…³å­—æ®µ
**æ–‡ä»¶**: `apps/sites/models.py`

```python
class SiteSettings(models.Model):
    # ç°æœ‰å­—æ®µ...

    # ä¸»é¢˜é…ç½®
    theme_key = models.CharField(max_length=64, default="localsite-default")
    theme_version = models.CharField(max_length=16, default="1.0.0")
    layout_key = models.CharField(max_length=64, default="layout-localsite-grid")
    brand_tokens = models.JSONField(default=dict, blank=True)
    modules = models.JSONField(default=dict, blank=True)
    customized = models.BooleanField(default=False)
```

#### 1.2 åˆ›å»ºä¸»é¢˜æ³¨å†Œè¡¨ç³»ç»Ÿ

**ç›®æ ‡**: å®ç°ç±»å‹å®‰å…¨çš„ä¸»é¢˜åŠ è½½æœºåˆ¶
**æ–‡ä»¶**:

- `sites/lib/theme-registry.ts`
- `sites/lib/theme-loader.ts`

#### 1.3 æ›´æ–°ä¸­é—´ä»¶é…ç½®

**ç›®æ ‡**: æ”¯æŒä¸»é¢˜è§£æå’Œè·¯ç”±
**æ–‡ä»¶**: `sites/middleware.ts`

### ç¬¬äºŒé˜¶æ®µï¼šä¸»é¢˜å¼€å‘ (4-5 å¤©)

#### 2.1 è¿ç§»ç°æœ‰ç«™ç‚¹åˆ°ä¸»é¢˜æ¶æ„

**ç›®æ ‡**: é‡æ„ç°æœ‰é¡µé¢ä¸ºä¸»é¢˜ç»“æ„
**åŠ¨ä½œ**:

- ç§»åŠ¨ `app/portal/` â†’ `themes/portal/v1/`
- ç§»åŠ¨åœ°æ–¹ç«™é€šç”¨ä»£ç  â†’ `themes/localsite-default/v1/`
- åˆ é™¤é‡å¤çš„ç«™ç‚¹ç‰¹å®šç›®å½•

#### 2.2 åˆ›å»ºåŸºç¡€ä¸»é¢˜

**ç›®æ ‡**: å®ç°ä¸¤ä¸ªæ ¸å¿ƒä¸»é¢˜

- `portal@v1`: é—¨æˆ·ç«™ä¸»é¢˜
- `localsite-default@v1`: é€šç”¨åœ°æ–¹ç«™ä¸»é¢˜

#### 2.3 å®ç° CSS å˜é‡ç³»ç»Ÿ

**ç›®æ ‡**: åŠ¨æ€ä¸»é¢˜åˆ‡æ¢å’Œå“ç‰Œå®šåˆ¶
**æ–‡ä»¶**:

- `sites/lib/tokens.ts`
- `sites/themes/*/tokens.ts`

### ç¬¬ä¸‰é˜¶æ®µï¼šå·¥å…·å’Œé›†æˆ (3-4 å¤©)

#### 3.1 å¼€å‘ä¸»é¢˜è„šæ‰‹æ¶å·¥å…·

**ç›®æ ‡**: CLI å·¥å…·å¿«é€Ÿåˆ›å»ºæ–°ä¸»é¢˜
**æ–‡ä»¶**: `scripts/scaffold-theme.js`

#### 3.2 é›†æˆ Wagtail åå°ç®¡ç†

**ç›®æ ‡**: ç®¡ç†ç•Œé¢ä¸»é¢˜é…ç½®
**æ–‡ä»¶**:

- `apps/sites/admin.py`
- `apps/sites/wagtail_hooks.py`

#### 3.3 æ›´æ–°ç¼“å­˜ç­–ç•¥

**ç›®æ ‡**: ä¸»é¢˜åˆ‡æ¢æ—¶çš„ç¼“å­˜å¤„ç†
**æ–‡ä»¶**:

- `sites/lib/cache.ts`
- Webhook é…ç½®

### ç¬¬å››é˜¶æ®µï¼šè´¨é‡ä¿è¯ (2-3 å¤©)

#### 4.1 å»ºç«‹ä¸»é¢˜æµ‹è¯•æ¡†æ¶

**ç›®æ ‡**: è‡ªåŠ¨åŒ–æµ‹è¯•ä¸»é¢˜åŠŸèƒ½
**æ–‡ä»¶**: `sites/__tests__/themes/`

#### 4.2 æ€§èƒ½ä¼˜åŒ–éªŒè¯

**ç›®æ ‡**: ç¡®ä¿æ€§èƒ½ä¸é™çº§
**å·¥å…·**: Lighthouse, Bundle Analyzer

## ğŸ“‹ å„é˜¶æ®µéªŒæ”¶æ ‡å‡†

### ç¬¬ä¸€é˜¶æ®µéªŒæ”¶

- [ ] Wagtail åå°å¯ä»¥ç¼–è¾‘ä¸»é¢˜é…ç½®
- [ ] ä¸»é¢˜æ³¨å†Œè¡¨å¯ä»¥æ­£ç¡®åŠ è½½ä¸»é¢˜
- [ ] ä¸­é—´ä»¶èƒ½è§£æä¸»é¢˜ä¿¡æ¯

### ç¬¬äºŒé˜¶æ®µéªŒæ”¶

- [ ] é—¨æˆ·ç«™ä½¿ç”¨ `portal@v1` ä¸»é¢˜
- [ ] åœ°æ–¹ç«™ä½¿ç”¨ `localsite-default@v1` ä¸»é¢˜
- [ ] CSS å˜é‡èƒ½åŠ¨æ€åˆ‡æ¢ä¸»é¢˜æ ·å¼
- [ ] ç°æœ‰åŠŸèƒ½ä¸å—å½±å“

### ç¬¬ä¸‰é˜¶æ®µéªŒæ”¶

- [ ] è„šæ‰‹æ¶å·¥å…·èƒ½åˆ›å»ºæ–°ä¸»é¢˜
- [ ] Wagtail åå°èƒ½é€‰æ‹©å’Œé…ç½®ä¸»é¢˜
- [ ] ä¸»é¢˜åˆ‡æ¢è§¦å‘æ­£ç¡®çš„ç¼“å­˜å¤±æ•ˆ

### ç¬¬å››é˜¶æ®µéªŒæ”¶

- [ ] æ‰€æœ‰ä¸»é¢˜åŠŸèƒ½æœ‰è‡ªåŠ¨åŒ–æµ‹è¯•è¦†ç›–
- [ ] Lighthouse è¯„åˆ†ä¸ä½äºç°æœ‰æ°´å¹³
- [ ] ä¸»é¢˜åŠ¨æ€åŠ è½½ä¸å½±å“é¦–å±æ€§èƒ½

## ğŸš€ è¿ç§»ç­–ç•¥

### æ¸è¿›å¼è¿ç§»

1. **ä¿æŒå‘åå…¼å®¹**: ç°æœ‰è·¯ç”±ç»§ç»­å·¥ä½œ
2. **åˆ†ç«™ç‚¹è¿ç§»**: å…ˆè¿ç§»æµ‹è¯•ç«™ç‚¹ï¼ŒéªŒè¯åæ¨å¹¿
3. **ä¼˜é›…é™çº§**: ä¸»é¢˜åŠ è½½å¤±è´¥æ—¶å›é€€åˆ°é»˜è®¤ä¸»é¢˜

### å›æ»šè®¡åˆ’

1. **é…ç½®å›æ»š**: ä¿®æ”¹ Wagtail é…ç½®å³å¯å›é€€
2. **ä»£ç å›æ»š**: ä¿æŒ Git åˆ†æ”¯å¯å¿«é€Ÿå›é€€
3. **ç¼“å­˜æ¸…ç†**: æä¾›ç¼“å­˜æ¸…ç†è„šæœ¬

## ğŸ“Š æˆåŠŸæŒ‡æ ‡

- **åŠŸèƒ½å®Œæ•´æ€§**: 100%ç°æœ‰åŠŸèƒ½è¿ç§»æˆåŠŸ
- **æ€§èƒ½æŒ‡æ ‡**: é¦–å±åŠ è½½æ—¶é—´ä¸å¢åŠ è¶…è¿‡ 10%
- **å¼€å‘æ•ˆç‡**: æ–°ä¸»é¢˜åˆ›å»ºæ—¶é—´ < 2 å°æ—¶
- **è¿ç»´ä¾¿åˆ©æ€§**: ä¸»é¢˜åˆ‡æ¢ < 5 åˆ†é’Ÿç”Ÿæ•ˆ

## ğŸ”§ æŠ€æœ¯å€ºåŠ¡æ¸…ç†

åœ¨å®æ–½è¿‡ç¨‹ä¸­åŒæ—¶å¤„ç†ï¼š

1. åˆ é™¤é‡å¤çš„ç«™ç‚¹ç›®å½•
2. ç»Ÿä¸€ç»„ä»¶å‘½åè§„èŒƒ
3. ä¼˜åŒ–èµ„æºåŠ è½½ç­–ç•¥
4. å®Œå–„ TypeScript ç±»å‹å®šä¹‰

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

å¼€å§‹æ‰§è¡Œç¬¬ä¸€é˜¶æ®µç¬¬ä¸€ä¸ªä»»åŠ¡ï¼š**æ‰©å±• Wagtail SiteSettings æ¨¡å‹**
