# 分类映射方案

## 概述

本文档说明如何将旧MySQL数据库（121.41.73.49）的476个分类映射到新系统（121.40.167.71）的6个频道。

## 新老系统对比

### 旧系统结构
- **数据库**: MySQL (jrhb)
- **分类总数**: 476个
- **层级结构**: 多层级分类（有父子关系）
- **特点**: 
  - 包含大量地方性分类（武汉、黄石、十堰、荆州、宜昌等）
  - 分类细致，覆盖多个领域

### 新系统结构
- **数据库**: PostgreSQL
- **框架**: Wagtail CMS + Django
- **频道数**: 6个
- **模型**: Channel（频道）和 Category（分类）

## 新系统频道

| ID | 名称 | Slug | 说明 |
|----|------|------|------|
| 1 | 民生 | foo | 民生、健康、医疗、美食、家居等 |
| 2 | 社会 | society | 新闻、时政、教育、汽车、旅游等 |
| 3 | 科技 | tech | 科技相关内容 |
| 4 | 财经 | finance | 金融、经济、房产、投资等 |
| 5 | 体育 | sports | 体育运动相关 |
| 6 | 娱乐 | entertainment | 文化、艺术、娱乐等 |

## 映射统计

### 频道分布

| 频道 | 分类数 | 占比 | 示例分类 |
|------|--------|------|----------|
| 社会 | 330 | 69.3% | 新闻、时政、党建、教育、汽车、旅游等 |
| 娱乐 | 65 | 13.7% | 文化、艺术、书画、娱乐等 |
| 民生 | 46 | 9.7% | 民生、健康、医疗、美食、家居等 |
| 财经 | 33 | 6.9% | 金融、经济、房产、证券、投资等 |
| 体育 | 1 | 0.2% | 体育 |
| 科技 | 1 | 0.2% | 科技 |

## 主要映射规则

### 1. 财经频道 (finance)

**原则**: 经济、金融、商业、房地产相关

```
旧分类 → 新频道
------------------------
4 金融 → 财经
7 经济 → 财经
8 证券 → 财经
9 理财 → 财经
10 商会 → 财经
11 投资 → 财经
28 房产 → 财经
所有"房产资讯" → 财经
```

### 2. 体育频道 (sports)

**原则**: 体育运动相关

```
旧分类 → 新频道
------------------------
23 体育 → 体育
```

### 3. 科技频道 (tech)

**原则**: 科技、互联网、IT相关

```
旧分类 → 新频道
------------------------
26 科技 → 科技
```

### 4. 娱乐频道 (entertainment)

**原则**: 文化、艺术、娱乐相关

```
旧分类 → 新频道
------------------------
18 文化 → 娱乐
19 文化 → 娱乐
20 书画 → 娱乐
21 娱乐 → 娱乐
22 艺术 → 娱乐
24 公示 → 娱乐
所有"*文化" → 娱乐
```

### 5. 民生频道 (foo)

**原则**: 民生、健康、医疗、美食、生活相关

```
旧分类 → 新频道
------------------------
13 民生 → 民生
14 家居 → 民生
15 健康 → 民生
16 民生 → 民生
17 医疗 → 民生
41 美食 → 民生
所有"美食特产" → 民生
所有"家居装修" → 民生
```

### 6. 社会频道 (society)

**原则**: 新闻、时政、社会、教育及其他未明确分类

```
旧分类 → 新频道
------------------------
1 新闻 → 社会
2 时政 → 社会
3 党建 → 社会
5 社会 → 社会
6 法制 → 社会
12 资讯 → 社会
27 教育 → 社会
29 汽车 → 社会
30 旅游 → 社会
32 视频 → 社会
33 美图 → 社会
所有地方性分类（默认） → 社会
```

## 地方性分类处理

旧系统有大量地方性分类（武汉、黄石、十堰、荆州、宜昌等），这些分类按照以下规则映射：

| 地方分类父ID | 地区 | 映射规则 |
|-------------|------|----------|
| 34 | 首页推荐资料 | 根据子分类内容映射 |
| 43 | 武汉网站 | 根据子分类内容映射 |
| 58 | 黄石网站 | 根据子分类内容映射 |
| 73 | 十堰网站 | 根据子分类内容映射 |
| 88 | 荆州网站 | 根据子分类内容映射 |
| 102 | 宜昌网站 | 根据子分类内容映射 |

**子分类映射示例**:
- "专题资讯" → 社会
- "房产资讯" → 财经
- "*文化" → 娱乐
- "美食特产" → 民生

## 智能映射规则

对于未在详细映射表中的分类，使用基于名称关键词的智能映射：

```json
{
  "关键词": ["经济", "金融", "财经", "证券", "理财", "投资", "商会", "房产"],
  "目标频道": "财经"
},
{
  "关键词": ["体育", "足球", "篮球", "运动"],
  "目标频道": "体育"
},
{
  "关键词": ["科技", "互联网", "IT", "数码"],
  "目标频道": "科技"
},
{
  "关键词": ["文化", "娱乐", "艺术", "音乐", "电影", "书画"],
  "目标频道": "娱乐"
},
{
  "关键词": ["民生", "健康", "医疗", "美食", "家居", "生活"],
  "目标频道": "民生"
}
```

## 映射文件

### 1. category_mapping.json
- **路径**: `data/migration/category_mapping.json`
- **用途**: 映射规则配置文件
- **内容**: 
  - 手动定义的映射规则
  - 智能映射关键词
  - 默认映射设置

### 2. category_mapping_complete.json
- **路径**: `data/migration/category_mapping_complete.json`
- **用途**: 完整的映射表（自动生成）
- **内容**: 
  - 476个分类的完整映射
  - 每个分类的目标频道ID和名称
  - 分类父子关系

## 使用方法

### 1. 分析映射
```bash
# 在Docker容器中运行
docker compose -f infra/local/docker-compose.yml exec authoring \
  python scripts/analyze_category_mapping.py
```

### 2. 查看映射结果
```bash
# 查看完整映射表
cat data/migration/category_mapping_complete.json | jq '.statistics'
```

### 3. 调整映射
如需调整映射规则：
1. 编辑 `data/migration/category_mapping.json`
2. 重新运行分析脚本
3. 检查生成的 `category_mapping_complete.json`

### 4. 导入时自动应用
导入脚本会自动：
1. 加载映射表
2. 根据文章的`cate_id`查找对应频道
3. 将文章分配到正确的频道

```bash
# 导入时会自动使用映射
python manage.py import_old_articles --test --limit=10
```

## 映射示例

### 示例1: 财经类文章
```
旧文章: {id: 1001, title: "楼市新政", cate_id: 28}
旧分类: 28 房产
↓
新频道: 4 财经 (finance)
```

### 示例2: 地方文化类文章
```
旧文章: {id: 2001, title: "武汉历史", cate_id: 45}
旧分类: 45 汉口文化 (父: 43 武汉网站)
↓
新频道: 6 娱乐 (entertainment)
```

### 示例3: 民生类文章
```
旧文章: {id: 3001, title: "健康饮食", cate_id: 15}
旧分类: 15 健康 (父: 13 民生)
↓
新频道: 1 民生 (foo)
```

## 验证清单

导入完成后，检查频道分布是否合理：

```python
from apps.news.models import ArticlePage
from django.db.models import Count

# 按频道统计
stats = ArticlePage.objects.values('channel__name').annotate(
    count=Count('id')
).order_by('-count')

for stat in stats:
    print(f"{stat['channel__name']}: {stat['count']} 篇")
```

**预期分布**（基于476个分类映射）:
- 社会频道: ~70% (大部分新闻、地方性内容)
- 娱乐频道: ~14% (文化艺术类)
- 民生频道: ~10% (健康美食等)
- 财经频道: ~7% (经济金融房产)
- 体育频道: <1% 
- 科技频道: <1%

## 注意事项

1. **地方性内容**: 大量地方性分类默认映射到"社会"频道，如需精细分类，可后续手动调整

2. **文化类内容**: "文化"可以是严肃的社会文化，也可以是娱乐文化，当前统一映射到"娱乐"

3. **默认映射**: 未找到匹配的分类会使用默认频道"社会"

4. **分类扩展**: 未来如需新增频道，只需：
   - 在新系统创建新频道
   - 更新 `category_mapping.json`
   - 重新运行分析脚本
   - 重新导入或批量更新

## 相关文档

- [数据迁移快速开始](./data_migration_quickstart.md)
- [完整迁移方案](./data_migration_plan.md)
- [迁移总览](./MIGRATION_README.md)

## 常见问题

### Q1: 某个分类映射不合理怎么办？

编辑 `data/migration/category_mapping.json`，在 `detailed_mapping` 中修改对应分类的映射，然后重新运行分析脚本。

### Q2: 新增了频道如何更新映射？

1. 在新系统创建频道
2. 更新映射文件，添加新频道的映射规则
3. 重新运行分析脚本
4. 对已导入文章，可以写脚本批量更新

### Q3: 如何查看某个旧分类ID的映射结果？

```bash
cat data/migration/category_mapping_complete.json | jq '.mapping["43"]'
```

### Q4: 能否让一个旧分类映射到多个新频道？

当前设计是一对一映射。如需多对多，建议：
- 先导入到主要频道
- 后续通过分类(Category)功能实现多分类标注

---

**最后更新**: 2024-10-20  
**版本**: 1.0

