# ⏰ 定时发布功能测试步骤

## 测试时间：2024-11-07

---

## 📋 测试步骤

### 第1步：创建测试文章 (2分钟)

1. **登录后台**
   - 访问：`http://8.133.22.7:8000/admin/`
   - 使用您的账号登录（如 houad 或其他用户）

2. **创建新文章**
   - 点击左侧菜单 **"页面"** 
   - 找到 **"News Articles"** 
   - 点击 **"添加子页面"** → 选择 **"Article Page"**

3. **填写基本信息**
   ```
   标题：定时发布测试文章 - 2024-11-07
   摘要：这是一篇测试定时发布功能的文章
   正文：测试内容，验证定时发布是否正常工作
   ```

4. **设置定时发布时间**
   - 展开 **"📢 发布设置"** 面板
   - 点击 **"发布时间"** 字段的日历图标
   - 设置时间为：**当前时间 + 2分钟**
   
   **示例**：
   - 如果现在是 14:30，设置为 14:32
   - 如果现在是 15:45，设置为 15:47

5. **保存为草稿**
   - ⚠️ **重要**：点击 **"保存草稿"** 按钮
   - ❌ **不要点击** "发布" 按钮

6. **记录信息**
   - 记录文章ID（浏览器地址栏会显示，如 /admin/pages/131234/edit/）
   - 记录设置的发布时间
   - 记录当前时间

---

### 第2步：验证文章状态 (1分钟)

1. **进入"我的文章"页面**
   - 点击左侧菜单 **"我的文章"**
   
2. **查看文章状态**
   - 找到刚创建的文章
   - 应该显示：🟦 **⏰ 定时发布: mm-dd HH:MM**
   - 如果只显示 **"草稿"**，说明时间设置有问题

---

### 第3步：监控Celery日志 (等待发布)

**打开终端，执行监控命令**：
```bash
ssh root@8.133.22.7 "cd /opt/idp-cms && docker compose -f infra/production/docker-compose-ha-node1.yml logs -f celery-beat celery"
```

**查看日志关键信息**：
- ✅ 每1分钟会看到任务执行
- ✅ 发布成功会显示：`✅ 自动发布文章成功: ID=...`
- ❌ 如果有错误会显示：`❌ 自动发布文章失败: ...`

**日志示例**：
```
celery-beat_1  | [2024-11-07 14:32:00] Task news.publish_scheduled_articles 开始执行
celery_1       | ✅ 自动发布文章成功: ID=131234, 标题=《定时发布测试文章 - 2024-11-07》
celery_1       | 📊 定时发布任务完成: 成功=1, 失败=0
```

---

### 第4步：验证发布结果 (1分钟)

**等待设定时间过后1-2分钟**，然后：

1. **刷新"我的文章"页面**
   - 文章状态应该从 **⏰ 定时发布** 变为 **已发布**
   - 徽章变为绿色 **✅ 已发布**

2. **查看文章详情**
   - 点击文章标题
   - 查看是否显示为 **"已发布"** 状态
   - 查看发布时间

3. **前端验证（可选）**
   - 访问：`http://8.133.22.7/portal`
   - 查看文章是否出现在首页或频道页

---

## ✅ 成功标志

- [x] 文章显示定时发布徽章
- [x] Celery日志显示发布成功
- [x] 文章状态变为已发布
- [x] 前端可以访问文章

---

## ❌ 如果失败

### 问题1：文章没有显示定时发布徽章
**原因**：发布时间设置不正确
**解决**：
1. 重新编辑文章
2. 确保发布时间是**未来时间**
3. 重新保存草稿

### 问题2：Celery日志没有任何输出
**原因**：Celery服务未运行
**解决**：
```bash
# 检查容器状态
ssh root@8.133.22.7
docker ps | grep celery

# 重启Celery服务
cd /opt/idp-cms
docker compose -f infra/production/docker-compose-ha-node1.yml restart celery celery-beat
```

### 问题3：日志显示发布失败
**原因**：可能是权限或数据问题
**解决**：
1. 查看完整错误信息
2. 检查文章内容是否完整
3. 确认用户有发布权限

---

## 📞 测试完成后

请告诉我：
1. ✅ 测试是否成功
2. 📝 看到了什么日志信息
3. 🐛 遇到了什么问题（如果有）

我会根据结果帮您分析和解决！

