# 头条新闻板块技术文档

## 📋 概述

头条新闻板块是党报头条网站的核心组件，对标**"今日头条级"**的专业新闻聚合体验。该板块采用智能算法实现新闻聚类、去重、多样性策略和实时更新，为用户提供高质量的新闻阅读体验。

## 🎯 设计目标

### 核心原则
- **权威性优先**：优先展示党媒和主流媒体内容
- **时效性保障**：实时更新最新24小时热点
- **多样性平衡**：避免单一频道或来源垄断
- **智能去重**：基于内容相似度的聚类算法
- **用户体验**：快速加载、优雅降级、响应式布局

### 功能特性
- ✅ 智能聚类与去重算法
- ✅ 多频道内容平衡策略  
- ✅ 实时缓存与性能优化
- ✅ 响应式三栏混排布局
- ✅ 自动轮播与用户交互
- ✅ 容错降级机制
- 🔥 **多维度热度计算系统 (NEW)**
- 🔥 **智能hot/trending分类 (NEW)**
- 🔥 **用户行为数据分析 (NEW)**
- 🔥 **社交互动评估 (NEW)**
- 🔥 **自动化任务调度 (NEW)**

## 🏗️ 技术架构

### 整体架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端组件      │    │   API代理层     │    │   Django后端    │
│                 │    │                 │    │                 │
│ TopStoriesGrid  │───▶│ /api/headlines  │───▶│ /api/headlines/ │
│                 │    │   (Next.js)     │    │   (Django)      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                        │
                               ┌────────────────────────┼────────────────────────┐
                               │                        ▼                        │
                    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
                    │   OpenSearch    │    │     Redis       │    │   PostgreSQL    │
                    │   (检索聚合)    │    │   (缓存预计算)  │    │   (内容存储)    │
                    └─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 技术栈
- **前端**: Next.js 14 (App Router) + React + TypeScript + Tailwind CSS
- **API代理**: Next.js API Routes (BFF层)
- **后端**: Django REST Framework + Python
- **检索**: OpenSearch/Elasticsearch
- **缓存**: Redis
- **数据库**: PostgreSQL
- **任务调度**: Celery + Celery Beat
- **🔥 用户行为**: ClickHouse (14字段完整数据)
- **🔥 热度计算**: Python多维度评分算法
- **🔥 社交数据**: Django业务模型 + 自动同步

## 🔧 核心组件

### 1. 前端组件

#### TopStoriesGrid.tsx
主要的头条新闻展示组件，采用响应式三栏布局：

```typescript
interface TopStoriesGridProps {
  items: TopStoryItem[];
  title?: string;
  showViewMore?: boolean;
  viewMoreLink?: string;
  // 主新闻轮播配置
  enableCarousel?: boolean;
  carouselAutoPlay?: boolean;
  carouselInterval?: number;
}
```

**布局特点**:
- **桌面端**: 左侧2栏主新闻轮播 + 右侧1栏新闻列表 (`lg:grid-cols-3`)
- **移动端**: 单栏垂直布局 (`grid-cols-1`)
- **主新闻区**: 自动轮播，支持暂停交互，显示圆点指示器
- **列表区**: 垂直排列，标题+时间+来源的简洁样式

#### TopStoriesGrid.utils.ts
数据获取和处理逻辑：

```typescript
/**
 * 获取头条新闻数据
 * 使用专业的headlines API，对标今日头条级体验
 */
export async function getTopStories(limit: number = 9): Promise<TopStoryItem[]>
```

**特性**:
- 调用专业headlines API
- 高多样性策略 (`diversity: 'high'`)
- 24小时时间窗口
- 5分钟缓存策略
- 容错降级到mock数据

### 2. API层

#### Next.js API代理 (`/api/headlines/route.ts`)

```typescript
export async function GET(request: NextRequest) {
  // 参数透传: size, site, hours, region, lang, diversity, cursor, channels
  // 代理到Django后端: /api/headlines/
  // 缓存策略: Cache-Control: public, s-maxage=60, stale-while-revalidate=300
}
```

**职责**:
- 参数验证和转换
- 请求代理到Django后端
- 设置CDN缓存策略
- 错误处理和降级

#### Django后端API (`apps/api/rest/headlines.py`)

```python
@api_view(['GET'])
@throttle_classes([])
@FEED_RATE_LIMIT
def headlines(request):
    """
    今日头条专用API
    支持: 聚类、多样性、缓存、跨频道去重
    """
```

**核心算法**:

1. **召回策略**: OpenSearch多字段检索 + DB回退
2. **聚类算法**: URL精确匹配 + 标题Jaccard相似度
3. **排序策略**: 时效性 × 权重 × 热度综合评分  
4. **多样性策略**: 频道平衡 + 来源分散

### 3. 聚合缓存API

#### 现代缓存系统 (`apps/api/utils/modern_cache.py`)

```python
class ModernCacheStrategy:
    """
    现代化智能缓存策略 - v3版本
    缓存Key: headlines:v3:{content_type}:{layer}:{site}:{params}
    """
```

**调度配置** (`config/settings/base.py`):
```python
'compute-headlines': {
    'task': 'apps.api.tasks.aggregations.compute_headlines',
    'schedule': 60.0,  # 每分钟刷新一次短缓存
    'options': {'queue': 'default'},
},
```

#### 聚合API (`apps/api/rest/aggregations.py`)

```python
@api_view(['GET'])
def agg_headlines(request):
    """
    高性能聚合API，直接从Redis读取预计算结果
    缓存未命中时同步触发预计算任务
    """
```

## 🔥 热度计算系统 (2025.09.22 重大更新)

### 多维度热度评分模型

我们实现了对标**今日头条级别**的智能热度计算系统，包含完整的用户行为分析和社交互动评估：

#### 核心算法公式
```
热度评分 = 时效性(30%) + 参与度(40%) + 热度(20%) + 质量(10%)

参与度评分 = CTR(40%) + 社交互动(35%) + 阅读质量(20%) + 停留时间(5%)

社交互动 = 分享×4 + 收藏×3 + 评论×2 + 点赞×1
```

#### 技术架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   ClickHouse    │    │   Django业务    │    │   热度计算器    │
│ 用户行为数据14字段│ ◄──┤ 社交互动数据    │───▶│ 多维度评分算法   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                        │
                               ┌────────────────────────┼────────────────────────┐
                               │                        ▼                        │
                    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
                    │   OpenSearch    │    │   自动标记      │    │   前端展示      │
                    │ 动态hot/trending │    │  定时任务同步   │    │ 智能推荐结果    │
                    └─────────────────┘    └─────────────────┘    └─────────────────┘
```

#### 数据字段扩展 (ClickHouse)

**新增14个完整字段**:
- `shares` - 分享次数
- `comments` - 评论数量  
- `likes` - 点赞数量
- `favorites` - 收藏数量
- `reading_completion_rate` - 阅读完成率
- `bounce_rate` - 跳出率
- `social_score` - 综合社交评分
- `event_value` - 事件权重值
- `reading_progress` - 阅读进度
- `social_action` - 社交行为类型

#### 智能分类逻辑

**Hot分类条件** (至少4个基础条件 + 质量加分):
- 热度评分 ≥ 75分
- 1小时CTR ≥ 3%
- 浏览量 ≥ 50次
- 时效性 > 0.1
- 社交互动 ≥ 5次
- 质量加分: 阅读完成率≥60% 或 跳出率≤30% 或 社交评分>0.5

**Trending分类条件** (至少3个基础条件):
- 热度评分 ≥ 55分
- 1小时CTR ≥ 2%
- 浏览量 ≥ 20次
- 时效性 > 0.05
- 社交互动 ≥ 2次

#### 自动化任务系统

**定时任务配置**:
- **快速刷新**: 每10分钟更新最近1小时热点
- **全面更新**: 每30分钟重算最近24小时文章
- **社交同步**: 每小时同步Django业务数据到ClickHouse
- **过期清理**: 每天凌晨清理7天前的热度标记

## 📊 算法详解

### 1. 聚类算法

#### URL精确聚类
```python
def _cluster_items(items: List[dict], max_per_cluster: int = 2) -> List[dict]:
    """基于URL的精确聚类 + 标题相似度"""
    
    # Step 1: URL精确匹配
    url_clusters = defaultdict(list)
    for item in items:
        if item.get('url'):
            url_clusters[item['url']].append(item)
    
    # Step 2: 标题Jaccard相似度聚类 (阈值=0.6)
    # 为孤立项目进行标题相似度匹配
```

#### 相似度计算
- **Jaccard相似度**: `|A ∩ B| / |A ∪ B|`
- **中文分词**: jieba分词处理
- **阈值设定**: 0.6 (经验值，平衡召回和精度)

### 2. 多样性策略

#### 高多样性策略 (`diversity="high"`)
```python
def _apply_headlines_high_diversity(items: List[dict], limit: int) -> List[dict]:
    """
    仿照今日头条的多样性策略:
    1. 每个频道最多1条 (前6条)
    2. 每个来源最多2条
    3. 优先级: 权重高 > 时效性 > 热度
    """
```

**分配策略**:
- 前6条: 每频道最多1条，确保频道多样性
- 后续条目: 每频道最多2条，每来源最多2条
- 频道分布日志: `Headlines diversity: X channels, Y items`

#### 评分算法
```python
def _compute_headline_score(item: dict, hours: int) -> float:
    """
    综合评分 = 时效性系数 × 基础权重 × 热度系数
    """
    # 时效性衰减: 24小时内线性衰减
    time_factor = max(0.1, 1 - age_hours / hours)
    
    # 基础权重 (编辑推荐/置顶)
    base_weight = 2.0 if item.get('is_featured') else 1.0
    
    # 热度系数 (浏览量、评论数)
    popularity_factor = math.log10(max(1, item.get('view_count', 0)) + 1)
    
    return time_factor * base_weight * (1 + popularity_factor * 0.1)
```

### 3. 去重策略

#### 跨模块去重
- **Hero轮播** → **头条新闻** → **推荐流**: 优先级递减
- **基于cluster_slug**: 避免同类新闻在多模块重复出现  
- **允许多来源**: 每簇最多保留2个不同来源

## 🚀 性能优化

### 缓存策略

#### 多层缓存架构
```
CDN (60s)
  ↓
Next.js API (SWR: 300s)  
  ↓
Django View (无缓存)
  ↓
Redis预计算 (60s)
  ↓  
OpenSearch (实时)
```

#### 缓存Key设计
```python
# 现代化智能缓存 (v3)
cache_key = generate_cache_key(
    content_type, CacheLayer.BACKEND, site, params, user_id
)
# 示例: headlines:v3:hot:backend:aivoya.com:h24_dhigh_s9:default
```

#### CDN优化
```typescript
// Next.js API响应头
headers: {
  'Cache-Control': 'public, s-maxage=60, stale-while-revalidate=300',
}
```

### 性能指标

#### SLA目标
- **P95响应时间**: < 400ms
- **错误率**: < 0.5%
- **空列表率**: < 1%
- **缓存命中率**: > 90%

#### 监控指标
- API响应时间分布
- 缓存命中/未命中统计
- 多样性分布 (频道覆盖度)
- 跨模块去重效果

## 🔄 容错机制

### 降级策略

```typescript
export async function getTopStories(limit: number = 9): Promise<TopStoryItem[]> {
  try {
    // 1. 优先: Headlines专业API
    const response = await fetch(apiUrl, { next: { revalidate: 300 } });
    if (response.ok) return transformToTopStoryItem(data.items);
  } catch (error) {
    console.warn('Headlines API failed, falling back to mock data:', error);
  }
  
  // 2. 兜底: Mock数据
  return generateMockTopStories(limit);
}
```

### 错误处理

#### API层错误处理
```python
# Django视图
try:
    # OpenSearch查询
    candidates = search_articles(query, size=size*3)
except Exception:
    # DB回退查询
    candidates = Article.objects.filter(
        publish_at__gte=timezone.now() - timedelta(hours=hours)
    ).order_by('-publish_at')[:size*2]
```

#### 前端错误处理
```typescript
// 组件错误边界
{topStories.length > 0 ? (
  <TopStoriesGrid items={topStories} />
) : (
  <TopStoriesLoadingSkeleton />
)}
```

## 📱 用户体验

### 响应式设计

#### 断点配置
```css
/* 移动优先响应式 */
.top-stories-grid {
  @apply grid grid-cols-1 gap-6;
  
  /* 平板及以上: 三栏布局 */
  @screen lg {
    @apply grid-cols-3;
  }
}

.main-news-section {
  @apply col-span-1;
  
  /* 桌面端: 占据左侧2栏 */  
  @screen lg {
    @apply col-span-2;
  }
}
```

#### 交互体验
- **主新闻轮播**: 6秒自动切换，鼠标悬停暂停
- **圆点指示器**: 显示当前位置，支持点击跳转
- **加载状态**: Skeleton骨架屏，避免布局跳动
- **无障碍支持**: ARIA标签，键盘导航

### 移动端优化

#### 触摸交互
```typescript
// 轮播组件支持滑动手势
const [touchStart, setTouchStart] = useState(0);
const [touchEnd, setTouchEnd] = useState(0);

const handleTouchStart = (e: TouchEvent) => {
  setTouchStart(e.targetTouches[0].clientX);
};

const handleTouchMove = (e: TouchEvent) => {
  setTouchEnd(e.targetTouches[0].clientX);
};
```

#### 性能优化
- 图片懒加载: `loading="lazy"`
- WebP格式: Wagtail自动渲染
- 压缩优化: 移动端使用小尺寸图片

## 🛠️ 运维管理

### 🔥 热度系统管理命令 (NEW)

#### 手动测试热度算法
```bash
# 测试热度算法
python manage.py update_hotness_tags --mode=test --site=aivoya.com

# 测试单篇文章详细分析
python manage.py update_hotness_tags --mode=single --article-id=4154 --site=aivoya.com

# 快速刷新热点（最近1小时）
python manage.py update_hotness_tags --mode=fast --site=aivoya.com

# 全量更新（最近24小时）
python manage.py update_hotness_tags --mode=full --hours=24 --batch-size=100 --site=aivoya.com

# 清理过期热度标记
python manage.py update_hotness_tags --mode=cleanup --site=aivoya.com
```

#### 社交数据同步
```bash
# 手动同步社交数据
python manage.py shell -c "
from apps.core.services.social_metrics_collector import collect_and_sync_all_recent_articles
collect_and_sync_all_recent_articles(hours_back=24, site='aivoya.com')
"
```

#### 系统状态检查
```bash
# 验证ClickHouse字段完整性
docker compose exec clickhouse clickhouse-client --query "DESCRIBE TABLE article_metrics_agg"

# 检查热度数据
curl -s "http://localhost:8000/api/headlines/?size=3&site=aivoya.com" | jq '.items[] | {id, title, hotness_score, hotness_category}'
```

### 监控告警

#### Celery任务监控
```python
# 任务执行日志
@app.task(bind=True)
def compute_headlines(self, site, **kwargs):
    try:
        result = process_headlines(site, **kwargs)
        logger.info(f"Headlines computed: {result}")
        return result
    except Exception as exc:
        logger.error(f"Headlines compute failed: {exc}")
        raise self.retry(countdown=60, max_retries=3)
```

#### API健康检查
```python
# apps/api/rest/monitoring.py
def health_check():
    """检查核心组件健康状态"""
    return {
        "headlines_api": test_headlines_api(),
        "cache_status": test_redis_cache(), 
        "search_status": test_opensearch(),
        "overall_health": "healthy|degraded|error"
    }
```

### 缓存管理

#### 缓存清理
```python
# Wagtail钩子: 内容发布时清理相关缓存
@hooks.register('after_publish_page')
def clear_headlines_cache(request, page):
    if isinstance(page, ArticlePage):
        patterns = ['headlines_*', 'agg:headlines:*']
        for pattern in patterns:
            cache.delete_pattern(pattern)
```

#### 预热策略
```bash
# 定时预热热门缓存
*/5 * * * * cd /app && python manage.py shell -c "
from apps.api.tasks.aggregations import compute_headlines
compute_headlines.delay('aivoya.com', hours=24, diversity='high')
"
```

## 📈 数据分析

### 埋点统计

#### 前端埋点
```typescript
// 新闻点击埋点
const handleNewsClick = (item: TopStoryItem, position: number) => {
  analytics.track('top_stories_click', {
    article_id: item.id,
    position: position,
    section: 'main_carousel', // 或 'side_list'
    cluster_slug: item.cluster_slug,
    channel: item.channel?.slug,
  });
};
```

#### 后端指标
```python
# API性能指标
@api_view(['GET'])  
def headlines(request):
    start_time = time.time()
    
    # ... 处理逻辑 ...
    
    response_time = time.time() - start_time
    metrics.histogram('headlines.response_time', response_time)
    metrics.counter('headlines.requests_total').inc()
    
    return Response(data)
```

### A/B测试

#### 多样性策略测试
```python
# Feature Flag控制
DIVERSITY_STRATEGY = {
    'control': 'med',    # 对照组: 中等多样性
    'treatment': 'high', # 实验组: 高多样性  
}

def get_diversity_strategy(request):
    user_group = hash(request.session.session_key) % 100
    return 'high' if user_group < 50 else 'med'
```

#### 关键指标
- **CTR (点击率)**: 头条新闻点击 / 曝光
- **停留时间**: 用户在新闻页面停留时长  
- **跳出率**: 点击头条后立即离开的比例
- **多样性得分**: 频道覆盖度和来源分散度

## 🔮 未来规划

### 算法优化
- [x] **🔥 多维度热度计算**: 基于用户行为的智能评分系统 ✅ 已完成
- [x] **🔥 社交互动分析**: 分享、评论、点赞、收藏综合评估 ✅ 已完成  
- [x] **🔥 阅读质量评估**: 完成率、跳出率、停留时间分析 ✅ 已完成
- [x] **🔥 智能分类系统**: hot/trending动态标记机制 ✅ 已完成
- [ ] **个性化推荐**: 基于用户画像的内容分发
- [ ] **实时热点**: 集成微博热搜、百度指数等外部数据源
- [ ] **情感分析**: 基于NLP的正面/负面新闻平衡
- [ ] **地理定位**: 根据用户IP推送本地新闻

### 功能增强  
- [ ] **视频头条**: 支持视频新闻的轮播展示
- [ ] **直播入口**: 重大事件时的直播推流接入
- [ ] **评论互动**: 头条新闻的评论和讨论功能  
- [ ] **分享传播**: 社交媒体分享和传播链路追踪

### 技术演进
- [ ] **GraphQL**: 替换REST API，支持字段级缓存
- [ ] **CDN**: 接入阿里云/腾讯云CDN加速静态资源
- [ ] **SSR**: 服务端渲染优化SEO和首屏加载
- [ ] **PWA**: 离线缓存和推送通知支持

## 📚 相关文档

- [党报头条整体规划](./方向构思.md)
- [技术架构评估](./0922评估.md)
- [前端API使用指南](../TODO/002-Enhance/FRONTEND_API_USAGE.md)
- [搜索系统建设](../算法/0912ToDo.md)
- [布局设计规范](../TODO/Layout/001.md)

---

**最后更新**: 2025年9月22日 - 🔥 **重大更新：多维度热度计算系统上线**
**维护团队**: 前端开发组 & 后端算法组 & 数据工程组
**联系方式**: 技术群或提交Issue到项目仓库

**📈 版本记录**:
- **v2.0** (2025.09.22): 多维度热度计算系统，ClickHouse数据扩展，智能分类算法
- **v1.0** (2025.09.01): 基础头条新闻聚合，多样性策略，响应式布局
