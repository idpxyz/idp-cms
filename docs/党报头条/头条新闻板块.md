# å¤´æ¡æ–°é—»æ¿å—æŠ€æœ¯æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

å¤´æ¡æ–°é—»æ¿å—æ˜¯å…šæŠ¥å¤´æ¡ç½‘ç«™çš„æ ¸å¿ƒç»„ä»¶ï¼Œå¯¹æ ‡**"ä»Šæ—¥å¤´æ¡çº§"**çš„ä¸“ä¸šæ–°é—»èšåˆä½“éªŒã€‚è¯¥æ¿å—é‡‡ç”¨æ™ºèƒ½ç®—æ³•å®ç°æ–°é—»èšç±»ã€å»é‡ã€å¤šæ ·æ€§ç­–ç•¥å’Œå®æ—¶æ›´æ–°ï¼Œä¸ºç”¨æˆ·æä¾›é«˜è´¨é‡çš„æ–°é—»é˜…è¯»ä½“éªŒã€‚

## ğŸ¯ è®¾è®¡ç›®æ ‡

### æ ¸å¿ƒåŸåˆ™
- **æƒå¨æ€§ä¼˜å…ˆ**ï¼šä¼˜å…ˆå±•ç¤ºå…šåª’å’Œä¸»æµåª’ä½“å†…å®¹
- **æ—¶æ•ˆæ€§ä¿éšœ**ï¼šå®æ—¶æ›´æ–°æœ€æ–°24å°æ—¶çƒ­ç‚¹
- **å¤šæ ·æ€§å¹³è¡¡**ï¼šé¿å…å•ä¸€é¢‘é“æˆ–æ¥æºå„æ–­
- **æ™ºèƒ½å»é‡**ï¼šåŸºäºå†…å®¹ç›¸ä¼¼åº¦çš„èšç±»ç®—æ³•
- **ç”¨æˆ·ä½“éªŒ**ï¼šå¿«é€ŸåŠ è½½ã€ä¼˜é›…é™çº§ã€å“åº”å¼å¸ƒå±€

### åŠŸèƒ½ç‰¹æ€§
- âœ… æ™ºèƒ½èšç±»ä¸å»é‡ç®—æ³•
- âœ… å¤šé¢‘é“å†…å®¹å¹³è¡¡ç­–ç•¥  
- âœ… å®æ—¶ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–
- âœ… å“åº”å¼ä¸‰æ æ··æ’å¸ƒå±€
- âœ… è‡ªåŠ¨è½®æ’­ä¸ç”¨æˆ·äº¤äº’
- âœ… å®¹é”™é™çº§æœºåˆ¶
- ğŸ”¥ **å¤šç»´åº¦çƒ­åº¦è®¡ç®—ç³»ç»Ÿ (NEW)**
- ğŸ”¥ **æ™ºèƒ½hot/trendingåˆ†ç±» (NEW)**
- ğŸ”¥ **ç”¨æˆ·è¡Œä¸ºæ•°æ®åˆ†æ (NEW)**
- ğŸ”¥ **ç¤¾äº¤äº’åŠ¨è¯„ä¼° (NEW)**
- ğŸ”¥ **è‡ªåŠ¨åŒ–ä»»åŠ¡è°ƒåº¦ (NEW)**

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ç»„ä»¶      â”‚    â”‚   APIä»£ç†å±‚     â”‚    â”‚   Djangoåç«¯    â”‚
â”‚                 â”‚    â”‚                 â”‚    â”‚                 â”‚
â”‚ TopStoriesGrid  â”‚â”€â”€â”€â–¶â”‚ /api/headlines  â”‚â”€â”€â”€â–¶â”‚ /api/headlines/ â”‚
â”‚                 â”‚    â”‚   (Next.js)     â”‚    â”‚   (Django)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚                        â–¼                        â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   OpenSearch    â”‚    â”‚     Redis       â”‚    â”‚   PostgreSQL    â”‚
                    â”‚   (æ£€ç´¢èšåˆ)    â”‚    â”‚   (ç¼“å­˜é¢„è®¡ç®—)  â”‚    â”‚   (å†…å®¹å­˜å‚¨)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ
- **å‰ç«¯**: Next.js 14 (App Router) + React + TypeScript + Tailwind CSS
- **APIä»£ç†**: Next.js API Routes (BFFå±‚)
- **åç«¯**: Django REST Framework + Python
- **æ£€ç´¢**: OpenSearch/Elasticsearch
- **ç¼“å­˜**: Redis
- **æ•°æ®åº“**: PostgreSQL
- **ä»»åŠ¡è°ƒåº¦**: Celery + Celery Beat
- **ğŸ”¥ ç”¨æˆ·è¡Œä¸º**: ClickHouse (14å­—æ®µå®Œæ•´æ•°æ®)
- **ğŸ”¥ çƒ­åº¦è®¡ç®—**: Pythonå¤šç»´åº¦è¯„åˆ†ç®—æ³•
- **ğŸ”¥ ç¤¾äº¤æ•°æ®**: Djangoä¸šåŠ¡æ¨¡å‹ + è‡ªåŠ¨åŒæ­¥

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. å‰ç«¯ç»„ä»¶

#### TopStoriesGrid.tsx
ä¸»è¦çš„å¤´æ¡æ–°é—»å±•ç¤ºç»„ä»¶ï¼Œé‡‡ç”¨å“åº”å¼ä¸‰æ å¸ƒå±€ï¼š

```typescript
interface TopStoriesGridProps {
  items: TopStoryItem[];
  title?: string;
  showViewMore?: boolean;
  viewMoreLink?: string;
  // ä¸»æ–°é—»è½®æ’­é…ç½®
  enableCarousel?: boolean;
  carouselAutoPlay?: boolean;
  carouselInterval?: number;
}
```

**å¸ƒå±€ç‰¹ç‚¹**:
- **æ¡Œé¢ç«¯**: å·¦ä¾§2æ ä¸»æ–°é—»è½®æ’­ + å³ä¾§1æ æ–°é—»åˆ—è¡¨ (`lg:grid-cols-3`)
- **ç§»åŠ¨ç«¯**: å•æ å‚ç›´å¸ƒå±€ (`grid-cols-1`)
- **ä¸»æ–°é—»åŒº**: è‡ªåŠ¨è½®æ’­ï¼Œæ”¯æŒæš‚åœäº¤äº’ï¼Œæ˜¾ç¤ºåœ†ç‚¹æŒ‡ç¤ºå™¨
- **åˆ—è¡¨åŒº**: å‚ç›´æ’åˆ—ï¼Œæ ‡é¢˜+æ—¶é—´+æ¥æºçš„ç®€æ´æ ·å¼

#### TopStoriesGrid.utils.ts
æ•°æ®è·å–å’Œå¤„ç†é€»è¾‘ï¼š

```typescript
/**
 * è·å–å¤´æ¡æ–°é—»æ•°æ®
 * ä½¿ç”¨ä¸“ä¸šçš„headlines APIï¼Œå¯¹æ ‡ä»Šæ—¥å¤´æ¡çº§ä½“éªŒ
 */
export async function getTopStories(limit: number = 9): Promise<TopStoryItem[]>
```

**ç‰¹æ€§**:
- è°ƒç”¨ä¸“ä¸šheadlines API
- é«˜å¤šæ ·æ€§ç­–ç•¥ (`diversity: 'high'`)
- 24å°æ—¶æ—¶é—´çª—å£
- 5åˆ†é’Ÿç¼“å­˜ç­–ç•¥
- å®¹é”™é™çº§åˆ°mockæ•°æ®

### 2. APIå±‚

#### Next.js APIä»£ç† (`/api/headlines/route.ts`)

```typescript
export async function GET(request: NextRequest) {
  // å‚æ•°é€ä¼ : size, site, hours, region, lang, diversity, cursor, channels
  // ä»£ç†åˆ°Djangoåç«¯: /api/headlines/
  // ç¼“å­˜ç­–ç•¥: Cache-Control: public, s-maxage=60, stale-while-revalidate=300
}
```

**èŒè´£**:
- å‚æ•°éªŒè¯å’Œè½¬æ¢
- è¯·æ±‚ä»£ç†åˆ°Djangoåç«¯
- è®¾ç½®CDNç¼“å­˜ç­–ç•¥
- é”™è¯¯å¤„ç†å’Œé™çº§

#### Djangoåç«¯API (`apps/api/rest/headlines.py`)

```python
@api_view(['GET'])
@throttle_classes([])
@FEED_RATE_LIMIT
def headlines(request):
    """
    ä»Šæ—¥å¤´æ¡ä¸“ç”¨API
    æ”¯æŒ: èšç±»ã€å¤šæ ·æ€§ã€ç¼“å­˜ã€è·¨é¢‘é“å»é‡
    """
```

**æ ¸å¿ƒç®—æ³•**:

1. **å¬å›ç­–ç•¥**: OpenSearchå¤šå­—æ®µæ£€ç´¢ + DBå›é€€
2. **èšç±»ç®—æ³•**: URLç²¾ç¡®åŒ¹é… + æ ‡é¢˜Jaccardç›¸ä¼¼åº¦
3. **æ’åºç­–ç•¥**: æ—¶æ•ˆæ€§ Ã— æƒé‡ Ã— çƒ­åº¦ç»¼åˆè¯„åˆ†  
4. **å¤šæ ·æ€§ç­–ç•¥**: é¢‘é“å¹³è¡¡ + æ¥æºåˆ†æ•£

### 3. èšåˆç¼“å­˜API

#### ç°ä»£ç¼“å­˜ç³»ç»Ÿ (`apps/api/utils/modern_cache.py`)

```python
class ModernCacheStrategy:
    """
    ç°ä»£åŒ–æ™ºèƒ½ç¼“å­˜ç­–ç•¥ - v3ç‰ˆæœ¬
    ç¼“å­˜Key: headlines:v3:{content_type}:{layer}:{site}:{params}
    """
```

**è°ƒåº¦é…ç½®** (`config/settings/base.py`):
```python
'compute-headlines': {
    'task': 'apps.api.tasks.aggregations.compute_headlines',
    'schedule': 60.0,  # æ¯åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡çŸ­ç¼“å­˜
    'options': {'queue': 'default'},
},
```

#### èšåˆAPI (`apps/api/rest/aggregations.py`)

```python
@api_view(['GET'])
def agg_headlines(request):
    """
    é«˜æ€§èƒ½èšåˆAPIï¼Œç›´æ¥ä»Redisè¯»å–é¢„è®¡ç®—ç»“æœ
    ç¼“å­˜æœªå‘½ä¸­æ—¶åŒæ­¥è§¦å‘é¢„è®¡ç®—ä»»åŠ¡
    """
```

## ğŸ”¥ çƒ­åº¦è®¡ç®—ç³»ç»Ÿ (2025.09.22 é‡å¤§æ›´æ–°)

### å¤šç»´åº¦çƒ­åº¦è¯„åˆ†æ¨¡å‹

æˆ‘ä»¬å®ç°äº†å¯¹æ ‡**ä»Šæ—¥å¤´æ¡çº§åˆ«**çš„æ™ºèƒ½çƒ­åº¦è®¡ç®—ç³»ç»Ÿï¼ŒåŒ…å«å®Œæ•´çš„ç”¨æˆ·è¡Œä¸ºåˆ†æå’Œç¤¾äº¤äº’åŠ¨è¯„ä¼°ï¼š

#### æ ¸å¿ƒç®—æ³•å…¬å¼
```
çƒ­åº¦è¯„åˆ† = æ—¶æ•ˆæ€§(30%) + å‚ä¸åº¦(40%) + çƒ­åº¦(20%) + è´¨é‡(10%)

å‚ä¸åº¦è¯„åˆ† = CTR(40%) + ç¤¾äº¤äº’åŠ¨(35%) + é˜…è¯»è´¨é‡(20%) + åœç•™æ—¶é—´(5%)

ç¤¾äº¤äº’åŠ¨ = åˆ†äº«Ã—4 + æ”¶è—Ã—3 + è¯„è®ºÃ—2 + ç‚¹èµÃ—1
```

#### æŠ€æœ¯æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ClickHouse    â”‚    â”‚   Djangoä¸šåŠ¡    â”‚    â”‚   çƒ­åº¦è®¡ç®—å™¨    â”‚
â”‚ ç”¨æˆ·è¡Œä¸ºæ•°æ®14å­—æ®µâ”‚ â—„â”€â”€â”¤ ç¤¾äº¤äº’åŠ¨æ•°æ®    â”‚â”€â”€â”€â–¶â”‚ å¤šç»´åº¦è¯„åˆ†ç®—æ³•   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                        â”‚
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚                        â–¼                        â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   OpenSearch    â”‚    â”‚   è‡ªåŠ¨æ ‡è®°      â”‚    â”‚   å‰ç«¯å±•ç¤º      â”‚
                    â”‚ åŠ¨æ€hot/trending â”‚    â”‚  å®šæ—¶ä»»åŠ¡åŒæ­¥   â”‚    â”‚ æ™ºèƒ½æ¨èç»“æœ    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ•°æ®å­—æ®µæ‰©å±• (ClickHouse)

**æ–°å¢14ä¸ªå®Œæ•´å­—æ®µ**:
- `shares` - åˆ†äº«æ¬¡æ•°
- `comments` - è¯„è®ºæ•°é‡  
- `likes` - ç‚¹èµæ•°é‡
- `favorites` - æ”¶è—æ•°é‡
- `reading_completion_rate` - é˜…è¯»å®Œæˆç‡
- `bounce_rate` - è·³å‡ºç‡
- `social_score` - ç»¼åˆç¤¾äº¤è¯„åˆ†
- `event_value` - äº‹ä»¶æƒé‡å€¼
- `reading_progress` - é˜…è¯»è¿›åº¦
- `social_action` - ç¤¾äº¤è¡Œä¸ºç±»å‹

#### æ™ºèƒ½åˆ†ç±»é€»è¾‘

**Hotåˆ†ç±»æ¡ä»¶** (è‡³å°‘4ä¸ªåŸºç¡€æ¡ä»¶ + è´¨é‡åŠ åˆ†):
- çƒ­åº¦è¯„åˆ† â‰¥ 75åˆ†
- 1å°æ—¶CTR â‰¥ 3%
- æµè§ˆé‡ â‰¥ 50æ¬¡
- æ—¶æ•ˆæ€§ > 0.1
- ç¤¾äº¤äº’åŠ¨ â‰¥ 5æ¬¡
- è´¨é‡åŠ åˆ†: é˜…è¯»å®Œæˆç‡â‰¥60% æˆ– è·³å‡ºç‡â‰¤30% æˆ– ç¤¾äº¤è¯„åˆ†>0.5

**Trendingåˆ†ç±»æ¡ä»¶** (è‡³å°‘3ä¸ªåŸºç¡€æ¡ä»¶):
- çƒ­åº¦è¯„åˆ† â‰¥ 55åˆ†
- 1å°æ—¶CTR â‰¥ 2%
- æµè§ˆé‡ â‰¥ 20æ¬¡
- æ—¶æ•ˆæ€§ > 0.05
- ç¤¾äº¤äº’åŠ¨ â‰¥ 2æ¬¡

#### è‡ªåŠ¨åŒ–ä»»åŠ¡ç³»ç»Ÿ

**å®šæ—¶ä»»åŠ¡é…ç½®**:
- **å¿«é€Ÿåˆ·æ–°**: æ¯10åˆ†é’Ÿæ›´æ–°æœ€è¿‘1å°æ—¶çƒ­ç‚¹
- **å…¨é¢æ›´æ–°**: æ¯30åˆ†é’Ÿé‡ç®—æœ€è¿‘24å°æ—¶æ–‡ç« 
- **ç¤¾äº¤åŒæ­¥**: æ¯å°æ—¶åŒæ­¥Djangoä¸šåŠ¡æ•°æ®åˆ°ClickHouse
- **è¿‡æœŸæ¸…ç†**: æ¯å¤©å‡Œæ™¨æ¸…ç†7å¤©å‰çš„çƒ­åº¦æ ‡è®°

## ğŸ“Š ç®—æ³•è¯¦è§£

### 1. èšç±»ç®—æ³•

#### URLç²¾ç¡®èšç±»
```python
def _cluster_items(items: List[dict], max_per_cluster: int = 2) -> List[dict]:
    """åŸºäºURLçš„ç²¾ç¡®èšç±» + æ ‡é¢˜ç›¸ä¼¼åº¦"""
    
    # Step 1: URLç²¾ç¡®åŒ¹é…
    url_clusters = defaultdict(list)
    for item in items:
        if item.get('url'):
            url_clusters[item['url']].append(item)
    
    # Step 2: æ ‡é¢˜Jaccardç›¸ä¼¼åº¦èšç±» (é˜ˆå€¼=0.6)
    # ä¸ºå­¤ç«‹é¡¹ç›®è¿›è¡Œæ ‡é¢˜ç›¸ä¼¼åº¦åŒ¹é…
```

#### ç›¸ä¼¼åº¦è®¡ç®—
- **Jaccardç›¸ä¼¼åº¦**: `|A âˆ© B| / |A âˆª B|`
- **ä¸­æ–‡åˆ†è¯**: jiebaåˆ†è¯å¤„ç†
- **é˜ˆå€¼è®¾å®š**: 0.6 (ç»éªŒå€¼ï¼Œå¹³è¡¡å¬å›å’Œç²¾åº¦)

### 2. å¤šæ ·æ€§ç­–ç•¥

#### é«˜å¤šæ ·æ€§ç­–ç•¥ (`diversity="high"`)
```python
def _apply_headlines_high_diversity(items: List[dict], limit: int) -> List[dict]:
    """
    ä»¿ç…§ä»Šæ—¥å¤´æ¡çš„å¤šæ ·æ€§ç­–ç•¥:
    1. æ¯ä¸ªé¢‘é“æœ€å¤š1æ¡ (å‰6æ¡)
    2. æ¯ä¸ªæ¥æºæœ€å¤š2æ¡
    3. ä¼˜å…ˆçº§: æƒé‡é«˜ > æ—¶æ•ˆæ€§ > çƒ­åº¦
    """
```

**åˆ†é…ç­–ç•¥**:
- å‰6æ¡: æ¯é¢‘é“æœ€å¤š1æ¡ï¼Œç¡®ä¿é¢‘é“å¤šæ ·æ€§
- åç»­æ¡ç›®: æ¯é¢‘é“æœ€å¤š2æ¡ï¼Œæ¯æ¥æºæœ€å¤š2æ¡
- é¢‘é“åˆ†å¸ƒæ—¥å¿—: `Headlines diversity: X channels, Y items`

#### è¯„åˆ†ç®—æ³•
```python
def _compute_headline_score(item: dict, hours: int) -> float:
    """
    ç»¼åˆè¯„åˆ† = æ—¶æ•ˆæ€§ç³»æ•° Ã— åŸºç¡€æƒé‡ Ã— çƒ­åº¦ç³»æ•°
    """
    # æ—¶æ•ˆæ€§è¡°å‡: 24å°æ—¶å†…çº¿æ€§è¡°å‡
    time_factor = max(0.1, 1 - age_hours / hours)
    
    # åŸºç¡€æƒé‡ (ç¼–è¾‘æ¨è/ç½®é¡¶)
    base_weight = 2.0 if item.get('is_featured') else 1.0
    
    # çƒ­åº¦ç³»æ•° (æµè§ˆé‡ã€è¯„è®ºæ•°)
    popularity_factor = math.log10(max(1, item.get('view_count', 0)) + 1)
    
    return time_factor * base_weight * (1 + popularity_factor * 0.1)
```

### 3. å»é‡ç­–ç•¥

#### è·¨æ¨¡å—å»é‡
- **Heroè½®æ’­** â†’ **å¤´æ¡æ–°é—»** â†’ **æ¨èæµ**: ä¼˜å…ˆçº§é€’å‡
- **åŸºäºcluster_slug**: é¿å…åŒç±»æ–°é—»åœ¨å¤šæ¨¡å—é‡å¤å‡ºç°  
- **å…è®¸å¤šæ¥æº**: æ¯ç°‡æœ€å¤šä¿ç•™2ä¸ªä¸åŒæ¥æº

## ğŸš€ æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥

#### å¤šå±‚ç¼“å­˜æ¶æ„
```
CDN (60s)
  â†“
Next.js API (SWR: 300s)  
  â†“
Django View (æ— ç¼“å­˜)
  â†“
Redisé¢„è®¡ç®— (60s)
  â†“  
OpenSearch (å®æ—¶)
```

#### ç¼“å­˜Keyè®¾è®¡
```python
# ç°ä»£åŒ–æ™ºèƒ½ç¼“å­˜ (v3)
cache_key = generate_cache_key(
    content_type, CacheLayer.BACKEND, site, params, user_id
)
# ç¤ºä¾‹: headlines:v3:hot:backend:aivoya.com:h24_dhigh_s9:default
```

#### CDNä¼˜åŒ–
```typescript
// Next.js APIå“åº”å¤´
headers: {
  'Cache-Control': 'public, s-maxage=60, stale-while-revalidate=300',
}
```

### æ€§èƒ½æŒ‡æ ‡

#### SLAç›®æ ‡
- **P95å“åº”æ—¶é—´**: < 400ms
- **é”™è¯¯ç‡**: < 0.5%
- **ç©ºåˆ—è¡¨ç‡**: < 1%
- **ç¼“å­˜å‘½ä¸­ç‡**: > 90%

#### ç›‘æ§æŒ‡æ ‡
- APIå“åº”æ—¶é—´åˆ†å¸ƒ
- ç¼“å­˜å‘½ä¸­/æœªå‘½ä¸­ç»Ÿè®¡
- å¤šæ ·æ€§åˆ†å¸ƒ (é¢‘é“è¦†ç›–åº¦)
- è·¨æ¨¡å—å»é‡æ•ˆæœ

## ğŸ”„ å®¹é”™æœºåˆ¶

### é™çº§ç­–ç•¥

```typescript
export async function getTopStories(limit: number = 9): Promise<TopStoryItem[]> {
  try {
    // 1. ä¼˜å…ˆ: Headlinesä¸“ä¸šAPI
    const response = await fetch(apiUrl, { next: { revalidate: 300 } });
    if (response.ok) return transformToTopStoryItem(data.items);
  } catch (error) {
    console.warn('Headlines API failed, falling back to mock data:', error);
  }
  
  // 2. å…œåº•: Mockæ•°æ®
  return generateMockTopStories(limit);
}
```

### é”™è¯¯å¤„ç†

#### APIå±‚é”™è¯¯å¤„ç†
```python
# Djangoè§†å›¾
try:
    # OpenSearchæŸ¥è¯¢
    candidates = search_articles(query, size=size*3)
except Exception:
    # DBå›é€€æŸ¥è¯¢
    candidates = Article.objects.filter(
        publish_at__gte=timezone.now() - timedelta(hours=hours)
    ).order_by('-publish_at')[:size*2]
```

#### å‰ç«¯é”™è¯¯å¤„ç†
```typescript
// ç»„ä»¶é”™è¯¯è¾¹ç•Œ
{topStories.length > 0 ? (
  <TopStoriesGrid items={topStories} />
) : (
  <TopStoriesLoadingSkeleton />
)}
```

## ğŸ“± ç”¨æˆ·ä½“éªŒ

### å“åº”å¼è®¾è®¡

#### æ–­ç‚¹é…ç½®
```css
/* ç§»åŠ¨ä¼˜å…ˆå“åº”å¼ */
.top-stories-grid {
  @apply grid grid-cols-1 gap-6;
  
  /* å¹³æ¿åŠä»¥ä¸Š: ä¸‰æ å¸ƒå±€ */
  @screen lg {
    @apply grid-cols-3;
  }
}

.main-news-section {
  @apply col-span-1;
  
  /* æ¡Œé¢ç«¯: å æ®å·¦ä¾§2æ  */  
  @screen lg {
    @apply col-span-2;
  }
}
```

#### äº¤äº’ä½“éªŒ
- **ä¸»æ–°é—»è½®æ’­**: 6ç§’è‡ªåŠ¨åˆ‡æ¢ï¼Œé¼ æ ‡æ‚¬åœæš‚åœ
- **åœ†ç‚¹æŒ‡ç¤ºå™¨**: æ˜¾ç¤ºå½“å‰ä½ç½®ï¼Œæ”¯æŒç‚¹å‡»è·³è½¬
- **åŠ è½½çŠ¶æ€**: Skeletonéª¨æ¶å±ï¼Œé¿å…å¸ƒå±€è·³åŠ¨
- **æ— éšœç¢æ”¯æŒ**: ARIAæ ‡ç­¾ï¼Œé”®ç›˜å¯¼èˆª

### ç§»åŠ¨ç«¯ä¼˜åŒ–

#### è§¦æ‘¸äº¤äº’
```typescript
// è½®æ’­ç»„ä»¶æ”¯æŒæ»‘åŠ¨æ‰‹åŠ¿
const [touchStart, setTouchStart] = useState(0);
const [touchEnd, setTouchEnd] = useState(0);

const handleTouchStart = (e: TouchEvent) => {
  setTouchStart(e.targetTouches[0].clientX);
};

const handleTouchMove = (e: TouchEvent) => {
  setTouchEnd(e.targetTouches[0].clientX);
};
```

#### æ€§èƒ½ä¼˜åŒ–
- å›¾ç‰‡æ‡’åŠ è½½: `loading="lazy"`
- WebPæ ¼å¼: Wagtailè‡ªåŠ¨æ¸²æŸ“
- å‹ç¼©ä¼˜åŒ–: ç§»åŠ¨ç«¯ä½¿ç”¨å°å°ºå¯¸å›¾ç‰‡

## ğŸ› ï¸ è¿ç»´ç®¡ç†

### ğŸ”¥ çƒ­åº¦ç³»ç»Ÿç®¡ç†å‘½ä»¤ (NEW)

#### æ‰‹åŠ¨æµ‹è¯•çƒ­åº¦ç®—æ³•
```bash
# æµ‹è¯•çƒ­åº¦ç®—æ³•
python manage.py update_hotness_tags --mode=test --site=aivoya.com

# æµ‹è¯•å•ç¯‡æ–‡ç« è¯¦ç»†åˆ†æ
python manage.py update_hotness_tags --mode=single --article-id=4154 --site=aivoya.com

# å¿«é€Ÿåˆ·æ–°çƒ­ç‚¹ï¼ˆæœ€è¿‘1å°æ—¶ï¼‰
python manage.py update_hotness_tags --mode=fast --site=aivoya.com

# å…¨é‡æ›´æ–°ï¼ˆæœ€è¿‘24å°æ—¶ï¼‰
python manage.py update_hotness_tags --mode=full --hours=24 --batch-size=100 --site=aivoya.com

# æ¸…ç†è¿‡æœŸçƒ­åº¦æ ‡è®°
python manage.py update_hotness_tags --mode=cleanup --site=aivoya.com
```

#### ç¤¾äº¤æ•°æ®åŒæ­¥
```bash
# æ‰‹åŠ¨åŒæ­¥ç¤¾äº¤æ•°æ®
python manage.py shell -c "
from apps.core.services.social_metrics_collector import collect_and_sync_all_recent_articles
collect_and_sync_all_recent_articles(hours_back=24, site='aivoya.com')
"
```

#### ç³»ç»ŸçŠ¶æ€æ£€æŸ¥
```bash
# éªŒè¯ClickHouseå­—æ®µå®Œæ•´æ€§
docker compose exec clickhouse clickhouse-client --query "DESCRIBE TABLE article_metrics_agg"

# æ£€æŸ¥çƒ­åº¦æ•°æ®
curl -s "http://localhost:8000/api/headlines/?size=3&site=aivoya.com" | jq '.items[] | {id, title, hotness_score, hotness_category}'
```

### ç›‘æ§å‘Šè­¦

#### Celeryä»»åŠ¡ç›‘æ§
```python
# ä»»åŠ¡æ‰§è¡Œæ—¥å¿—
@app.task(bind=True)
def compute_headlines(self, site, **kwargs):
    try:
        result = process_headlines(site, **kwargs)
        logger.info(f"Headlines computed: {result}")
        return result
    except Exception as exc:
        logger.error(f"Headlines compute failed: {exc}")
        raise self.retry(countdown=60, max_retries=3)
```

#### APIå¥åº·æ£€æŸ¥
```python
# apps/api/rest/monitoring.py
def health_check():
    """æ£€æŸ¥æ ¸å¿ƒç»„ä»¶å¥åº·çŠ¶æ€"""
    return {
        "headlines_api": test_headlines_api(),
        "cache_status": test_redis_cache(), 
        "search_status": test_opensearch(),
        "overall_health": "healthy|degraded|error"
    }
```

### ç¼“å­˜ç®¡ç†

#### ç¼“å­˜æ¸…ç†
```python
# Wagtailé’©å­: å†…å®¹å‘å¸ƒæ—¶æ¸…ç†ç›¸å…³ç¼“å­˜
@hooks.register('after_publish_page')
def clear_headlines_cache(request, page):
    if isinstance(page, ArticlePage):
        patterns = ['headlines_*', 'agg:headlines:*']
        for pattern in patterns:
            cache.delete_pattern(pattern)
```

#### é¢„çƒ­ç­–ç•¥
```bash
# å®šæ—¶é¢„çƒ­çƒ­é—¨ç¼“å­˜
*/5 * * * * cd /app && python manage.py shell -c "
from apps.api.tasks.aggregations import compute_headlines
compute_headlines.delay('aivoya.com', hours=24, diversity='high')
"
```

## ğŸ“ˆ æ•°æ®åˆ†æ

### åŸ‹ç‚¹ç»Ÿè®¡

#### å‰ç«¯åŸ‹ç‚¹
```typescript
// æ–°é—»ç‚¹å‡»åŸ‹ç‚¹
const handleNewsClick = (item: TopStoryItem, position: number) => {
  analytics.track('top_stories_click', {
    article_id: item.id,
    position: position,
    section: 'main_carousel', // æˆ– 'side_list'
    cluster_slug: item.cluster_slug,
    channel: item.channel?.slug,
  });
};
```

#### åç«¯æŒ‡æ ‡
```python
# APIæ€§èƒ½æŒ‡æ ‡
@api_view(['GET'])  
def headlines(request):
    start_time = time.time()
    
    # ... å¤„ç†é€»è¾‘ ...
    
    response_time = time.time() - start_time
    metrics.histogram('headlines.response_time', response_time)
    metrics.counter('headlines.requests_total').inc()
    
    return Response(data)
```

### A/Bæµ‹è¯•

#### å¤šæ ·æ€§ç­–ç•¥æµ‹è¯•
```python
# Feature Flagæ§åˆ¶
DIVERSITY_STRATEGY = {
    'control': 'med',    # å¯¹ç…§ç»„: ä¸­ç­‰å¤šæ ·æ€§
    'treatment': 'high', # å®éªŒç»„: é«˜å¤šæ ·æ€§  
}

def get_diversity_strategy(request):
    user_group = hash(request.session.session_key) % 100
    return 'high' if user_group < 50 else 'med'
```

#### å…³é”®æŒ‡æ ‡
- **CTR (ç‚¹å‡»ç‡)**: å¤´æ¡æ–°é—»ç‚¹å‡» / æ›å…‰
- **åœç•™æ—¶é—´**: ç”¨æˆ·åœ¨æ–°é—»é¡µé¢åœç•™æ—¶é•¿  
- **è·³å‡ºç‡**: ç‚¹å‡»å¤´æ¡åç«‹å³ç¦»å¼€çš„æ¯”ä¾‹
- **å¤šæ ·æ€§å¾—åˆ†**: é¢‘é“è¦†ç›–åº¦å’Œæ¥æºåˆ†æ•£åº¦

## ğŸ”® æœªæ¥è§„åˆ’

### ç®—æ³•ä¼˜åŒ–
- [x] **ğŸ”¥ å¤šç»´åº¦çƒ­åº¦è®¡ç®—**: åŸºäºç”¨æˆ·è¡Œä¸ºçš„æ™ºèƒ½è¯„åˆ†ç³»ç»Ÿ âœ… å·²å®Œæˆ
- [x] **ğŸ”¥ ç¤¾äº¤äº’åŠ¨åˆ†æ**: åˆ†äº«ã€è¯„è®ºã€ç‚¹èµã€æ”¶è—ç»¼åˆè¯„ä¼° âœ… å·²å®Œæˆ  
- [x] **ğŸ”¥ é˜…è¯»è´¨é‡è¯„ä¼°**: å®Œæˆç‡ã€è·³å‡ºç‡ã€åœç•™æ—¶é—´åˆ†æ âœ… å·²å®Œæˆ
- [x] **ğŸ”¥ æ™ºèƒ½åˆ†ç±»ç³»ç»Ÿ**: hot/trendingåŠ¨æ€æ ‡è®°æœºåˆ¶ âœ… å·²å®Œæˆ
- [ ] **ä¸ªæ€§åŒ–æ¨è**: åŸºäºç”¨æˆ·ç”»åƒçš„å†…å®¹åˆ†å‘
- [ ] **å®æ—¶çƒ­ç‚¹**: é›†æˆå¾®åšçƒ­æœã€ç™¾åº¦æŒ‡æ•°ç­‰å¤–éƒ¨æ•°æ®æº
- [ ] **æƒ…æ„Ÿåˆ†æ**: åŸºäºNLPçš„æ­£é¢/è´Ÿé¢æ–°é—»å¹³è¡¡
- [ ] **åœ°ç†å®šä½**: æ ¹æ®ç”¨æˆ·IPæ¨é€æœ¬åœ°æ–°é—»

### åŠŸèƒ½å¢å¼º  
- [ ] **è§†é¢‘å¤´æ¡**: æ”¯æŒè§†é¢‘æ–°é—»çš„è½®æ’­å±•ç¤º
- [ ] **ç›´æ’­å…¥å£**: é‡å¤§äº‹ä»¶æ—¶çš„ç›´æ’­æ¨æµæ¥å…¥
- [ ] **è¯„è®ºäº’åŠ¨**: å¤´æ¡æ–°é—»çš„è¯„è®ºå’Œè®¨è®ºåŠŸèƒ½  
- [ ] **åˆ†äº«ä¼ æ’­**: ç¤¾äº¤åª’ä½“åˆ†äº«å’Œä¼ æ’­é“¾è·¯è¿½è¸ª

### æŠ€æœ¯æ¼”è¿›
- [ ] **GraphQL**: æ›¿æ¢REST APIï¼Œæ”¯æŒå­—æ®µçº§ç¼“å­˜
- [ ] **CDN**: æ¥å…¥é˜¿é‡Œäº‘/è…¾è®¯äº‘CDNåŠ é€Ÿé™æ€èµ„æº
- [ ] **SSR**: æœåŠ¡ç«¯æ¸²æŸ“ä¼˜åŒ–SEOå’Œé¦–å±åŠ è½½
- [ ] **PWA**: ç¦»çº¿ç¼“å­˜å’Œæ¨é€é€šçŸ¥æ”¯æŒ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å…šæŠ¥å¤´æ¡æ•´ä½“è§„åˆ’](./æ–¹å‘æ„æ€.md)
- [æŠ€æœ¯æ¶æ„è¯„ä¼°](./0922è¯„ä¼°.md)
- [å‰ç«¯APIä½¿ç”¨æŒ‡å—](../TODO/002-Enhance/FRONTEND_API_USAGE.md)
- [æœç´¢ç³»ç»Ÿå»ºè®¾](../ç®—æ³•/0912ToDo.md)
- [å¸ƒå±€è®¾è®¡è§„èŒƒ](../TODO/Layout/001.md)

---

**æœ€åæ›´æ–°**: 2025å¹´9æœˆ22æ—¥ - ğŸ”¥ **é‡å¤§æ›´æ–°ï¼šå¤šç»´åº¦çƒ­åº¦è®¡ç®—ç³»ç»Ÿä¸Šçº¿**
**ç»´æŠ¤å›¢é˜Ÿ**: å‰ç«¯å¼€å‘ç»„ & åç«¯ç®—æ³•ç»„ & æ•°æ®å·¥ç¨‹ç»„
**è”ç³»æ–¹å¼**: æŠ€æœ¯ç¾¤æˆ–æäº¤Issueåˆ°é¡¹ç›®ä»“åº“

**ğŸ“ˆ ç‰ˆæœ¬è®°å½•**:
- **v2.0** (2025.09.22): å¤šç»´åº¦çƒ­åº¦è®¡ç®—ç³»ç»Ÿï¼ŒClickHouseæ•°æ®æ‰©å±•ï¼Œæ™ºèƒ½åˆ†ç±»ç®—æ³•
- **v1.0** (2025.09.01): åŸºç¡€å¤´æ¡æ–°é—»èšåˆï¼Œå¤šæ ·æ€§ç­–ç•¥ï¼Œå“åº”å¼å¸ƒå±€
