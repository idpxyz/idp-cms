# 首页轮播板块技术文档

## 📋 概述

首页轮播板块(Hero Carousel)是党报头条网站的重要视觉焦点，用于展示最重要的新闻内容。该组件采用响应式设计，支持多种高度模式和交互方式，确保在不同场景下都能提供最佳的用户体验。

## 🎯 设计理念

### 核心原则
- **内容为王**：只展示编辑精选的重要内容(`is_hero=True`)
- **优雅降级**：没有Hero内容时隐藏组件，避免空白展示
- **响应式设计**：适配桌面、平板、手机等不同设备
- **性能优先**：图片懒加载、缓存优化、交互流畅
- **无障碍支持**：键盘导航、ARIA标签、对比度规范

### 使用场景
- ✅ **重大新闻发布**：突发事件、政策发布、重要会议
- ✅ **专题内容推广**：深度报道、系列文章、特别策划  
- ✅ **活动直播预告**：重要会议、新闻发布会直播
- ❌ **日常新闻流**：普通新闻应使用TopStories板块

## 🏗️ 技术架构

### 整体架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   页面集成      │    │   Hero组件      │    │   数据获取      │
│                 │    │                 │    │                 │
│   page.tsx      │───▶│ HeroCarousel    │───▶│ getHeroItems()  │
│ (条件渲染)      │    │   (.tsx)        │    │   (.utils.ts)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                        │
                               ┌────────────────────────┼────────────────────────┐
                               │                        ▼                        │
                    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
                    │   API Routes    │    │   Django API    │    │   Wagtail CMS   │
                    │ /api/news?hero  │    │ /api/articles/  │    │   (is_hero)     │
                    │  (Next.js)      │    │   (Django)      │    │                 │
                    └─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 技术栈
- **前端组件**: React 18 + TypeScript + Next.js 14
- **样式框架**: Tailwind CSS + CSS Modules
- **图片优化**: Next.js Image组件 + WebP支持
- **状态管理**: React Hooks (useState, useEffect, useCallback)
- **交互增强**: 触摸滑动、键盘导航、自动播放控制

## 🔧 核心组件

### 1. 主组件 (HeroCarousel.tsx)

#### 接口设计
```typescript
export interface HeroItem {
  id: string;
  title: string;
  excerpt?: string;
  image_url?: string;
  publish_time?: string;
  author?: string;
  source?: string;
  channel?: { id: string; name: string; slug: string; };
  topic?: { id: string; name: string; slug: string; };
  slug: string;
  is_breaking?: boolean;    // 突发新闻
  is_live?: boolean;        // 直播内容
  is_event_mode?: boolean;  // 事件模式
  media_type?: 'image' | 'video' | 'data';
  tags?: string[];
}

export interface HeroCarouselProps {
  items: HeroItem[];
  // 高度模式配置
  heightMode?: 'compact' | 'standard' | 'takeover';
  hasRightRail?: boolean;
  maxHeightVh?: number;
  // 交互配置
  autoPlay?: boolean;
  autoPlayInterval?: number;
  showDots?: boolean;
  showArrows?: boolean;
  className?: string;
  onItemClick?: (item: HeroItem) => void;
}
```

#### 核心特性

**1. 智能高度模式**
```typescript
const getHeightMode = useCallback((): HeroHeightMode => {
  // 检查是否有事件模式的内容
  const hasEventContent = validItems.some(item => 
    item.is_event_mode || item.is_live
  );
  
  if (hasEventContent) {
    return 'takeover'; // 85-95svh
  }
  
  // 检查是否有重要内容
  const hasImportantContent = validItems.some(item => 
    item.is_breaking
  );
  
  if (hasImportantContent) {
    return 'standard'; // 48-60vh
  }
  
  return 'compact'; // 32-40vh
}, [validItems]);
```

**2. 自动播放控制**
```typescript
// 自动播放逻辑
useEffect(() => {
  if (!isPlaying || isPaused || totalItems <= 1) {
    if (intervalRef.current) {
      clearInterval(intervalRef.current);
      intervalRef.current = null;
    }
    return;
  }

  intervalRef.current = setInterval(() => {
    setCurrentIndex(prev => (prev + 1) % totalItems);
  }, autoPlayInterval);

  return () => {
    if (intervalRef.current) {
      clearInterval(intervalRef.current);
      intervalRef.current = null;
    }
  };
}, [isPlaying, isPaused, totalItems, autoPlayInterval]);
```

**3. 触摸滑动支持**
```typescript
const handleTouchStart = (e: React.TouchEvent) => {
  setTouchEnd(null);
  setTouchStart(e.targetTouches[0].clientX);
};

const handleTouchMove = (e: React.TouchEvent) => {
  setTouchEnd(e.targetTouches[0].clientX);
};

const handleTouchEnd = () => {
  if (!touchStart || !touchEnd) return;
  
  const distance = touchStart - touchEnd;
  const isLeftSwipe = distance > 50;
  const isRightSwipe = distance < -50;

  if (isLeftSwipe) {
    setCurrentIndex(prev => (prev + 1) % totalItems);
  } else if (isRightSwipe) {
    setCurrentIndex(prev => (prev - 1 + totalItems) % totalItems);
  }
};
```

### 2. 数据获取 (HeroCarousel.utils.ts)

#### 核心函数
```typescript
/**
 * 获取 Hero 轮播数据
 * 只使用专门标记为Hero的内容，没有数据时不显示Hero组件
 */
export async function getHeroItems(limit: number = 5): Promise<HeroItem[]> {
  try {
    // 🎬 获取专门标记为Hero的内容
    console.log('🎬 HeroCarousel: 尝试获取Hero专用内容...');
    const heroResponse = await getNews('hero', 1, limit);
    
    if (heroResponse.data && heroResponse.data.length > 0) {
      console.log(`🎬 获取到 ${heroResponse.data.length} 条Hero专用内容`);
      const heroItems = heroResponse.data
        .filter(item => item.cover?.url || item.image_url) // 确保有封面图
        .map(item => transformToHeroItem(item));
      
      console.log(`🎬 过滤后Hero内容: ${heroItems.length} 条`);
      return heroItems;
    }
  } catch (error) {
    console.warn('🚫 Failed to fetch hero-specific content:', error);
  }
  
  // 🚫 没有Hero数据时返回空数组，不显示Hero组件
  console.log('🚫 HeroCarousel: 没有Hero数据，不显示Hero组件');
  return [];
}
```

#### 数据转换
```typescript
function transformToHeroItem(item: any): HeroItem {
  return {
    id: item.id.toString(),
    title: item.title,
    excerpt: item.excerpt || item.summary || '',
    image_url: item.cover?.url || item.image_url,
    publish_time: item.publish_at || item.first_published_at || item.created_at,
    author: item.author_name || item.author || '',
    source: item.source_site?.name || item.external_site?.name || '本站',
    channel: item.channel ? {
      id: item.channel.slug || item.channel.id.toString(),
      name: item.channel.name,
      slug: item.channel.slug || item.channel.id.toString()
    } : undefined,
    slug: item.slug || `article-${item.id}`,
    is_breaking: item.is_featured || false,
    is_live: item.is_live || false,
    is_event_mode: item.is_event_mode || false,
    media_type: item.has_video ? 'video' : 'image',
    tags: item.tags || [],
  };
}
```

### 3. API集成

#### Next.js API路由 (`/api/news/route.ts`)
```typescript
// 特殊处理：Hero轮播数据
if (channel === "hero") {
  const heroUrl = endpoints.buildUrl(
    endpoints.getCmsEndpoint('/api/articles/'),
    {
      site: getMainSite().hostname,
      page,
      size: limit,
      is_hero: "true",
      order: "-weight,-publish_at",
      include: "cover,channel"
    }
  );

  const response = await fetch(heroUrl, endpoints.createFetchConfig({
    timeout: 5000,
    next: {
      revalidate: 30, // Hero内容缓存30秒，便于快速更新
      tags: [`hero:${getMainSite().hostname}`, "articles:hero"],
    },
  }));
```

**缓存策略**:
- **30秒短缓存**: 确保管理员编辑后快速生效
- **标签缓存**: 支持精确的缓存失效
- **容错处理**: API失败时优雅降级

## 🎨 高度模式详解

### 三种高度模式

| 模式 | 适用场景 | 桌面端高度 | 平板端 | 移动端 | 触发条件 |
|------|----------|------------|--------|--------|----------|
| **Compact** | 日常频道头条 + 右侧栏存在 | 32–40vh | 28–36vh | 36–44svh | 默认模式 |
| **Standard** | 重要头条，保持下方可见 | 48–60vh | 42–54vh | 45–55svh | `is_breaking=true` |
| **Takeover** | 直播/突发事件/数据大屏 | 85–95svh | 80–90svh | 80–90svh | `is_event_mode=true`或`is_live=true` |

### CSS实现
```css
/* Compact模式 */
.hero-compact {
  height: clamp(300px, 36vh, 420px);
}

/* Standard模式 */  
.hero-standard {
  height: clamp(420px, 56vh, 680px);
}

/* Takeover模式 */
.hero-takeover {
  height: clamp(600px, 90svh, calc(100svh - 80px));
}

/* 响应式断点 */
@media (max-width: 1023px) {
  .hero-compact { height: clamp(280px, 32vh, 380px); }
  .hero-standard { height: clamp(380px, 48vh, 560px); }
  .hero-takeover { height: clamp(500px, 85svh, calc(100svh - 60px)); }
}
```

### 高度决策逻辑
```typescript
// 1. 检查事件模式 → Takeover
if (item.is_event_mode || item.is_live) return 'takeover';

// 2. 检查突发新闻 → Standard  
if (item.is_breaking) return 'standard';

// 3. 默认 → Compact
return 'compact';
```

## 📱 响应式设计

### 断点配置
```typescript
const breakpoints = {
  mobile: '0px',
  tablet: '768px', 
  desktop: '1024px',
  wide: '1440px'
};
```

### 布局适配
```css
/* 移动端：单栏堆叠 */
.hero-carousel {
  @apply relative w-full;
}

/* 平板端：优化触摸交互 */
@media (min-width: 768px) {
  .hero-carousel {
    @apply touch-pan-x; /* 支持水平滑动 */
  }
}

/* 桌面端：鼠标悬停效果 */
@media (min-width: 1024px) {
  .hero-carousel:hover .hero-controls {
    @apply opacity-100;
  }
}
```

### 图片优化
```typescript
// Next.js Image组件配置
<Image
  src={item.image_url}
  alt={item.title}
  fill
  priority={index === 0} // 首张图片优先加载
  sizes="(max-width: 768px) 100vw, (max-width: 1200px) 66vw, 50vw"
  className="object-cover"
  onLoad={() => setImageLoaded(prev => ({ ...prev, [index]: true }))}
/>
```

## 🚀 性能优化

### 懒加载策略
```typescript
// 图片懒加载
const [imageLoaded, setImageLoaded] = useState<Record<number, boolean>>({});

// 只预加载当前和下一张图片
const shouldPreload = (index: number) => {
  return index === currentIndex || 
         index === (currentIndex + 1) % totalItems;
};
```

### 缓存策略
```typescript
// 1. Next.js API缓存 (30秒)
next: { revalidate: 30 }

// 2. 浏览器缓存
headers: {
  'Cache-Control': 'public, s-maxage=30, stale-while-revalidate=60'
}

// 3. 组件级缓存
const memoizedHeroItems = useMemo(() => 
  items.filter(item => item.image_url), 
  [items]
);
```

### 交互优化
```typescript
// 防抖处理
const debouncedNavigation = useCallback(
  debounce((direction: 'prev' | 'next') => {
    if (direction === 'next') {
      setCurrentIndex(prev => (prev + 1) % totalItems);
    } else {
      setCurrentIndex(prev => (prev - 1 + totalItems) % totalItems);
    }
  }, 100),
  [totalItems]
);
```

## 🛠️ 数据管理

### 内容创建 (Wagtail Admin)

#### 管理员操作
1. **进入文章编辑**: `http://localhost:8000/admin/pages/`
2. **创建新文章**: 选择 "Add ArticlePage"
3. **设置Hero标识**: 勾选 `is_hero` 字段
4. **上传封面图**: 必须提供高质量封面图 (建议16:9比例)
5. **设置权重**: `weight` 字段控制显示优先级
6. **发布内容**: 点击 "Publish" 使内容生效

#### 字段配置
```python
# ArticlePage模型中的Hero相关字段
class ArticlePage(Page):
    is_hero = models.BooleanField(default=False, verbose_name="是否为Hero轮播")
    weight = models.IntegerField(default=0, verbose_name="权重 (数字越大越靠前)")
    is_breaking = models.BooleanField(default=False, verbose_name="突发新闻")
    is_live = models.BooleanField(default=False, verbose_name="直播内容") 
    is_event_mode = models.BooleanField(default=False, verbose_name="事件模式")
    
    # 封面图 (Hero必需)
    cover = models.ForeignKey(
        'core.CustomImage',
        null=True, blank=True,
        on_delete=models.SET_NULL,
        verbose_name="封面图"
    )
```

### 批量导入工具

#### 管理命令使用
```bash
# 基础导入
python manage.py import_hero_data

# 指定站点
python manage.py import_hero_data --site=aivoya.com

# 清除现有数据后导入
python manage.py import_hero_data --replace

# 预览模式 (不实际创建数据)
python manage.py import_hero_data --dry-run
```

#### 导入流程
```python
# 1. 获取mock数据
hero_data = self.get_mock_hero_data()

# 2. 下载外部图片
image_path = self.download_image(item['image_url'])

# 3. 上传到MinIO并创建Wagtail图片记录
image_record = self.create_wagtail_image(image_path, item['title'])

# 4. 创建ArticlePage
article = ArticlePage(
    title=item['title'],
    slug=item['slug'],
    excerpt=item['excerpt'],
    is_hero=True,
    weight=item.get('weight', 50),
    cover=image_record,
    # ... 其他字段
)

# 5. 关联到站点并发布
article.save_revision().publish()
```

## 📊 监控指标

### 性能指标
- **组件渲染时间**: < 100ms
- **图片加载时间**: 首张图片 < 1.5s，其他图片 < 3s
- **交互响应时间**: 切换动画 < 300ms
- **内存占用**: 单个Hero组件 < 50MB

### 业务指标
- **展示率**: Hero组件显示成功率 > 98%
- **点击率**: Hero轮播的CTR指标
- **停留时间**: 用户在Hero区域的平均停留时间
- **滑动率**: 用户主动切换的比例

### 监控代码
```typescript
// 性能监控
const [performanceMetrics, setPerformanceMetrics] = useState({
  renderTime: 0,
  imageLoadTime: 0,
  interactionTime: 0
});

// 渲染时间监控
useEffect(() => {
  const startTime = performance.now();
  
  const observer = new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
      if (entry.name === 'hero-carousel-render') {
        setPerformanceMetrics(prev => ({
          ...prev,
          renderTime: entry.duration
        }));
      }
    }
  });
  
  observer.observe({ entryTypes: ['measure'] });
  
  return () => observer.disconnect();
}, []);

// 用户交互监控
const trackHeroInteraction = useCallback((action: string, item: HeroItem) => {
  analytics.track('hero_interaction', {
    action,
    item_id: item.id,
    item_title: item.title,
    position: currentIndex,
    total_items: totalItems,
    height_mode: actualHeightMode,
    timestamp: Date.now()
  });
}, [currentIndex, totalItems, actualHeightMode]);
```

## 🔧 故障排除

### 常见问题

#### 1. Hero组件不显示
**现象**: 页面正常加载，但Hero区域空白

**排查步骤**:
```bash
# 1. 检查后端API
curl "http://localhost:8000/api/articles/?is_hero=true&site=aivoya.com"

# 2. 检查前端API代理  
curl "http://localhost:3001/api/news?channel=hero"

# 3. 检查数据库
python manage.py shell
>>> from apps.news.models import ArticlePage
>>> ArticlePage.objects.filter(is_hero=True).count()
```

**解决方案**:
- 确保至少有一条 `is_hero=True` 的文章
- 检查文章是否已发布 (`live=True`)
- 验证文章有有效的封面图

#### 2. 图片加载失败
**现象**: Hero显示，但图片显示为占位符或报错

**排查步骤**:
```bash
# 检查MinIO服务
docker-compose ps minio

# 检查图片URL可访问性
curl -I "http://192.168.8.195:8000/api/media/proxy/path/to/image.jpg"

# 检查Wagtail图片记录
python manage.py shell
>>> from wagtail.images.models import Image
>>> Image.objects.filter(id=HERO_IMAGE_ID).first()
```

**解决方案**:
- 重启MinIO服务: `docker-compose restart minio`
- 重新上传图片到管理后台
- 检查图片路径和权限

#### 3. 自动播放异常
**现象**: 轮播卡住不动或跳转异常

**调试代码**:
```typescript
// 开启调试模式
const DEBUG = process.env.NODE_ENV === 'development';

useEffect(() => {
  if (DEBUG) {
    console.log('🎬 Hero Debug:', {
      currentIndex,
      totalItems,
      isPlaying,
      isPaused,
      autoPlayInterval
    });
  }
}, [currentIndex, isPlaying, isPaused]);
```

**解决方案**:
- 检查 `totalItems > 1`
- 验证 `autoPlayInterval` 是否为有效数值
- 确保没有JavaScript错误中断定时器

### 应急预案

#### Hero内容紧急下线
```python
# 批量取消Hero标识
python manage.py shell
>>> from apps.news.models import ArticlePage  
>>> ArticlePage.objects.filter(is_hero=True).update(is_hero=False)
>>> print("已紧急下线所有Hero内容")
```

#### 恢复默认内容
```bash
# 重新导入安全的测试内容
python manage.py import_hero_data --replace
```

## 🔮 未来发展

### 功能增强
- [ ] **视频Hero**: 支持视频背景的Hero轮播
- [ ] **实时直播**: 集成直播流的Hero展示
- [ ] **数据大屏**: 支持图表数据的可视化Hero
- [ ] **互动投票**: Hero区域的实时互动功能

### 技术升级
- [ ] **WebP/AVIF**: 下一代图片格式支持
- [ ] **预加载优化**: 智能预测用户行为
- [ ] **无障碍增强**: 更完善的屏幕阅读器支持
- [ ] **PWA集成**: 离线缓存Hero内容

### 运营工具
- [ ] **A/B测试**: Hero样式和布局的分组测试
- [ ] **热力图分析**: 用户在Hero区域的行为分析
- [ ] **自动调优**: 基于数据的最佳实践推荐
- [ ] **内容推荐**: AI辅助的Hero内容选择

## 📚 相关文档

- [头条新闻板块](./头条新闻板块.md) - TopStories组件技术文档
- [党报头条整体规划](./方向构思.md) - 系统整体设计思路
- [技术架构评估](./0922评估.md) - 当前系统技术能力分析
- [Hero设计规范](../article/hero.md) - Hero组件的设计原则和规范
- [布局设计指南](../TODO/Layout/001.md) - 页面布局的统一规范

---

**最后更新**: 2025年9月22日  
**维护团队**: 前端开发组 & 内容运营团队  
**联系方式**: 技术群或提交Issue到项目仓库

## 📋 快速检查清单

### 开发者检查清单
- [ ] Hero组件正常渲染和交互
- [ ] 三种高度模式工作正常  
- [ ] 图片加载和优化生效
- [ ] 触摸滑动和键盘导航可用
- [ ] 性能指标满足要求
- [ ] 错误处理和降级机制正常

### 编辑者检查清单
- [ ] 至少设置了1-5条Hero内容
- [ ] 每条Hero内容都有高质量封面图
- [ ] 权重设置合理，重要内容优先  
- [ ] 标题和摘要简洁有力
- [ ] 发布状态正确，内容已生效

### 运维检查清单
- [ ] MinIO服务运行正常
- [ ] 缓存命中率达标 (>80%)
- [ ] API响应时间达标 (<500ms)
- [ ] 错误率控制在合理范围 (<1%)
- [ ] 监控告警配置正确
