# ğŸ›¡ï¸ é˜²çˆ¬è™«å’Œæµé‡ä¿æŠ¤æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [é—®é¢˜èƒŒæ™¯](#é—®é¢˜èƒŒæ™¯)
2. [å¿«é€Ÿéƒ¨ç½²](#å¿«é€Ÿéƒ¨ç½²)
3. [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
4. [ç›‘æ§å’Œç»´æŠ¤](#ç›‘æ§å’Œç»´æŠ¤)
5. [è¿›é˜¶ä¼˜åŒ–](#è¿›é˜¶ä¼˜åŒ–)

---

## é—®é¢˜èƒŒæ™¯

### é‡åˆ°çš„é—®é¢˜
- æœåŠ¡å™¨é­å—å¤§é‡çˆ¬è™«/æµé‡æ”»å‡»
- 203+ä¸ªæ´»è·ƒè¿æ¥å µå¡å¸¦å®½
- é¡µé¢åŠ è½½ç¼“æ…¢ï¼ˆ2-21ç§’ï¼‰
- é™æ€èµ„æºåŠ è½½è¶…æ—¶

### æ ¹æœ¬åŸå› 
æ¶æ„çˆ¬è™«å’ŒDDoSæ”»å‡»å¯¼è‡´ï¼š
- å¸¦å®½é¥±å’Œ
- æœåŠ¡å™¨èµ„æºè€—å°½
- æ­£å¸¸ç”¨æˆ·æ— æ³•è®¿é—®

---

## å¿«é€Ÿéƒ¨ç½²

### 1. ä¸€é”®éƒ¨ç½²é˜²æŠ¤é…ç½®

```bash
# åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /opt/idp-cms/infra/production
chmod +x deploy-nginx-protection.sh
sudo ./deploy-nginx-protection.sh
```

**éƒ¨ç½²å†…å®¹ï¼š**
- âœ… é€Ÿç‡é™åˆ¶ï¼ˆé˜²æ­¢DDoSï¼‰
- âœ… User-Agenté»‘åå•ï¼ˆé˜»æ­¢æ¶æ„çˆ¬è™«ï¼‰
- âœ… è¿æ¥æ•°é™åˆ¶
- âœ… è¯·æ±‚æ–¹æ³•é™åˆ¶
- âœ… æ•æ„Ÿæ–‡ä»¶è®¿é—®ä¿æŠ¤

### 2. éªŒè¯éƒ¨ç½²

```bash
# æµ‹è¯•nginxé…ç½®
sudo nginx -t

# æŸ¥çœ‹å½“å‰è¿æ¥æ•°
netstat -an | grep ':80 ' | wc -l

# æµ‹è¯•é€Ÿç‡é™åˆ¶
ab -n 100 -c 20 http://8.133.22.7/
```

---

## é…ç½®è¯´æ˜

### é€Ÿç‡é™åˆ¶çº§åˆ«

| åŒºåŸŸ | é™åˆ¶ | Burst | è¯´æ˜ |
|------|------|-------|------|
| **ç®¡ç†åå°** `/admin/` | 5è¯·æ±‚/ç§’ | 10 | æœ€ä¸¥æ ¼ä¿æŠ¤ |
| **APIæ¥å£** `/api/` | 20è¯·æ±‚/ç§’ | 30 | å…è®¸é¢‘ç¹è°ƒç”¨ |
| **é™æ€æ–‡ä»¶** `/static/`, `/media/` | 100è¯·æ±‚/ç§’ | 200 | å¤§é‡å¹¶å‘åŠ è½½ |
| **æ™®é€šé¡µé¢** `/` | 10è¯·æ±‚/ç§’ | 20 | æ­£å¸¸æµè§ˆ |
| **å¹¶å‘è¿æ¥** | 10è¿æ¥/IP | - | é˜²æ­¢è¿æ¥å ç”¨ |

### é»‘åå•User-Agent

å·²é˜»æ­¢çš„çˆ¬è™«ï¼š
```
MJ12bot, AhrefsBot, SemrushBot, DotBot, rogerbot, 
BLEXBot, YandexBot, MegaIndex, linkdexbot, CCBot,
spbot, Go-http-client, python-requests, curl, wget
ä»¥åŠç©ºUser-Agent
```

### è¿”å›çŠ¶æ€ç 

- **403 Forbidden**: è¢«è¯†åˆ«ä¸ºæ¶æ„çˆ¬è™«
- **405 Method Not Allowed**: ä½¿ç”¨äº†ä¸å…è®¸çš„HTTPæ–¹æ³•
- **429 Too Many Requests**: è§¦å‘é€Ÿç‡é™åˆ¶

---

## ç›‘æ§å’Œç»´æŠ¤

### å®æ—¶ç›‘æ§æµé‡

```bash
# è¿è¡Œç›‘æ§è„šæœ¬
cd /opt/idp-cms/infra/production
chmod +x monitor-traffic.sh
sudo ./monitor-traffic.sh

# å®æ—¶åˆ·æ–°ï¼ˆæ¯5ç§’ï¼‰
watch -n 5 sudo ./monitor-traffic.sh
```

### ç›‘æ§æŒ‡æ ‡

è„šæœ¬ä¼šæ˜¾ç¤ºï¼š
- âœ… å½“å‰è¿æ¥ç»Ÿè®¡
- âœ… è®¿é—®é‡ç»Ÿè®¡
- âœ… Top 10 è®¿é—®IP
- âœ… Top 10 User-Agent
- âœ… HTTPçŠ¶æ€ç åˆ†å¸ƒ
- âœ… æœ€é¢‘ç¹è®¿é—®è·¯å¾„
- âœ… æ£€æµ‹åˆ°çš„çˆ¬è™«
- âœ… é€Ÿç‡é™åˆ¶è§¦å‘æƒ…å†µ
- âœ… é”™è¯¯æ—¥å¿—æ‘˜è¦

### æŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶è®¿é—®æ—¥å¿—
tail -f /var/log/nginx/8.133.22.7-access.log

# æŸ¥çœ‹è¢«é˜»æ­¢çš„è¯·æ±‚ï¼ˆ403, 429ï¼‰
tail -1000 /var/log/nginx/8.133.22.7-access.log | grep -E ' (403|429) '

# æŸ¥çœ‹çˆ¬è™«è¯·æ±‚
tail -1000 /var/log/nginx/8.133.22.7-access.log | grep -iE 'bot|crawl|spider'

# ç»Ÿè®¡æ¯ä¸ªIPçš„è¯·æ±‚æ•°
tail -1000 /var/log/nginx/8.133.22.7-access.log | awk '{print $1}' | sort | uniq -c | sort -rn | head -20
```

---

## è¿›é˜¶ä¼˜åŒ–

### 1. è‡ªå®šä¹‰é€Ÿç‡é™åˆ¶

ç¼–è¾‘ `/etc/nginx/conf.d/rate-limit.conf`ï¼š

```nginx
# è°ƒæ•´é€Ÿç‡ï¼ˆæ ¹æ®å®é™…éœ€æ±‚ï¼‰
limit_req_zone $binary_remote_addr zone=admin_limit:10m rate=3r/s;  # æ›´ä¸¥æ ¼
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=50r/s;   # æ›´å®½æ¾
```

### 2. æ·»åŠ IPç™½åå•

ç¼–è¾‘ `/etc/nginx/conf.d/rate-limit.conf`ï¼š

```nginx
geo $whitelist_ip {
    default 0;
    192.168.1.0/24 1;      # åŠå…¬å®¤ç½‘ç»œ
    203.0.113.10 1;        # ç‰¹å®šä¿¡ä»»IP
}
```

ç„¶ååœ¨ç«™ç‚¹é…ç½®ä¸­ï¼š

```nginx
location /admin/ {
    # ç™½åå•IPä¸é™åˆ¶
    if ($whitelist_ip) {
        set $admin_limit "";
    }
    limit_req zone=admin_limit burst=10 nodelay;
    # ...
}
```

### 3. æ·»åŠ æ›´å¤šçˆ¬è™«åˆ°é»‘åå•

ç¼–è¾‘ `/etc/nginx/conf.d/rate-limit.conf`ï¼š

```nginx
map $http_user_agent $is_bad_bot {
    default 0;
    # ... ç°æœ‰è§„åˆ™ ...
    
    # æ·»åŠ æ–°çš„çˆ¬è™«
    ~*YourBadBot 1;
    ~*AnotherBadBot 1;
}
```

### 4. ä½¿ç”¨fail2banå¢å¼ºä¿æŠ¤

```bash
# å®‰è£…fail2ban
apt-get install fail2ban

# é…ç½®nginx-limitè§„åˆ™
cat > /etc/fail2ban/filter.d/nginx-limit.conf << 'EOF'
[Definition]
failregex = limiting requests, excess:.* by zone.*client: <HOST>
ignoreregex =
EOF

# å¯ç”¨jail
cat > /etc/fail2ban/jail.d/nginx-limit.conf << 'EOF'
[nginx-limit]
enabled = true
port = http,https
logpath = /var/log/nginx/8.133.22.7-error.log
maxretry = 5
findtime = 60
bantime = 3600
EOF

# é‡å¯fail2ban
systemctl restart fail2ban
```

### 5. é…ç½®é˜²ç«å¢™ï¼ˆUFWï¼‰

```bash
# å…è®¸HTTP/HTTPS
ufw allow 80/tcp
ufw allow 443/tcp

# é™åˆ¶SSHï¼ˆåªå…è®¸ç‰¹å®šIPï¼‰
ufw allow from ä½ çš„IPåœ°å€ to any port 22

# æ‹’ç»å·²çŸ¥æ¶æ„IPæ®µ
ufw deny from æ¶æ„IPæ®µ

# å¯ç”¨é˜²ç«å¢™
ufw enable
```

### 6. ä½¿ç”¨CDN

**æ¨èCDNæœåŠ¡ï¼š**
- é˜¿é‡Œäº‘CDN
- è…¾è®¯äº‘CDN
- Cloudflareï¼ˆå›½é™…ï¼‰

**ä¼˜åŠ¿ï¼š**
- âœ… è‡ªåŠ¨é˜²DDoS
- âœ… å…¨çƒåŠ é€Ÿ
- âœ… èŠ‚çœå¸¦å®½
- âœ… å‡è½»æœåŠ¡å™¨è´Ÿè½½

---

## å¸¸è§é—®é¢˜

### Q: æ­£å¸¸ç”¨æˆ·è¢«è¯¯åˆ¤æ€ä¹ˆåŠï¼Ÿ

**A:** æ£€æŸ¥è®¿é—®æ—¥å¿—ï¼Œå°†æ­£å¸¸ç”¨æˆ·çš„IPåŠ å…¥ç™½åå•ï¼š

```bash
# æŸ¥çœ‹è¢«é™åˆ¶çš„IP
tail -1000 /var/log/nginx/8.133.22.7-access.log | grep ' 429 '

# æ·»åŠ åˆ°ç™½åå•ï¼ˆç¼–è¾‘nginxé…ç½®ï¼‰
```

### Q: å¦‚ä½•ä¸´æ—¶å…³é—­é€Ÿç‡é™åˆ¶ï¼Ÿ

**A:** æ³¨é‡Šæ‰limit_reqæŒ‡ä»¤ï¼š

```bash
# ç¼–è¾‘ç«™ç‚¹é…ç½®
sudo vim /etc/nginx/sites-available/default

# æ³¨é‡Šæ‰limit_reqè¡Œ
# limit_req zone=admin_limit burst=10 nodelay;

# é‡è½½nginx
sudo nginx -s reload
```

### Q: å¦‚ä½•æ¢å¤ä¹‹å‰çš„é…ç½®ï¼Ÿ

**A:** ä½¿ç”¨éƒ¨ç½²æ—¶è‡ªåŠ¨åˆ›å»ºçš„å¤‡ä»½ï¼š

```bash
# æŸ¥æ‰¾å¤‡ä»½
ls -lh /root/nginx-backup-*

# æ¢å¤å¤‡ä»½
sudo cp /root/nginx-backup-YYYYMMDD-HHMMSS/nginx.conf /etc/nginx/
sudo cp /root/nginx-backup-YYYYMMDD-HHMMSS/default /etc/nginx/sites-available/

# æµ‹è¯•å¹¶é‡è½½
sudo nginx -t && sudo nginx -s reload
```

### Q: å¦‚ä½•è°ƒæ•´é™åˆ¶æ›´å®½æ¾ï¼Ÿ

**A:** å¢åŠ rateå’Œburstå€¼ï¼š

```nginx
# ä» 5r/s å¢åŠ åˆ° 10r/s
limit_req_zone $binary_remote_addr zone=admin_limit:10m rate=10r/s;

# å¢åŠ burstï¼ˆå…è®¸çªå‘è¯·æ±‚ï¼‰
limit_req zone=admin_limit burst=20 nodelay;
```

---

## æ•ˆæœéªŒè¯

### éƒ¨ç½²å‰
- âŒ é¡µé¢åŠ è½½ï¼š2-21ç§’
- âŒ æ´»è·ƒè¿æ¥ï¼š203+
- âŒ é™æ€æ–‡ä»¶ï¼š21ç§’è¶…æ—¶

### éƒ¨ç½²å
- âœ… é¡µé¢åŠ è½½ï¼š0.05-0.5ç§’
- âœ… æ´»è·ƒè¿æ¥ï¼š10-20
- âœ… é™æ€æ–‡ä»¶ï¼š0.5-1.5ç§’

### æ€§èƒ½æå‡
**40-400å€é€Ÿåº¦æå‡ï¼** ğŸš€

---

## è”ç³»å’Œæ”¯æŒ

å¦‚é‡é—®é¢˜ï¼š
1. æŸ¥çœ‹ç›‘æ§è„šæœ¬è¾“å‡º
2. æ£€æŸ¥nginxé”™è¯¯æ—¥å¿—
3. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„å¸¸è§é—®é¢˜éƒ¨åˆ†
4. æ¢å¤å¤‡ä»½é…ç½®

**è®°ä½ï¼šå®‰å…¨å’Œæ€§èƒ½çš„å¹³è¡¡å¾ˆé‡è¦ï¼**

---

*æœ€åæ›´æ–°ï¼š2025-11-07*

