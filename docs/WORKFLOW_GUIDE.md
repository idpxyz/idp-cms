# 📋 Wagtail 工作流使用指南

## ✅ 当前配置状态（已验证）

### 🎯 工作流配置
- **工作流名称**: `Moderators approval`
- **状态**: ✅ 活跃
- **应用范围**: 所有页面类型（包括文章）
- **审批任务**: 组审批任务 (GroupApprovalTask)

### 👥 用户组权限配置

| 用户组 | 成员 | 发布权限 | 角色说明 |
|--------|------|----------|----------|
| **Editors** | (无成员) | ❌ 无 | 可以创建和编辑，需要审核 |
| **专题教育编辑** | houad | ❌ 无 | 可以创建和编辑，需要审核 |
| **Moderators** | chensiyan, leo5122 | ✅ 有 | 可以审批和发布文章 |

### 📊 权限明细

#### houad（专题教育编辑）
- ✅ 添加页面 (add_page)
- ✅ 修改页面 (change_page)
- ✅ 查看页面 (view_page)
- ❌ 发布页面 (publish_page) - **必须提交审核**
- ❌ 删除页面 (delete_page)

#### chensiyan / leo5122（Moderators）
- ✅ 添加页面 (add_page)
- ✅ 修改页面 (change_page)
- ✅ 查看页面 (view_page)
- ✅ **发布页面 (publish_page)** - **可以审批**
- ✅ 删除页面 (delete_page)
- ✅ 锁定页面 (lock_page)

---

## 🔄 工作流程图

```
┌─────────────────────────────────────────────────────────────┐
│  1️⃣  编辑创建文章 (houad)                                    │
│     - 填写标题、正文、封面                                    │
│     - 选择频道（教育健康 或 视频专题）                         │
│     - 添加标签、分类                                          │
└──────────────────┬──────────────────────────────────────────┘
                   ↓
┌─────────────────────────────────────────────────────────────┐
│  2️⃣  点击"提交审核"按钮                                       │
│     ⚠️  注意：不是"发布"按钮                                  │
│     ⚠️  如果看到"发布"按钮，说明权限配置有问题                 │
└──────────────────┬──────────────────────────────────────────┘
                   ↓
┌─────────────────────────────────────────────────────────────┐
│  3️⃣  进入工作流：Moderators approval                          │
│     状态：⏳ 待审核 (IN_PROGRESS)                             │
│     通知：Moderators 组成员会看到待审核提示                   │
└──────────────────┬──────────────────────────────────────────┘
                   ↓
┌─────────────────────────────────────────────────────────────┐
│  4️⃣  审核人审批 (chensiyan 或 leo5122)                        │
│     选项1: ✅ 批准 → 自动发布                                 │
│     选项2: ❌ 拒绝 → 返回编辑（可填写拒绝理由）                │
│     选项3: 💬 添加评论 → 给编辑留言但不做决定                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 📖 详细使用步骤

### 👤 编辑（houad）- 提交文章

#### 步骤 1: 创建文章
1. 登录后台：http://8.133.22.7:8000/admin/
2. 点击左侧菜单 **"页面"** → **"今日湖北"**
3. 点击右上角 **"添加子页面"** → 选择 **"文章页面"**

#### 步骤 2: 填写内容
1. **标题**：清晰准确，15-30字
2. **摘要**：50-100字
3. **封面图**：建议16:9比例
4. **正文**：使用富文本编辑器
5. **频道**：选择 **教育健康** 或 **视频专题**
6. **分类/标签**：添加相关标签

#### 步骤 3: 提交审核
1. 滚动到页面底部
2. 在右下角找到 **"提交审核"** 按钮
3. 点击 **"提交审核"**
4. 系统会显示确认对话框
5. 确认后，文章进入审核流程

#### 步骤 4: 等待审核
- 文章状态变为 **"⏳ 审核中"**
- 可以在 **"我的文章"** 菜单中查看审核状态
- 审核人审批后会收到通知

---

### 👔 审核人（chensiyan / leo5122）- 审批文章

#### 步骤 1: 查看待审核文章
**方法1：仪表盘查看**
1. 登录后台首页
2. 在仪表盘上会看到 **"待审核"** 提示框
3. 显示待审核文章数量
4. 点击进入审核列表

**方法2：页面菜单查看**
1. 点击左侧 **"页面"** 菜单
2. 找到标记为 **"⏳ 审核中"** 的文章
3. 点击文章标题进入

**方法3：工作流菜单**
1. 点击顶部导航栏 **"工作流"** 菜单
2. 查看 **"待处理的审核"**
3. 列表显示所有待审核页面

#### 步骤 2: 审阅文章内容
1. 仔细阅读文章标题、正文
2. 检查图片、格式、标签
3. 确认频道分类是否正确
4. 查看文章是否符合发布标准

#### 步骤 3: 做出审批决定
在文章编辑页面右侧，找到 **"工作流"** 面板：

**✅ 批准发布**
1. 点击 **"批准"** 按钮
2. （可选）填写审批意见
3. 确认后，文章自动发布
4. 状态变为 **"✅ 已发布"**

**❌ 拒绝修改**
1. 点击 **"拒绝"** 按钮
2. **必须**填写拒绝理由（告诉编辑需要修改什么）
3. 确认后，文章返回编辑
4. 状态变为 **"❌ 已拒绝"**
5. 编辑会收到通知和拒绝理由

**💬 添加评论（不做决定）**
1. 点击 **"添加评论"**
2. 填写建议或疑问
3. 编辑可以看到评论
4. 文章仍保持 **"⏳ 审核中"** 状态

---

## 🎯 常见场景

### 场景1: houad 创建文章需要审核
```
✅ 正常流程：
1. houad 登录 → 创建文章
2. 点击"提交审核"（不是"发布"）
3. 文章进入审核队列
4. chensiyan 或 leo5122 审批
5. 批准后文章发布
```

### 场景2: 文章需要修改
```
✅ 正常流程：
1. 审核人发现问题
2. 点击"拒绝"并填写原因："请修改标题，太长了"
3. houad 收到通知
4. houad 修改文章
5. 重新"提交审核"
6. 审核人再次审批
```

### 场景3: 紧急文章快速发布
```
✅ 应急方案：
1. chensiyan 或 leo5122 直接创建文章
2. 因为有发布权限，可以直接点击"发布"
3. 文章立即上线（绕过工作流）
```

### 场景4: 查看审核历史
```
✅ 查看方法：
1. 打开任何文章编辑页面
2. 在右侧找到"历史"标签
3. 可以看到所有审批记录：
   - 谁提交的审核
   - 谁审批的
   - 审批意见
   - 审批时间
```

---

## ⚠️ 注意事项

### ❗ 重要提醒

1. **houad 看到的按钮**
   - ✅ 应该看到：**"提交审核"** 按钮
   - ❌ 不应看到：**"发布"** 按钮
   - 如果看到"发布"按钮，说明权限配置有问题！

2. **审核人看到的按钮**
   - ✅ 对待审核文章：**"批准"** / **"拒绝"** / **"添加评论"**
   - ✅ 对自己创建的文章：**"发布"** 按钮（可直接发布）

3. **草稿 vs 提交审核**
   - **保存草稿**：文章保存但不进入审核
   - **提交审核**：正式提交给审核人
   - 草稿可以随时修改，提交审核后需要审批

4. **工作流状态**
   - ⏳ **审核中** (In Progress)：等待审批
   - ✅ **已批准** (Approved)：审批通过，已发布
   - ❌ **已拒绝** (Rejected)：需要修改
   - 📝 **草稿** (Draft)：未提交审核

---

## 🔧 故障排查

### 问题1: houad 看到"发布"按钮而不是"提交审核"
**原因**: houad 可能被误授予了发布权限

**解决方案**:
```bash
# 在服务器上执行
docker compose -f infra/production/docker-compose-ha-node1.yml exec authoring python manage.py shell

# 执行以下 Python 代码
from django.contrib.auth.models import Group, Permission
group = Group.objects.get(name='专题教育编辑')
publish_perm = Permission.objects.get(codename='publish_page')
group.permissions.remove(publish_perm)
print("✅ 已移除发布权限")
```

### 问题2: 审核人看不到待审核文章
**原因**: 可能是权限问题或工作流未激活

**检查步骤**:
1. 确认审核人属于 **Moderators** 组
2. 确认工作流状态为 **活跃**
3. 确认文章确实提交了审核（不是草稿）

### 问题3: 提交审核后没有进入工作流
**原因**: 工作流可能未正确应用

**解决方案**:
联系管理员检查工作流配置

---

## 📊 工作流统计

### 查看审核效率
可以通过以下方式查看工作流统计：

1. **仪表盘**
   - 待审核数量
   - 最近审批的文章

2. **工作流菜单**
   - 所有工作流任务
   - 审批历史
   - 当前待处理任务

3. **报表**（未来功能）
   - 平均审批时间
   - 各审核人审批量
   - 拒绝率统计

---

## 🎓 最佳实践

### 对于编辑（houad）
1. ✅ 提交前仔细检查内容
2. ✅ 填写完整的标题、摘要、标签
3. ✅ 选择正确的频道
4. ✅ 如果紧急，提交时备注说明
5. ❌ 不要反复提交和撤回
6. ❌ 不要在审核中时修改文章（会重置工作流）

### 对于审核人（chensiyan / leo5122）
1. ✅ 及时处理待审核文章
2. ✅ 拒绝时给出具体修改意见
3. ✅ 发现小问题可以直接修改后批准
4. ✅ 使用评论功能与编辑沟通
5. ❌ 不要长时间不处理审核请求
6. ❌ 拒绝时不要只说"不行"，要说明原因

---

## 📞 需要帮助？

如有问题，请联系系统管理员或查看：
- Wagtail 官方文档：https://docs.wagtail.org/
- 工作流文档：https://docs.wagtail.org/en/stable/advanced_topics/workflows.html

---

**文档生成时间**: 2024-11-07
**系统版本**: Wagtail CMS
**最后验证**: 2024-11-07 ✅ 所有配置正确

