# Channelä¸Categoryç»„ç»‡æ–¹æ¡ˆ

**ç‰ˆæœ¬**: 1.0  
**æ—¥æœŸ**: 2024-10-20  
**çŠ¶æ€**: å¾…ç¡®è®¤

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æ–‡æ¡£åŸºäºå¯¹æ–°è€æ•°æ®åº“çš„æ·±å…¥åˆ†æï¼Œæå‡ºäº†ä¸€ä¸ªç§‘å­¦çš„Channelï¼ˆé¢‘é“ï¼‰å’ŒCategoryï¼ˆåˆ†ç±»ï¼‰ç»„ç»‡æ–¹æ¡ˆï¼Œç”¨äºå°†æ—§ç³»ç»Ÿ476ä¸ªåˆ†ç±»çš„å†…å®¹è¿ç§»åˆ°æ–°çš„Wagtail CMSç³»ç»Ÿã€‚

### æ ¸å¿ƒé—®é¢˜
- æ—§ç³»ç»Ÿï¼š476ä¸ªå¤æ‚å±‚çº§åˆ†ç±»
- æ–°ç³»ç»Ÿï¼šä»…6ä¸ªç®€å•é¢‘é“
- æŒ‘æˆ˜ï¼šå¦‚ä½•åœ¨ä¸ä¸¢å¤±ä¿¡æ¯çš„å‰æä¸‹é‡æ–°ç»„ç»‡å†…å®¹ï¼Ÿ

### æ¨èæ–¹æ¡ˆ
**åŒç»´åº¦ç»“æ„** - ç”¨Channelè¡¨ç¤ºå†…å®¹ç±»å‹ï¼Œç”¨Categoryè¡¨ç¤ºåœ°ç†ä½ç½®

---

## ğŸ” æ•°æ®åˆ†æ

### æ—§ç³»ç»Ÿç»“æ„ (MySQL - 121.41.73.49)

```
æ•°æ®åº“: jrhb
æ€»åˆ†ç±»: 476ä¸ª
å±‚çº§: 2-3å±‚
é¡¶çº§åˆ†ç±»: 43ä¸ª

ä¸»è¦ç»´åº¦:
â”œâ”€ å†…å®¹ç»´åº¦ (30%): æ–°é—»ã€ç»æµã€æ–‡åŒ–ã€ä½“è‚²ã€ç§‘æŠ€ã€æ•™è‚²ç­‰
â””â”€ åœ°ç†ç»´åº¦ (70%): æ­¦æ±‰ã€é»„çŸ³ã€åå °ã€è†å·ã€å®œæ˜Œç­‰åœ°æ–¹ç«™
```

### æ–°ç³»ç»Ÿç°çŠ¶ (PostgreSQL - 121.40.167.71)

```
å½“å‰Channel: 6ä¸ª
â”œâ”€ æ°‘ç”Ÿ (foo)
â”œâ”€ ç¤¾ä¼š (society)  
â”œâ”€ ç§‘æŠ€ (tech)
â”œâ”€ è´¢ç» (finance)
â”œâ”€ ä½“è‚² (sports)
â””â”€ å¨±ä¹ (entertainment)

å½“å‰Category: 0ä¸ª
```

### å…³é”®å‘ç°

| ç»´åº¦ | åˆ†ç±»æ•° | å æ¯” | è¯´æ˜ |
|------|--------|------|------|
| åœ°ç†ç»´åº¦ | ~330 | 69% | å„åœ°å¸‚çš„åœ°æ–¹æ€§å†…å®¹ |
| å†…å®¹ç»´åº¦ | ~100 | 21% | æŒ‰ä¸»é¢˜åˆ†ç±»çš„å†…å®¹ |
| å…¶ä»– | ~46 | 10% | ä¸“é¢˜ã€æ´»åŠ¨ç­‰ |

**ç»“è®º**: æ—§ç³»ç»Ÿæœ¬è´¨ä¸Šæ˜¯**åœ°ç†ç»´åº¦ä¸ºä¸»**çš„ç»„ç»‡æ–¹å¼ï¼Œè€Œæ–°ç³»ç»Ÿè®¾è®¡æ˜¯**å†…å®¹ç»´åº¦ä¸ºä¸»**ã€‚

---

## ğŸ’¡ æ¨èæ–¹æ¡ˆï¼šåŒç»´åº¦ç»“æ„

### è®¾è®¡ç†å¿µ

```
ä¸€ç¯‡æ–‡ç«  = 1ä¸ªChannelï¼ˆå†…å®¹ç±»å‹ï¼‰ + Nä¸ªCategoryï¼ˆåœ°ç†/ä¸»é¢˜æ ‡ç­¾ï¼‰
```

**ç¤ºä¾‹**:
```
æ–‡ç« : "æ­¦æ±‰ä¸œæ¹–é«˜æ–°åŒºå‡ºå°äººæ‰æ–°æ”¿"
â”œâ”€ Channel: æ–°é—»èµ„è®¯ (å†…å®¹ç±»å‹)
â””â”€ Categories: [æ¹–åŒ— > æ­¦æ±‰]ï¼ˆåœ°ç†ä½ç½®ï¼‰
```

### Channel ç»“æ„ (8ä¸ªé¢‘é“)

| åºå· | åç§° | Slug | åŒ…å«å†…å®¹ | å¯¹åº”æ—§åˆ†ç±» |
|------|------|------|----------|-----------|
| 1 | æ–°é—»èµ„è®¯ | news | æ—¶æ”¿ã€ç¤¾ä¼šã€æ³•åˆ¶ã€å…šå»º | 1,2,3,5,6,12 |
| 2 | ç»æµè´¢ç» | finance | é‡‘èã€è¯åˆ¸ã€æˆ¿äº§ã€æŠ•èµ„ | 4,7,8,9,10,11,28 |
| 3 | æ–‡åŒ–å¨±ä¹ | culture | æ–‡åŒ–ã€è‰ºæœ¯ã€å¨±ä¹ã€ä¹¦ç”» | 18,19,20,21,22,24 |
| 4 | æ°‘ç”ŸæœåŠ¡ | livelihood | æ°‘ç”Ÿã€å¥åº·ã€åŒ»ç–—ã€ç¾é£Ÿ | 13,14,15,16,17,41 |
| 5 | ä½“è‚²è¿åŠ¨ | sports | ä½“è‚²ç›¸å…³ | 23 |
| 6 | ç§‘æŠ€æ•°ç  | tech | ç§‘æŠ€ã€äº’è”ç½‘ | 26 |
| 7 | æ•™è‚²åŸ¹è®­ | education | æ•™è‚²ç›¸å…³ | 27 |
| 8 | æ±½è½¦æ—…æ¸¸ | auto-travel | æ±½è½¦ã€æ—…æ¸¸ | 29,30 |

### Category ç»“æ„ (19ä¸ªåˆ†ç±»)

```
æ¹–åŒ— (hubei)
â”œâ”€ æ­¦æ±‰ (wuhan)          - çœä¼šï¼Œæ”¿æ²»ç»æµæ–‡åŒ–ä¸­å¿ƒ
â”œâ”€ è¥„é˜³ (xiangyang)      - å‰¯ä¸­å¿ƒåŸå¸‚
â”œâ”€ å®œæ˜Œ (yichang)        - å‰¯ä¸­å¿ƒåŸå¸‚ï¼Œä¸‰å³¡æ‰€åœ¨åœ°
â”œâ”€ è†å· (jingzhou)       - å†å²æ–‡åŒ–ååŸ
â”œâ”€ é»„çŸ³ (huangshi)       - å·¥ä¸šåŸå¸‚
â”œâ”€ åå ° (shiyan)         - æ±½è½¦åŸ
â”œâ”€ é»„å†ˆ (huanggang)      - æ•™è‚²å¤§å¸‚
â”œâ”€ è†é—¨ (jingmen)        - åœ°çº§å¸‚
â”œâ”€ é„‚å· (ezhou)          - åœ°çº§å¸‚
â”œâ”€ å­æ„Ÿ (xiaogan)        - åœ°çº§å¸‚
â”œâ”€ å’¸å® (xianning)       - åœ°çº§å¸‚
â”œâ”€ éšå· (suizhou)        - åœ°çº§å¸‚
â”œâ”€ æ©æ–½ (enshi)          - è‡ªæ²»å·
â”œâ”€ ä»™æ¡ƒ (xiantao)        - çœç›´ç®¡å¸‚
â”œâ”€ æ½œæ±Ÿ (qianjiang)      - çœç›´ç®¡å¸‚
â”œâ”€ å¤©é—¨ (tianmen)        - çœç›´ç®¡å¸‚
â””â”€ ç¥å†œæ¶ (shennongjia)  - æ—åŒº

å…¨å›½ (national)           - éåœ°æ–¹æ€§çš„å…¨å›½æ–°é—»
```

---

## ğŸ¯ æ–¹æ¡ˆä¼˜åŠ¿

### 1. ä¿¡æ¯ä¿ç•™å®Œæ•´
- âœ… å†…å®¹ç±»å‹ä¿¡æ¯ â†’ Channel
- âœ… åœ°ç†ä½ç½®ä¿¡æ¯ â†’ Category
- âœ… é›¶ä¿¡æ¯ä¸¢å¤±

### 2. çµæ´»ä¸”å¯æ‰©å±•
- âœ… ä¸€ç¯‡æ–‡ç« å¯ä»¥æœ‰å¤šä¸ªCategoryæ ‡ç­¾
- âœ… æ–°å¢åœ°åŒºåªéœ€æ·»åŠ Category
- âœ… æ–°å¢å†…å®¹ç±»å‹åªéœ€æ·»åŠ Channel

### 3. ç¬¦åˆWagtailè®¾è®¡
- âœ… Channelç”¨äºé¡µé¢è·¯ç”±å’Œå¯¼èˆª
- âœ… Categoryç”¨äºå†…å®¹ç­›é€‰å’Œæ ‡ç­¾
- âœ… ç¬¦åˆCMSæœ€ä½³å®è·µ

### 4. ç”¨æˆ·ä½“éªŒå‹å¥½
```
å‰ç«¯å¯¼èˆª:
é¦–é¡µ > ç»æµè´¢ç» > [æ­¦æ±‰] æ­¦æ±‰æ¥¼å¸‚æ–°æ”¿å‡ºå°
       â†‘           â†‘      â†‘
    Channel    Category  æ ‡é¢˜
```

---

## ğŸ“Š æ˜ å°„è§„åˆ™

### Channelæ˜ å°„

```python
# æ—§åˆ†ç±»ID -> æ–°Channel ID
CHANNEL_MAPPING = {
    # æ–°é—»èµ„è®¯
    1: 'news',    # æ–°é—»
    2: 'news',    # æ—¶æ”¿
    3: 'news',    # å…šå»º
    5: 'news',    # ç¤¾ä¼š
    6: 'news',    # æ³•åˆ¶
    12: 'news',   # èµ„è®¯
    
    # ç»æµè´¢ç»
    4: 'finance',   # é‡‘è
    7: 'finance',   # ç»æµ
    8: 'finance',   # è¯åˆ¸
    9: 'finance',   # ç†è´¢
    10: 'finance',  # å•†ä¼š
    11: 'finance',  # æŠ•èµ„
    28: 'finance',  # æˆ¿äº§
    
    # æ–‡åŒ–å¨±ä¹
    18: 'culture',  # æ–‡åŒ–
    21: 'culture',  # å¨±ä¹
    22: 'culture',  # è‰ºæœ¯
    20: 'culture',  # ä¹¦ç”»
    
    # æ°‘ç”ŸæœåŠ¡
    13: 'livelihood',  # æ°‘ç”Ÿ
    14: 'livelihood',  # å®¶å±…
    15: 'livelihood',  # å¥åº·
    17: 'livelihood',  # åŒ»ç–—
    41: 'livelihood',  # ç¾é£Ÿ
    
    # ä½“è‚²è¿åŠ¨
    23: 'sports',   # ä½“è‚²
    
    # ç§‘æŠ€æ•°ç 
    26: 'tech',     # ç§‘æŠ€
    
    # æ•™è‚²åŸ¹è®­
    27: 'education',  # æ•™è‚²
    
    # æ±½è½¦æ—…æ¸¸
    29: 'auto-travel',  # æ±½è½¦
    30: 'auto-travel',  # æ—…æ¸¸
}
```

### Categoryæ˜ å°„ï¼ˆåœ°ç†ï¼‰

```python
# æ—§åˆ†ç±»åç§°åŒ…å«å…³é”®è¯ -> Category
CATEGORY_MAPPING = {
    'æ­¦æ±‰': 'wuhan',
    'é»„çŸ³': 'huangshi',
    'åå °': 'shiyan',
    'è†å·': 'jingzhou',
    'å®œæ˜Œ': 'yichang',
    'è¥„é˜³': 'xiangyang',
    'é„‚å·': 'ezhou',
    'è†é—¨': 'jingmen',
    'é»„å†ˆ': 'huanggang',
    'å­æ„Ÿ': 'xiaogan',
    'å’¸å®': 'xianning',
    'éšå·': 'suizhou',
    'æ©æ–½': 'enshi',
    'ä»™æ¡ƒ': 'xiantao',
    'æ½œæ±Ÿ': 'qianjiang',
    'å¤©é—¨': 'tianmen',
    'ç¥å†œæ¶': 'shennongjia',
}
```

### æ™ºèƒ½æ˜ å°„é€»è¾‘

```python
def map_article(old_article):
    """æ˜ å°„æ—§æ–‡ç« åˆ°æ–°ç»“æ„"""
    
    # 1. æ ¹æ®åˆ†ç±»IDç¡®å®šChannel
    cate_id = old_article['cate_id']
    channel_slug = CHANNEL_MAPPING.get(cate_id, 'news')  # é»˜è®¤æ–°é—»
    
    # 2. æ ¹æ®åˆ†ç±»åç§°ç¡®å®šCategory
    cate_name = get_category_name(cate_id)
    categories = []
    
    for keyword, category_slug in CATEGORY_MAPPING.items():
        if keyword in cate_name:
            categories.append(category_slug)
            break
    
    # å¦‚æœæ²¡æœ‰åŒ¹é…åœ°ç†ä½ç½®ï¼Œé»˜è®¤ä¸ºå…¨å›½
    if not categories:
        categories = ['national']
    
    return {
        'channel': channel_slug,
        'categories': categories
    }
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### ç¬¬1æ­¥ï¼šåœ¨æ–°ç³»ç»Ÿåˆ›å»ºç»“æ„

```bash
# è¿è¡Œè‡ªåŠ¨åŒ–è„šæœ¬
docker compose -f infra/local/docker-compose.yml exec authoring \
  python manage.py shell < scripts/setup_channels_categories.py
```

**é¢„æœŸç»“æœ**:
- åˆ›å»º8ä¸ªChannel
- åˆ›å»º19ä¸ªCategoryï¼ˆå«å±‚çº§å…³ç³»ï¼‰

### ç¬¬2æ­¥ï¼šéªŒè¯ç»“æ„

```bash
# åœ¨Django shellä¸­éªŒè¯
docker compose -f infra/local/docker-compose.yml exec authoring python manage.py shell
```

```python
from apps.core.models import Channel, Category

# æŸ¥çœ‹Channel
for ch in Channel.objects.all().order_by('order'):
    print(f'{ch.order}. {ch.name} [{ch.slug}]')

# æŸ¥çœ‹Categoryæ ‘
for cat in Category.objects.filter(parent__isnull=True):
    print(f'\n{cat.name}')
    for child in cat.children.all().order_by('order'):
        print(f'  â””â”€ {child.name}')
```

### ç¬¬3æ­¥ï¼šæ›´æ–°æ˜ å°„é…ç½®

ç¼–è¾‘ `data/migration/category_mapping.json`ï¼Œæ·»åŠ æ–°çš„Channelå’ŒCategoryæ˜ å°„è§„åˆ™ã€‚

### ç¬¬4æ­¥ï¼šæµ‹è¯•å¯¼å…¥

```bash
# å¯¼å‡ºæµ‹è¯•æ•°æ®
./scripts/export_articles_from_mysql.sh --limit 100

# æµ‹è¯•å¯¼å…¥
docker compose -f infra/local/docker-compose.yml exec authoring \
  python manage.py import_old_articles --test --limit=10
```

### ç¬¬5æ­¥ï¼šéªŒè¯ç»“æœ

```python
from apps.news.models import ArticlePage
from django.db.models import Count

# æŒ‰Channelç»Ÿè®¡
ArticlePage.objects.values('channel__name').annotate(
    count=Count('id')
).order_by('-count')

# æŒ‰Categoryç»Ÿè®¡
ArticlePage.objects.filter(categories__isnull=False).values(
    'categories__name'
).annotate(count=Count('id')).order_by('-count')
```

### ç¬¬6æ­¥ï¼šæ­£å¼å¯¼å…¥

```bash
# å¯¼å‡ºå…¨éƒ¨æ•°æ®
./scripts/export_articles_from_mysql.sh

# æ­£å¼å¯¼å…¥
docker compose -f infra/local/docker-compose.yml exec authoring \
  python manage.py import_old_articles --batch-size=1000
```

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### æ•°æ®åˆ†å¸ƒé¢„æµ‹

åŸºäºæ—§ç³»ç»Ÿçš„åˆ†ç±»ç»Ÿè®¡ï¼š

| Channel | æ–‡ç« æ•° | å æ¯” |
|---------|--------|------|
| æ–°é—»èµ„è®¯ | ~65,000 | 36% |
| ç»æµè´¢ç» | ~45,000 | 25% |
| æ–‡åŒ–å¨±ä¹ | ~30,000 | 17% |
| æ°‘ç”ŸæœåŠ¡ | ~25,000 | 14% |
| æ±½è½¦æ—…æ¸¸ | ~8,000 | 4% |
| æ•™è‚²åŸ¹è®­ | ~3,000 | 2% |
| ä½“è‚²è¿åŠ¨ | ~1,500 | 1% |
| ç§‘æŠ€æ•°ç  | ~400 | <1% |

| Category | æ–‡ç« æ•° | å æ¯” |
|----------|--------|------|
| æ­¦æ±‰ | ~35,000 | 20% |
| å…¨å›½ | ~30,000 | 17% |
| è†å· | ~18,000 | 10% |
| å®œæ˜Œ | ~15,000 | 8% |
| å…¶ä»–åœ°å¸‚ | ~80,000 | 45% |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å†å²æ•°æ®å¤„ç†
- æ—§ç³»ç»Ÿæœ‰äº›åˆ†ç±»å·²åºŸå¼ƒä½†ä»æœ‰æ–‡ç« 
- å»ºè®®æ˜ å°„åˆ°å¯¹åº”Channelï¼Œä¸åˆ†é…Category

### 2. ä¸“é¢˜å†…å®¹
- æ—§ç³»ç»Ÿæœ‰å¤§é‡ä¸“é¢˜åˆ†ç±»
- å»ºè®®ä¿ç•™ä¸ºæ™®é€šæ–‡ç« ï¼Œé€šè¿‡æ ‡ç­¾(tags)å®ç°

### 3. é‡å¤æ˜ å°„
- æŸäº›æ–‡ç« å¯èƒ½åŒæ—¶å±äºå¤šä¸ªåœ°åŒº
- å¯¼å…¥æ—¶å¯ä»¥å…³è”å¤šä¸ªCategory

### 4. URLè¿ç§»
- éœ€è¦è®¾ç½®301é‡å®šå‘
- ä¿æŒSEOå‹å¥½

---

## ğŸ”„ æ›¿ä»£æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆBï¼šæ‰å¹³åŒ–ï¼ˆä¸æ¨èï¼‰

**ç»“æ„**: åªç”¨8ä¸ªChannelï¼Œä¸ç”¨Category

**ä¼˜ç‚¹**:
- ç®€å•
- å®æ–½å¿«

**ç¼ºç‚¹**:
- âŒ ä¸¢å¤±åœ°ç†ä¿¡æ¯
- âŒ æ— æ³•æŒ‰åœ°åŒºç­›é€‰
- âŒ ä¸åˆ©äºåœ°æ–¹ç«™è¿è¥

### æ–¹æ¡ˆCï¼šå…¨é‡è¿ç§»ï¼ˆä¸æ¨èï¼‰

**ç»“æ„**: åˆ›å»º476ä¸ªCategoryä¿ç•™åŸç»“æ„

**ä¼˜ç‚¹**:
- é›¶ä¿¡æ¯ä¸¢å¤±

**ç¼ºç‚¹**:
- âŒ è¿‡äºå¤æ‚
- âŒ ä¸ç¬¦åˆæ–°ç³»ç»Ÿè®¾è®¡
- âŒ ç”¨æˆ·ä½“éªŒå·®
- âŒ ç»´æŠ¤æˆæœ¬é«˜

---

## âœ… å†³ç­–å»ºè®®

**æ¨èé‡‡ç”¨æ–¹æ¡ˆAï¼ˆåŒç»´åº¦ç»“æ„ï¼‰**ï¼Œç†ç”±ï¼š

1. **ä¿¡æ¯å®Œæ•´æ€§**: ä¿ç•™äº†å†…å®¹ç±»å‹å’Œåœ°ç†ä¿¡æ¯
2. **ç³»ç»Ÿè®¾è®¡**: ç¬¦åˆWagtail CMSçš„è®¾è®¡ç†å¿µ
3. **ç”¨æˆ·ä½“éªŒ**: æ¸…æ™°çš„å¯¼èˆªå’Œç­›é€‰ä½“éªŒ
4. **å¯ç»´æŠ¤æ€§**: ç»“æ„æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•
5. **SEOå‹å¥½**: æ¸…æ™°çš„URLç»“æ„

**æŠ•å…¥æˆæœ¬**:
- å¼€å‘æ—¶é—´: 2-3å¤©
- æ•°æ®è¿ç§»: 1å¤©
- æµ‹è¯•éªŒè¯: 1å¤©
- **æ€»è®¡**: ~5å¤©

**é•¿æœŸæ”¶ç›Š**:
- âœ“ æ¸…æ™°çš„å†…å®¹ç»„ç»‡
- âœ“ çµæ´»çš„æ‰©å±•èƒ½åŠ›
- âœ“ è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ
- âœ“ ä¾¿äºè¿è¥ç»´æŠ¤

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ•°æ®è¿ç§»æ€»è§ˆ](./MIGRATION_README.md)
- [å¿«é€Ÿå¼€å§‹æŒ‡å—](./data_migration_quickstart.md)
- [å®Œæ•´è¿ç§»æ–¹æ¡ˆ](./data_migration_plan.md)
- [åˆ†ç±»æ˜ å°„æŒ‡å—](./category_mapping_guide.md)

---

## ğŸ“ åé¦ˆä¸è®¨è®º

å¦‚æœ‰ç–‘é—®æˆ–å»ºè®®ï¼Œè¯·ï¼š
1. æŸ¥çœ‹è¯¦ç»†åˆ†ææŠ¥å‘Š: `data/migration/database_analysis_report.json`
2. æ£€æŸ¥ç°æœ‰åˆ†ç±»: `data/migration/old_categories.txt`
3. å‚è€ƒæ–°ç³»ç»Ÿç»“æ„: `data/migration/new_structure.json`

---

**å®¡æ‰¹**: â–¡ å¾…ç¡®è®¤  
**æ‰§è¡Œ**: â–¡ å¾…å¼€å§‹  
**å®Œæˆ**: â–¡ æœªå®Œæˆ

