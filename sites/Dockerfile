# å¤šé˜¶æ®µæ„å»º Dockerfile - ä¼˜åŒ–ä¸­å›½ç½‘ç»œ
FROM node:20-alpine AS base

# ä½¿ç”¨ä¸­å›½é•œåƒæºåŠ é€Ÿ
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g' /etc/apk/repositories

# è®¾ç½®npmä¸­å›½é•œåƒ
RUN npm config set registry https://registry.npmmirror.com/

# å®‰è£…ä¾èµ–
WORKDIR /app
COPY package*.json ./
RUN npm install --only=production

# å¼€å‘é˜¶æ®µ
FROM base AS development

# åœ¨å®‰è£…ä¾èµ–å‰è®¾ç½® Puppeteer è·³è¿‡ä¸‹è½½ï¼Œé¿å…å®‰è£…é˜¶æ®µæ‹‰å– Chromium
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_SKIP_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser
ENV CHROME_PATH=/usr/bin/chromium-browser

# å®‰è£… Chromium ç”¨äº Lighthouse / Puppeteerï¼ˆè¿è¡Œæ—¶ä½¿ç”¨ç³»ç»ŸChromiumï¼‰
RUN apk add --no-cache chromium

# å®‰è£…å¼€å‘ä¾èµ–ï¼ˆæ­¤æ—¶å·²è·³è¿‡ Puppeteer çš„æµè§ˆå™¨ä¸‹è½½ï¼‰
RUN npm install

# å¤åˆ¶æºä»£ç 
COPY . .

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
CMD ["npm", "run", "dev"]

# ç”Ÿäº§é˜¶æ®µ
FROM base AS production

# è®¾ç½® Puppeteer è·³è¿‡ä¸‹è½½
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_SKIP_DOWNLOAD=true

# å…ˆå®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬ devDependenciesï¼‰ç”¨äºæ„å»º
RUN npm install

# å¤åˆ¶æºä»£ç 
COPY . .

# è®¾ç½®æ„å»ºæ—¶çš„ç¯å¢ƒå˜é‡ï¼ˆå¯ä»¥é€šè¿‡ --build-arg è¦†ç›–ï¼‰
ARG NEXT_PUBLIC_API_URL=http://localhost:8000
ARG NEXT_PUBLIC_SITE_URL=http://localhost:3000
ARG NEXT_PUBLIC_PORTAL_SITE=localhost
ARG NEXT_PUBLIC_CMS_URL=http://localhost:8000

ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_SITE_URL=$NEXT_PUBLIC_SITE_URL
ENV NEXT_PUBLIC_PORTAL_SITE=$NEXT_PUBLIC_PORTAL_SITE
ENV NEXT_PUBLIC_CMS_URL=$NEXT_PUBLIC_CMS_URL

# æ„å»ºåº”ç”¨
RUN npm run build

# ğŸš€ Standaloneæ¨¡å¼ï¼šå¤åˆ¶é™æ€æ–‡ä»¶åˆ°standaloneç›®å½•
# Next.js standaloneæ¨¡å¼éœ€è¦æ‰‹åŠ¨å¤åˆ¶publicå’Œ.next/static
RUN cp -r public .next/standalone/ && \
    cp -r .next/static .next/standalone/.next/

# æ¸…ç†å¼€å‘ä¾èµ–ï¼Œå‡å°æœ€ç»ˆé•œåƒå¤§å°
RUN npm prune --production

# æš´éœ²ç«¯å£
EXPOSE 3000

# ğŸš€ åˆ‡æ¢åˆ°standaloneç›®å½•å¹¶å¯åŠ¨
# Next.js standaloneæ¨¡å¼éœ€è¦åœ¨standaloneç›®å½•ä¸­è¿è¡Œ
WORKDIR /app/.next/standalone
CMD ["node", "server.js"]
