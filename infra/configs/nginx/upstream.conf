# Nginx 上游服务器配置（独立文件）
# 可以通过修改此文件动态调整服务器权重和状态

# 后端 API 服务器
upstream backend {
    least_conn;
    
    # 服务器1 - 主节点
    server SERVER1_IP:8000 weight=2 max_fails=3 fail_timeout=30s;
    
    # 服务器2 - 从节点（可设为 backup）
    server SERVER2_IP:8000 weight=1 max_fails=3 fail_timeout=30s;
    
    # 连接池
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# 前端应用服务器
upstream frontend {
    # 使用 ip_hash 保持会话
    ip_hash;
    
    server SERVER1_IP:3000 max_fails=3 fail_timeout=30s;
    server SERVER2_IP:3000 max_fails=3 fail_timeout=30s;
    
    keepalive 64;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

# MinIO 对象存储（可选，如果通过 Nginx 代理）
upstream minio {
    least_conn;
    
    server SERVER1_IP:9000 max_fails=3 fail_timeout=30s;
    server SERVER2_IP:9000 max_fails=3 fail_timeout=30s;
    
    keepalive 16;
}

# 负载均衡算法说明：
# - round_robin（默认）: 轮询
# - least_conn: 最少连接数
# - ip_hash: 基于客户端 IP 的哈希
# - hash $request_uri: 基于 URL 的哈希
# - random: 随机选择

# 服务器参数说明：
# - weight=N: 权重（默认1）
# - max_fails=N: 最大失败次数
# - fail_timeout=时间: 失败超时时间
# - backup: 备用服务器（仅当主服务器不可用时使用）
# - down: 标记服务器为下线状态

