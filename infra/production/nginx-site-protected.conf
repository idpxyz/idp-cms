###############################################################################
# Nginx ç«™ç‚¹é…ç½® - 8.133.22.7ï¼ˆå¸¦é˜²æŠ¤ï¼‰
# åŒ…å«é€Ÿç‡é™åˆ¶ã€é˜²çˆ¬è™«ã€DDoSé˜²æŠ¤
###############################################################################

server {
    # æ—§ç«™ç‚¹è·¯å¾„è¿”å›410
    location ~ ^/(post|cate|wap)/ {
        return 410;
    }
    listen 80;
    listen [::]:80;
    server_name 8.133.22.7 hubeitoday.com.cn www.hubeitoday.com.cn;
    include /etc/nginx/snippets/cache-news-exact.conf;
    include /etc/nginx/snippets/cache-news.conf;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    include /etc/nginx/snippets/robots.conf;
    include /etc/nginx/snippets/sitemap-redirect.conf;

    # æ—¥å¿—é…ç½®
    access_log /var/log/nginx/8.133.22.7-access.log;
    error_log /var/log/nginx/8.133.22.7-error.log;

    # å®¢æˆ·ç«¯é…ç½®
    client_max_body_size 100M;
    client_body_buffer_size 128k;
    client_header_buffer_size 4k;
    large_client_header_buffers 4 16k;

    # ğŸ›¡ï¸ å…¨å±€è¿æ¥é™åˆ¶ï¼šæ¯ä¸ªIPæœ€å¤š10ä¸ªå¹¶å‘è¿æ¥
    limit_conn conn_limit 10;

    # Django Admin - åç«¯ï¼ˆéœ€è¦æœ€ä¸¥æ ¼ä¿æŠ¤ï¼‰
    location /admin/ {
        # ğŸ›¡ï¸ ç®¡ç†åå°é€Ÿç‡é™åˆ¶ï¼šæ¯ç§’5ä¸ªè¯·æ±‚
        #limit_req zone=admin_limit burst=50 nodelay;
        
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Next.js åç«¯ä»£ç† APIï¼ˆå®¢æˆ·ç«¯é€šè¿‡æ­¤è·¯å¾„è®¿é—® Django APIï¼‰
    location ~ ^/api/backend/ {
        # ğŸ›¡ï¸ APIé€Ÿç‡é™åˆ¶ï¼šæ¯ç§’20ä¸ªè¯·æ±‚
        limit_req zone=api_limit burst=30 nodelay;
        
        proxy_pass http://172.28.1.40:3000;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # Next.js åª’ä½“ä»£ç† API
    location ~ ^/api/media-proxy/ {
        # ğŸ›¡ï¸ åª’ä½“ä»£ç†é€Ÿç‡é™åˆ¶ï¼šæ¯ç§’50ä¸ªè¯·æ±‚
        limit_req zone=static_limit burst=100 nodelay;
        
        proxy_pass http://172.28.1.40:3000;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Next.js API ç«¯ç‚¹ï¼ˆå¿…é¡»åœ¨é€šç”¨ /api/ ä¹‹å‰ï¼‰
    location ~ ^/api/(news|articles|channels|topics|feed|headlines|hot|search|analytics|health|ready|startup|tags|categories|site-settings|revalidate) {
        # ğŸ›¡ï¸ APIé€Ÿç‡é™åˆ¶ï¼šæ¯ç§’20ä¸ªè¯·æ±‚
        limit_req zone=api_limit burst=30 nodelay;
        
        proxy_pass http://172.28.1.40:3000;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Django API æ¥å£ï¼ˆå…¶ä½™æ‰€æœ‰ /api/ è¯·æ±‚ï¼‰
    location ~ ^/api/ {
        # ğŸ›¡ï¸ APIé€Ÿç‡é™åˆ¶ï¼šæ¯ç§’20ä¸ªè¯·æ±‚
        limit_req zone=api_limit burst=30 nodelay;
        
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # é™æ€æ–‡ä»¶ - åç«¯
    location /static/ {
        # ğŸ›¡ï¸ é™æ€æ–‡ä»¶é€Ÿç‡é™åˆ¶ï¼šæ¯ç§’100ä¸ªè¯·æ±‚
        limit_req zone=static_limit burst=200 nodelay;
        
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        
        # é™æ€æ–‡ä»¶ç¼“å­˜
        expires 30d;
        add_header Cache-Control "public, immutable";
        
        # å…è®¸CORSï¼ˆå¦‚æœéœ€è¦ï¼‰
        add_header Access-Control-Allow-Origin *;
    }

    # åª’ä½“æ–‡ä»¶ - åç«¯
    location /media/ {
        # ğŸ›¡ï¸ åª’ä½“æ–‡ä»¶é€Ÿç‡é™åˆ¶
        limit_req zone=static_limit burst=200 nodelay;
        
        proxy_pass http://localhost:8000;
        proxy_http_version 1.1;
        
        proxy_set_header Host $host;
        
        # åª’ä½“æ–‡ä»¶ç¼“å­˜
        expires 7d;
        add_header Cache-Control "public";
    }

    # Next.js é™æ€èµ„æº
    location /_next/static/ {
        # ğŸ›¡ï¸ Next.jsé™æ€èµ„æºé€Ÿç‡é™åˆ¶
        limit_req zone=static_limit burst=200 nodelay;
        
        proxy_pass http://172.28.1.40:3000;
        expires 30d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }

    # å¥åº·æ£€æŸ¥ï¼ˆä¸é™åˆ¶ï¼‰
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # é˜»æ­¢è®¿é—®æ•æ„Ÿæ–‡ä»¶
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ /\.git {
        deny all;
        access_log off;
        log_not_found off;
    }

    # é˜»æ­¢è®¿é—®å¤‡ä»½æ–‡ä»¶
    location ~ \.(bak|config|sql|fla|psd|ini|log|sh|inc|swp|dist)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # æ ¹è·¯å¾„ - å‰ç«¯ï¼ˆæ”¾åœ¨æœ€åï¼‰
    # æ ¹è·¯å¾„è‡ªåŠ¨è·³è½¬åˆ° /portal
    location = / {
        return 301 $scheme://$host/portal;
    }
 
    location / {
        # ğŸ›¡ï¸ å‰ç«¯é¡µé¢é€Ÿç‡é™åˆ¶ï¼šæ¯ç§’10ä¸ªè¯·æ±‚
        limit_req zone=general_limit burst=20 nodelay;
        
        proxy_pass http://172.28.1.40:3000;
        proxy_http_version 1.1;
        
        # åŸºç¡€ä»£ç†å¤´
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # WebSocket æ”¯æŒ
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¶…æ—¶é…ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # ç¼“å­˜é…ç½®
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
        proxy_busy_buffers_size 8k;
    }

    # é”™è¯¯é¡µé¢
    error_page 429 /429.html;
    location = /429.html {
        return 429 '{"error": "Too many requests. Please slow down."}';
        add_header Content-Type application/json;
    }
}

