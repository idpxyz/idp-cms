###############################################################################
# Nginx 速率限制和防爬虫配置
# 用途：防止DDoS攻击、恶意爬虫、流量攻击
###############################################################################

# 速率限制区域定义（放在http块中）
limit_req_zone $binary_remote_addr zone=general_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=20r/s;
limit_req_zone $binary_remote_addr zone=static_limit:10m rate=100r/s;
limit_req_zone $binary_remote_addr zone=admin_limit:10m rate=5r/s;

# 连接数限制
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# 爬虫User-Agent黑名单
map $http_user_agent $is_bad_bot {
    default 0;
    
    # 常见恶意爬虫
    ~*MJ12bot 1;
    ~*AhrefsBot 1;
    ~*SemrushBot 1;
    ~*DotBot 1;
    ~*rogerbot 1;
    ~*SeznamBot 1;
    ~*BLEXBot 1;
    ~*YandexBot 1;
    ~*MegaIndex 1;
    ~*linkdexbot 1;
    ~*ExaBot 1;
    ~*archive.org_bot 1;
    ~*BUbiNG 1;
    ~*Curious 1;
    ~*UnwindFetchor 1;
    ~*CCBot 1;
    ~*spbot 1;
    ~*ZoominfoBot 1;
    ~*Go-http-client 1;
    ~*python-requests 1;
    ~*curl 1;
    ~*wget 1;
    
    # 空User-Agent
    "" 1;
}

# IP白名单（可选，根据需要添加）
geo $whitelist_ip {
    default 0;
    # 127.0.0.1 1;  # 本地
    # 192.168.0.0/16 1;  # 内网
    # 添加你信任的IP段
}

# 限制请求方法
map $request_method $not_allowed_method {
    default 0;
    ~*(PUT|DELETE|TRACE|OPTIONS|CONNECT) 1;
}

