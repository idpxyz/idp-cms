# =============================================================================
# é«˜å¯ç”¨æ¨¡å¼ - åº”ç”¨èŠ‚ç‚¹1
# =============================================================================
# åŒ…å«æ— çŠ¶æ€åº”ç”¨æœåŠ¡ï¼Œè¿æ¥åˆ°å…±äº«åŸºç¡€è®¾æ–½
# 
# å‰ç½®æ¡ä»¶ï¼š
# 1. å…±äº«åŸºç¡€è®¾æ–½å·²å¯åŠ¨ (docker-compose-ha-infra.yml)
# 2. ç½‘ç»œ idp-ha-network å·²åˆ›å»º
# 3. ç¯å¢ƒå˜é‡å·²è®¾ç½® (.env.node1)
# 
# æœåŠ¡åˆ—è¡¨ï¼š
# - Django (authoring) - åç«¯APIæœåŠ¡
# - Next.js (frontend) - å‰ç«¯WebæœåŠ¡
# - Celery Worker - å¼‚æ­¥ä»»åŠ¡å¤„ç†
# - Celery Beat - å®šæ—¶ä»»åŠ¡è°ƒåº¦ (ä»…node1)
# 
# å¯åŠ¨å‘½ä»¤ï¼š
# docker-compose -f docker-compose-ha-node1.yml up -d
# =============================================================================

networks:
  ha-network:
    name: idp-ha-network
    external: true

services:
  # =========================================================================
  # Django/Wagtail åç«¯åº”ç”¨
  # =========================================================================
  authoring:
    build:
      context: ../../
      dockerfile: Dockerfile
      target: production
    container_name: node1-authoring
    hostname: authoring-node1
    env_file:
      - ../../.env.core
      - ../../.env.features
      - ../../.env.node1
    environment:
      # è¿æ¥åˆ°å…±äº«åŸºç¡€è®¾æ–½
      POSTGRES_HOST: 172.28.0.10
      REDIS_URL: redis://:${REDIS_PASSWORD:-devredis123}@172.28.0.20:6379/0
      CLICKHOUSE_URL: clickhouse://default:${CLICKHOUSE_PASSWORD:-thends}@172.28.0.30:9000/analytics
      OPENSEARCH_URL: http://172.28.0.40:9200  # ğŸ”’ HTTPï¼ˆå®‰å…¨æ’ä»¶ç¦ç”¨ï¼‰
      MINIO_ENDPOINT: http://172.28.0.50:9000
      
      # Djangoè®¾ç½®
      DJANGO_SETTINGS_MODULE: config.settings.prod
      NODE_NAME: node1
    volumes:
      - ../../:/app
      - ../../logs:/app/logs
      - django_static:/app/staticfiles
      - django_media:/app/media
    ports:
      - "8000:8000"
    networks:
      ha-network:
        ipv4_address: 172.28.1.30
    # æ³¨æ„ï¼šä¾èµ–çš„æœåŠ¡åœ¨ docker-compose-ha-infra.yml ä¸­
    # ç¡®ä¿åœ¨å¯åŠ¨æ­¤æ–‡ä»¶å‰ï¼Œinfra å·²ç»å¯åŠ¨
    command: sh -c "python manage.py migrate --noinput && python manage.py collectstatic --noinput && gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 4 --threads 2 --worker-class gthread --worker-tmp-dir /dev/shm --max-requests 1000 --max-requests-jitter 100 --timeout 120 --graceful-timeout 30 --keep-alive 5 --access-logfile /app/logs/gunicorn-access.log --error-logfile /app/logs/gunicorn-error.log --log-level info"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/readiness/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    labels:
      - "app=idp-cms"
      - "role=backend"
      - "node=1"

  # =========================================================================
  # Celery Worker
  # =========================================================================
  celery:
    build:
      context: ../../
      dockerfile: Dockerfile
      target: production
    container_name: node1-celery
    hostname: celery-node1
    env_file:
      - ../../.env.core
      - ../../.env.features
      - ../../.env.node1
    environment:
      # è¿æ¥åˆ°å…±äº«åŸºç¡€è®¾æ–½
      POSTGRES_HOST: 172.28.0.10
      REDIS_URL: redis://:${REDIS_PASSWORD:-devredis123}@172.28.0.20:6379/0
      CLICKHOUSE_URL: clickhouse://default:${CLICKHOUSE_PASSWORD:-thends}@172.28.0.30:9000/analytics
      OPENSEARCH_URL: http://172.28.0.40:9200  # ğŸ”’ HTTPï¼ˆå®‰å…¨æ’ä»¶ç¦ç”¨ï¼‰
      MINIO_ENDPOINT: http://172.28.0.50:9000
      
      DJANGO_SETTINGS_MODULE: config.settings.prod
      NODE_NAME: node1
    volumes:
      - ../../:/app
      - ../../logs:/app/logs
    networks:
      - ha-network
    depends_on:
      - authoring
    command: celery -A config worker -l info -c 4 --max-tasks-per-child=1000
    restart: unless-stopped
    labels:
      - "app=idp-cms"
      - "role=worker"
      - "node=1"

  # =========================================================================
  # Celery Beat (å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨)
  # æ³¨æ„: ä»…åœ¨ä¸€ä¸ªèŠ‚ç‚¹è¿è¡Œ
  # =========================================================================
  celery-beat:
    build:
      context: ../../
      dockerfile: Dockerfile
      target: production
    container_name: node1-celery-beat
    hostname: celery-beat-node1
    env_file:
      - ../../.env.core
      - ../../.env.features
      - ../../.env.node1
    environment:
      # è¿æ¥åˆ°å…±äº«åŸºç¡€è®¾æ–½
      POSTGRES_HOST: 172.28.0.10
      REDIS_URL: redis://:${REDIS_PASSWORD:-devredis123}@172.28.0.20:6379/0
      CLICKHOUSE_URL: clickhouse://default:${CLICKHOUSE_PASSWORD:-thends}@172.28.0.30:9000/analytics
      OPENSEARCH_URL: http://172.28.0.40:9200  # ğŸ”’ HTTPï¼ˆå®‰å…¨æ’ä»¶ç¦ç”¨ï¼‰
      MINIO_ENDPOINT: http://172.28.0.50:9000
      
      DJANGO_SETTINGS_MODULE: config.settings.prod
      NODE_NAME: node1
    volumes:
      - ../../:/app
      - ../../logs:/app/logs
    networks:
      - ha-network
    depends_on:
      - authoring
    command: python manage.py run_celery_beat
    restart: unless-stopped
    labels:
      - "app=idp-cms"
      - "role=scheduler"
      - "node=1"

  # =========================================================================
  # Next.js å‰ç«¯åº”ç”¨
  # =========================================================================
  frontend:
    build:
      context: ../../sites
      dockerfile: Dockerfile
      target: production
    container_name: node1-frontend
    hostname: frontend-node1
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${BACKEND_PUBLIC_URL:-http://121.40.167.71:8000}
      - NEXT_PUBLIC_SITE_URL=${FRONTEND_PUBLIC_URL:-https://yourdomain.com}
      - DJANGO_API_URL=http://172.28.1.30:8000
      - NODE_NAME=node1
    ports:
      - "3000:3000"
    networks:
      ha-network:
        ipv4_address: 172.28.1.40
    depends_on:
      authoring:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped
    labels:
      - "app=idp-cms"
      - "role=frontend"
      - "node=1"

volumes:
  django_static:
    name: node1-django-static
  django_media:
    name: node1-django-media
